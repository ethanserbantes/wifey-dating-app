{"dependencies":[{"name":"@babel/runtime/helpers/asyncToGenerator","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"YisBBiy2Xm9DEVdFebZ2nbgAHBo=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  exports.moderatePhoto = moderatePhoto;\n  exports.isDecisionAllowed = isDecisionAllowed;\n  var _babelRuntimeHelpersAsyncToGenerator = require(_dependencyMap[0]);\n  var _asyncToGenerator = _interopDefault(_babelRuntimeHelpersAsyncToGenerator);\n  function moderatePhoto(_x) {\n    return _moderatePhoto.apply(this, arguments);\n  }\n  function _moderatePhoto() {\n    _moderatePhoto = (0, _asyncToGenerator.default)(function* (_ref) {\n      var userId = _ref.userId,\n        imageUrl = _ref.imageUrl,\n        purpose = _ref.purpose;\n      var url = typeof imageUrl === \"string\" ? imageUrl.trim() : \"\";\n      if (!url) {\n        return {\n          ok: false,\n          error: \"Missing image url\"\n        };\n      }\n      try {\n        var baseURL = \"http://192.168.1.78:3001\";\n        var endpoint = `${baseURL}/api/moderation/photo`;\n        var resp = yield fetch(endpoint, {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\"\n          },\n          body: JSON.stringify({\n            userId: Number.isFinite(Number(userId)) ? Number(userId) : null,\n            imageUrl: url,\n            purpose: purpose ? String(purpose) : null\n          })\n        });\n        if (!resp.ok) {\n          var extra = \"\";\n          try {\n            var j = yield resp.json();\n            if (j?.error) extra = String(j.error);\n          } catch {\n            // ignore\n          }\n          throw new Error(extra || `When calling /api/moderation/photo, the response was [${resp.status}] ${resp.statusText}`);\n        }\n        var json = yield resp.json();\n        return {\n          ok: true,\n          decision: json?.decision || null,\n          safeSearch: json?.safeSearch || null,\n          moderationSkipped: !!json?.moderationSkipped\n        };\n      } catch (e) {\n        console.error(\"[MODERATION] moderatePhoto error\", e);\n        return {\n          ok: false,\n          error: e?.message || \"Moderation failed\"\n        };\n      }\n    });\n    return _moderatePhoto.apply(this, arguments);\n  }\n  function isDecisionAllowed(decision) {\n    var moderationSkipped = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n    var purpose = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : null;\n    // If the server had to skip moderation (Vision API disabled / misconfigured),\n    // don't block the user during signup/profile edits.\n    if (moderationSkipped) {\n      return true;\n    }\n    var d = String(decision || \"\").toLowerCase();\n    var p = String(purpose || \"\").toLowerCase();\n\n    // By default we only allow \"approve\".\n    // BUT: SafeSearch false positives happen a lot for normal selfies/swimsuit/fashion.\n    // For our two user-facing flows, we allow \"review\" (it still gets recorded server-side).\n    var allowReview = p === \"profile_photo\" || p === \"verification_photo\";\n    if (d === \"approve\") {\n      return true;\n    }\n    if (allowReview && d === \"review\") {\n      return true;\n    }\n    return false;\n  }\n});","lineCount":95,"map":[[12,2,1,0,"exports"],[12,9,1,0],[12,10,1,0,"moderatePhoto"],[12,23,1,0],[12,26,1,0,"moderatePhoto"],[12,39,1,0],[13,2,49,0,"exports"],[13,9,49,0],[13,10,49,0,"isDecisionAllowed"],[13,27,49,0],[13,30,49,0,"isDecisionAllowed"],[13,47,49,0],[14,2,77,1],[14,6,77,1,"_babelRuntimeHelpersAsyncToGenerator"],[14,42,77,1],[14,45,77,1,"require"],[14,52,77,1],[14,53,77,1,"_dependencyMap"],[14,67,77,1],[15,2,77,1],[15,6,77,1,"_asyncToGenerator"],[15,23,77,1],[15,26,77,1,"_interopDefault"],[15,41,77,1],[15,42,77,1,"_babelRuntimeHelpersAsyncToGenerator"],[15,78,77,1],[16,2,77,1],[16,11,1,22,"moderatePhoto"],[16,24,1,35,"moderatePhoto"],[16,25,1,35,"_x"],[16,27,1,35],[17,4,1,35],[17,11,1,35,"_moderatePhoto"],[17,25,1,35],[17,26,1,35,"apply"],[17,31,1,35],[17,38,1,35,"arguments"],[17,47,1,35],[18,2,1,35],[19,2,1,35],[19,11,1,35,"_moderatePhoto"],[19,26,1,35],[20,4,1,35,"_moderatePhoto"],[20,18,1,35],[20,25,1,35,"_asyncToGenerator"],[20,42,1,35],[20,43,1,35,"default"],[20,50,1,35],[20,52,1,7],[20,63,1,7,"_ref"],[20,67,1,7],[20,69,1,67],[21,6,1,67],[21,10,1,38,"userId"],[21,16,1,44],[21,19,1,44,"_ref"],[21,23,1,44],[21,24,1,38,"userId"],[21,30,1,44],[22,8,1,46,"imageUrl"],[22,16,1,54],[22,19,1,54,"_ref"],[22,23,1,54],[22,24,1,46,"imageUrl"],[22,32,1,54],[23,8,1,56,"purpose"],[23,15,1,63],[23,18,1,63,"_ref"],[23,22,1,63],[23,23,1,56,"purpose"],[23,30,1,63],[24,6,2,2],[24,10,2,8,"url"],[24,13,2,11],[24,16,2,14],[24,23,2,21,"imageUrl"],[24,31,2,29],[24,36,2,34],[24,44,2,42],[24,47,2,45,"imageUrl"],[24,55,2,53],[24,56,2,54,"trim"],[24,60,2,58],[24,61,2,59],[24,62,2,60],[24,65,2,63],[24,67,2,65],[25,6,3,2],[25,10,3,6],[25,11,3,7,"url"],[25,14,3,10],[25,16,3,12],[26,8,4,4],[26,15,4,11],[27,10,4,13,"ok"],[27,12,4,15],[27,14,4,17],[27,19,4,22],[28,10,4,24,"error"],[28,15,4,29],[28,17,4,31],[29,8,4,51],[29,9,4,52],[30,6,5,2],[31,6,7,2],[31,10,7,6],[32,8,8,4],[32,12,8,10,"baseURL"],[32,19,8,17],[32,48,8,58],[33,8,9,4],[33,12,9,10,"endpoint"],[33,20,9,18],[33,23,9,31],[33,26,9,34,"baseURL"],[33,33,9,41],[33,56,9,90],[34,8,11,4],[34,12,11,10,"resp"],[34,16,11,14],[34,25,11,23,"fetch"],[34,30,11,28],[34,31,11,29,"endpoint"],[34,39,11,37],[34,41,11,39],[35,10,12,6,"method"],[35,16,12,12],[35,18,12,14],[35,24,12,20],[36,10,13,6,"headers"],[36,17,13,13],[36,19,13,15],[37,12,13,17],[37,26,13,31],[37,28,13,33],[38,10,13,52],[38,11,13,53],[39,10,14,6,"body"],[39,14,14,10],[39,16,14,12,"JSON"],[39,20,14,16],[39,21,14,17,"stringify"],[39,30,14,26],[39,31,14,27],[40,12,15,8,"userId"],[40,18,15,14],[40,20,15,16,"Number"],[40,26,15,22],[40,27,15,23,"isFinite"],[40,35,15,31],[40,36,15,32,"Number"],[40,42,15,38],[40,43,15,39,"userId"],[40,49,15,45],[40,50,15,46],[40,51,15,47],[40,54,15,50,"Number"],[40,60,15,56],[40,61,15,57,"userId"],[40,67,15,63],[40,68,15,64],[40,71,15,67],[40,75,15,71],[41,12,16,8,"imageUrl"],[41,20,16,16],[41,22,16,18,"url"],[41,25,16,21],[42,12,17,8,"purpose"],[42,19,17,15],[42,21,17,17,"purpose"],[42,28,17,24],[42,31,17,27,"String"],[42,37,17,33],[42,38,17,34,"purpose"],[42,45,17,41],[42,46,17,42],[42,49,17,45],[43,10,18,6],[43,11,18,7],[44,8,19,4],[44,9,19,5],[44,10,19,6],[45,8,21,4],[45,12,21,8],[45,13,21,9,"resp"],[45,17,21,13],[45,18,21,14,"ok"],[45,20,21,16],[45,22,21,18],[46,10,22,6],[46,14,22,10,"extra"],[46,19,22,15],[46,22,22,18],[46,24,22,20],[47,10,23,6],[47,14,23,10],[48,12,24,8],[48,16,24,14,"j"],[48,17,24,15],[48,26,24,24,"resp"],[48,30,24,28],[48,31,24,29,"json"],[48,35,24,33],[48,36,24,34],[48,37,24,35],[49,12,25,8],[49,16,25,12,"j"],[49,17,25,13],[49,19,25,15,"error"],[49,24,25,20],[49,26,25,22,"extra"],[49,31,25,27],[49,34,25,30,"String"],[49,40,25,36],[49,41,25,37,"j"],[49,42,25,38],[49,43,25,39,"error"],[49,48,25,44],[49,49,25,45],[50,10,26,6],[50,11,26,7],[50,12,26,8],[50,18,26,14],[51,12,27,8],[52,10,27,8],[53,10,30,6],[53,16,30,12],[53,20,30,16,"Error"],[53,25,30,21],[53,26,31,8,"extra"],[53,31,31,13],[53,35,32,10],[53,92,32,67,"resp"],[53,96,32,71],[53,97,32,72,"status"],[53,103,32,78],[53,108,32,83,"resp"],[53,112,32,87],[53,113,32,88,"statusText"],[53,123,32,98],[53,125,33,6],[53,126,33,7],[54,8,34,4],[55,8,36,4],[55,12,36,10,"json"],[55,16,36,14],[55,25,36,23,"resp"],[55,29,36,27],[55,30,36,28,"json"],[55,34,36,32],[55,35,36,33],[55,36,36,34],[56,8,37,4],[56,15,37,11],[57,10,38,6,"ok"],[57,12,38,8],[57,14,38,10],[57,18,38,14],[58,10,39,6,"decision"],[58,18,39,14],[58,20,39,16,"json"],[58,24,39,20],[58,26,39,22,"decision"],[58,34,39,30],[58,38,39,34],[58,42,39,38],[59,10,40,6,"safeSearch"],[59,20,40,16],[59,22,40,18,"json"],[59,26,40,22],[59,28,40,24,"safeSearch"],[59,38,40,34],[59,42,40,38],[59,46,40,42],[60,10,41,6,"moderationSkipped"],[60,27,41,23],[60,29,41,25],[60,30,41,26],[60,31,41,27,"json"],[60,35,41,31],[60,37,41,33,"moderationSkipped"],[61,8,42,4],[61,9,42,5],[62,6,43,2],[62,7,43,3],[62,8,43,4],[62,15,43,11,"e"],[62,16,43,12],[62,18,43,14],[63,8,44,4,"console"],[63,15,44,11],[63,16,44,12,"error"],[63,21,44,17],[63,22,44,18],[63,56,44,52],[63,58,44,54,"e"],[63,59,44,55],[63,60,44,56],[64,8,45,4],[64,15,45,11],[65,10,45,13,"ok"],[65,12,45,15],[65,14,45,17],[65,19,45,22],[66,10,45,24,"error"],[66,15,45,29],[66,17,45,31,"e"],[66,18,45,32],[66,20,45,34,"message"],[66,27,45,41],[66,31,45,45],[67,8,45,65],[67,9,45,66],[68,6,46,2],[69,4,47,0],[69,5,47,1],[70,4,47,1],[70,11,47,1,"_moderatePhoto"],[70,25,47,1],[70,26,47,1,"apply"],[70,31,47,1],[70,38,47,1,"arguments"],[70,47,47,1],[71,2,47,1],[72,2,49,7],[72,11,49,16,"isDecisionAllowed"],[72,28,49,33,"isDecisionAllowed"],[72,29,50,2,"decision"],[72,37,50,10],[72,39,53,2],[73,4,53,2],[73,8,51,2,"moderationSkipped"],[73,25,51,19],[73,28,51,19,"arguments"],[73,37,51,19],[73,38,51,19,"length"],[73,44,51,19],[73,52,51,19,"arguments"],[73,61,51,19],[73,69,51,19,"undefined"],[73,78,51,19],[73,81,51,19,"arguments"],[73,90,51,19],[73,96,51,22],[73,101,51,27],[74,4,51,27],[74,8,52,2,"purpose"],[74,15,52,9],[74,18,52,9,"arguments"],[74,27,52,9],[74,28,52,9,"length"],[74,34,52,9],[74,42,52,9,"arguments"],[74,51,52,9],[74,59,52,9,"undefined"],[74,68,52,9],[74,71,52,9,"arguments"],[74,80,52,9],[74,86,52,12],[74,90,52,16],[75,4,54,2],[76,4,55,2],[77,4,56,2],[77,8,56,6,"moderationSkipped"],[77,25,56,23],[77,27,56,25],[78,6,57,4],[78,13,57,11],[78,17,57,15],[79,4,58,2],[80,4,60,2],[80,8,60,8,"d"],[80,9,60,9],[80,12,60,12,"String"],[80,18,60,18],[80,19,60,19,"decision"],[80,27,60,27],[80,31,60,31],[80,33,60,33],[80,34,60,34],[80,35,60,35,"toLowerCase"],[80,46,60,46],[80,47,60,47],[80,48,60,48],[81,4,61,2],[81,8,61,8,"p"],[81,9,61,9],[81,12,61,12,"String"],[81,18,61,18],[81,19,61,19,"purpose"],[81,26,61,26],[81,30,61,30],[81,32,61,32],[81,33,61,33],[81,34,61,34,"toLowerCase"],[81,45,61,45],[81,46,61,46],[81,47,61,47],[83,4,63,2],[84,4,64,2],[85,4,65,2],[86,4,66,2],[86,8,66,8,"allowReview"],[86,19,66,19],[86,22,66,22,"p"],[86,23,66,23],[86,28,66,28],[86,43,66,43],[86,47,66,47,"p"],[86,48,66,48],[86,53,66,53],[86,73,66,73],[87,4,68,2],[87,8,68,6,"d"],[87,9,68,7],[87,14,68,12],[87,23,68,21],[87,25,68,23],[88,6,69,4],[88,13,69,11],[88,17,69,15],[89,4,70,2],[90,4,72,2],[90,8,72,6,"allowReview"],[90,19,72,17],[90,23,72,21,"d"],[90,24,72,22],[90,29,72,27],[90,37,72,35],[90,39,72,37],[91,6,73,4],[91,13,73,11],[91,17,73,15],[92,4,74,2],[93,4,76,2],[93,11,76,9],[93,16,76,14],[94,2,77,0],[95,0,77,1],[95,3]],"functionMap":{"names":["<global>","moderatePhoto","isDecisionAllowed"],"mappings":"AAA,OC;CD8C;OEE;CF4B"},"hasCjsExports":false},"type":"js/module"}]}