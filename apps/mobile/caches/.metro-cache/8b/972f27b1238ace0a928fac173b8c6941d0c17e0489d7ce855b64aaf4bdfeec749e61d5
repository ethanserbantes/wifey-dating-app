{"dependencies":[{"name":"expo/virtual/env","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"dgHc21cgR+buKc7O3/dChhD5JJk=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  exports.moderatePhoto = moderatePhoto;\n  exports.isDecisionAllowed = isDecisionAllowed;\n  var _expoVirtualEnv = require(_dependencyMap[0], \"expo/virtual/env\");\n  async function moderatePhoto({\n    userId,\n    imageUrl,\n    purpose\n  }) {\n    const url = typeof imageUrl === \"string\" ? imageUrl.trim() : \"\";\n    if (!url) {\n      return {\n        ok: false,\n        error: \"Missing image url\"\n      };\n    }\n    try {\n      const baseURL = _expoVirtualEnv.env.EXPO_PUBLIC_BASE_URL || \"\";\n      const endpoint = baseURL ? `${baseURL}/api/moderation/photo` : \"/api/moderation/photo\";\n      const resp = await fetch(endpoint, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\"\n        },\n        body: JSON.stringify({\n          userId: Number.isFinite(Number(userId)) ? Number(userId) : null,\n          imageUrl: url,\n          purpose: purpose ? String(purpose) : null\n        })\n      });\n      if (!resp.ok) {\n        let extra = \"\";\n        try {\n          const j = await resp.json();\n          if (j?.error) extra = String(j.error);\n        } catch {\n          // ignore\n        }\n        throw new Error(extra || `When calling /api/moderation/photo, the response was [${resp.status}] ${resp.statusText}`);\n      }\n      const json = await resp.json();\n      return {\n        ok: true,\n        decision: json?.decision || null,\n        safeSearch: json?.safeSearch || null,\n        moderationSkipped: !!json?.moderationSkipped\n      };\n    } catch (e) {\n      console.error(\"[MODERATION] moderatePhoto error\", e);\n      return {\n        ok: false,\n        error: e?.message || \"Moderation failed\"\n      };\n    }\n  }\n  function isDecisionAllowed(decision, moderationSkipped = false, purpose = null) {\n    // If the server had to skip moderation (Vision API disabled / misconfigured),\n    // don't block the user during signup/profile edits.\n    if (moderationSkipped) {\n      return true;\n    }\n    const d = String(decision || \"\").toLowerCase();\n    const p = String(purpose || \"\").toLowerCase();\n\n    // By default we only allow \"approve\".\n    // BUT: SafeSearch false positives happen a lot for normal selfies/swimsuit/fashion.\n    // For our two user-facing flows, we allow \"review\" (it still gets recorded server-side).\n    const allowReview = p === \"profile_photo\" || p === \"verification_photo\";\n    if (d === \"approve\") {\n      return true;\n    }\n    if (allowReview && d === \"review\") {\n      return true;\n    }\n    return false;\n  }\n});","lineCount":82,"map":[[7,2,1,0,"exports"],[7,9,1,0],[7,10,1,0,"moderatePhoto"],[7,23,1,0],[7,26,1,0,"moderatePhoto"],[7,39,1,0],[8,2,49,0,"exports"],[8,9,49,0],[8,10,49,0,"isDecisionAllowed"],[8,27,49,0],[8,30,49,0,"isDecisionAllowed"],[8,47,49,0],[9,2,77,1],[9,6,77,1,"_expoVirtualEnv"],[9,21,77,1],[9,24,77,1,"require"],[9,31,77,1],[9,32,77,1,"_dependencyMap"],[9,46,77,1],[10,2,1,7],[10,17,1,22,"moderatePhoto"],[10,30,1,35,"moderatePhoto"],[10,31,1,36],[11,4,1,38,"userId"],[11,10,1,44],[12,4,1,46,"imageUrl"],[12,12,1,54],[13,4,1,56,"purpose"],[14,2,1,64],[14,3,1,65],[14,5,1,67],[15,4,2,2],[15,10,2,8,"url"],[15,13,2,11],[15,16,2,14],[15,23,2,21,"imageUrl"],[15,31,2,29],[15,36,2,34],[15,44,2,42],[15,47,2,45,"imageUrl"],[15,55,2,53],[15,56,2,54,"trim"],[15,60,2,58],[15,61,2,59],[15,62,2,60],[15,65,2,63],[15,67,2,65],[16,4,3,2],[16,8,3,6],[16,9,3,7,"url"],[16,12,3,10],[16,14,3,12],[17,6,4,4],[17,13,4,11],[18,8,4,13,"ok"],[18,10,4,15],[18,12,4,17],[18,17,4,22],[19,8,4,24,"error"],[19,13,4,29],[19,15,4,31],[20,6,4,51],[20,7,4,52],[21,4,5,2],[22,4,7,2],[22,8,7,6],[23,6,8,4],[23,12,8,10,"baseURL"],[23,19,8,17],[23,22,8,20,"_expoVirtualEnv"],[23,37,8,20],[23,38,8,20,"env"],[23,41,8,20],[23,42,8,20,"EXPO_PUBLIC_BASE_URL"],[23,62,8,20],[23,66,8,56],[23,68,8,58],[24,6,9,4],[24,12,9,10,"endpoint"],[24,20,9,18],[24,23,9,21,"baseURL"],[24,30,9,28],[24,33,9,31],[24,36,9,34,"baseURL"],[24,43,9,41],[24,66,9,64],[24,69,9,67],[24,92,9,90],[25,6,11,4],[25,12,11,10,"resp"],[25,16,11,14],[25,19,11,17],[25,25,11,23,"fetch"],[25,30,11,28],[25,31,11,29,"endpoint"],[25,39,11,37],[25,41,11,39],[26,8,12,6,"method"],[26,14,12,12],[26,16,12,14],[26,22,12,20],[27,8,13,6,"headers"],[27,15,13,13],[27,17,13,15],[28,10,13,17],[28,24,13,31],[28,26,13,33],[29,8,13,52],[29,9,13,53],[30,8,14,6,"body"],[30,12,14,10],[30,14,14,12,"JSON"],[30,18,14,16],[30,19,14,17,"stringify"],[30,28,14,26],[30,29,14,27],[31,10,15,8,"userId"],[31,16,15,14],[31,18,15,16,"Number"],[31,24,15,22],[31,25,15,23,"isFinite"],[31,33,15,31],[31,34,15,32,"Number"],[31,40,15,38],[31,41,15,39,"userId"],[31,47,15,45],[31,48,15,46],[31,49,15,47],[31,52,15,50,"Number"],[31,58,15,56],[31,59,15,57,"userId"],[31,65,15,63],[31,66,15,64],[31,69,15,67],[31,73,15,71],[32,10,16,8,"imageUrl"],[32,18,16,16],[32,20,16,18,"url"],[32,23,16,21],[33,10,17,8,"purpose"],[33,17,17,15],[33,19,17,17,"purpose"],[33,26,17,24],[33,29,17,27,"String"],[33,35,17,33],[33,36,17,34,"purpose"],[33,43,17,41],[33,44,17,42],[33,47,17,45],[34,8,18,6],[34,9,18,7],[35,6,19,4],[35,7,19,5],[35,8,19,6],[36,6,21,4],[36,10,21,8],[36,11,21,9,"resp"],[36,15,21,13],[36,16,21,14,"ok"],[36,18,21,16],[36,20,21,18],[37,8,22,6],[37,12,22,10,"extra"],[37,17,22,15],[37,20,22,18],[37,22,22,20],[38,8,23,6],[38,12,23,10],[39,10,24,8],[39,16,24,14,"j"],[39,17,24,15],[39,20,24,18],[39,26,24,24,"resp"],[39,30,24,28],[39,31,24,29,"json"],[39,35,24,33],[39,36,24,34],[39,37,24,35],[40,10,25,8],[40,14,25,12,"j"],[40,15,25,13],[40,17,25,15,"error"],[40,22,25,20],[40,24,25,22,"extra"],[40,29,25,27],[40,32,25,30,"String"],[40,38,25,36],[40,39,25,37,"j"],[40,40,25,38],[40,41,25,39,"error"],[40,46,25,44],[40,47,25,45],[41,8,26,6],[41,9,26,7],[41,10,26,8],[41,16,26,14],[42,10,27,8],[43,8,27,8],[44,8,30,6],[44,14,30,12],[44,18,30,16,"Error"],[44,23,30,21],[44,24,31,8,"extra"],[44,29,31,13],[44,33,32,10],[44,90,32,67,"resp"],[44,94,32,71],[44,95,32,72,"status"],[44,101,32,78],[44,106,32,83,"resp"],[44,110,32,87],[44,111,32,88,"statusText"],[44,121,32,98],[44,123,33,6],[44,124,33,7],[45,6,34,4],[46,6,36,4],[46,12,36,10,"json"],[46,16,36,14],[46,19,36,17],[46,25,36,23,"resp"],[46,29,36,27],[46,30,36,28,"json"],[46,34,36,32],[46,35,36,33],[46,36,36,34],[47,6,37,4],[47,13,37,11],[48,8,38,6,"ok"],[48,10,38,8],[48,12,38,10],[48,16,38,14],[49,8,39,6,"decision"],[49,16,39,14],[49,18,39,16,"json"],[49,22,39,20],[49,24,39,22,"decision"],[49,32,39,30],[49,36,39,34],[49,40,39,38],[50,8,40,6,"safeSearch"],[50,18,40,16],[50,20,40,18,"json"],[50,24,40,22],[50,26,40,24,"safeSearch"],[50,36,40,34],[50,40,40,38],[50,44,40,42],[51,8,41,6,"moderationSkipped"],[51,25,41,23],[51,27,41,25],[51,28,41,26],[51,29,41,27,"json"],[51,33,41,31],[51,35,41,33,"moderationSkipped"],[52,6,42,4],[52,7,42,5],[53,4,43,2],[53,5,43,3],[53,6,43,4],[53,13,43,11,"e"],[53,14,43,12],[53,16,43,14],[54,6,44,4,"console"],[54,13,44,11],[54,14,44,12,"error"],[54,19,44,17],[54,20,44,18],[54,54,44,52],[54,56,44,54,"e"],[54,57,44,55],[54,58,44,56],[55,6,45,4],[55,13,45,11],[56,8,45,13,"ok"],[56,10,45,15],[56,12,45,17],[56,17,45,22],[57,8,45,24,"error"],[57,13,45,29],[57,15,45,31,"e"],[57,16,45,32],[57,18,45,34,"message"],[57,25,45,41],[57,29,45,45],[58,6,45,65],[58,7,45,66],[59,4,46,2],[60,2,47,0],[61,2,49,7],[61,11,49,16,"isDecisionAllowed"],[61,28,49,33,"isDecisionAllowed"],[61,29,50,2,"decision"],[61,37,50,10],[61,39,51,2,"moderationSkipped"],[61,56,51,19],[61,59,51,22],[61,64,51,27],[61,66,52,2,"purpose"],[61,73,52,9],[61,76,52,12],[61,80,52,16],[61,82,53,2],[62,4,54,2],[63,4,55,2],[64,4,56,2],[64,8,56,6,"moderationSkipped"],[64,25,56,23],[64,27,56,25],[65,6,57,4],[65,13,57,11],[65,17,57,15],[66,4,58,2],[67,4,60,2],[67,10,60,8,"d"],[67,11,60,9],[67,14,60,12,"String"],[67,20,60,18],[67,21,60,19,"decision"],[67,29,60,27],[67,33,60,31],[67,35,60,33],[67,36,60,34],[67,37,60,35,"toLowerCase"],[67,48,60,46],[67,49,60,47],[67,50,60,48],[68,4,61,2],[68,10,61,8,"p"],[68,11,61,9],[68,14,61,12,"String"],[68,20,61,18],[68,21,61,19,"purpose"],[68,28,61,26],[68,32,61,30],[68,34,61,32],[68,35,61,33],[68,36,61,34,"toLowerCase"],[68,47,61,45],[68,48,61,46],[68,49,61,47],[70,4,63,2],[71,4,64,2],[72,4,65,2],[73,4,66,2],[73,10,66,8,"allowReview"],[73,21,66,19],[73,24,66,22,"p"],[73,25,66,23],[73,30,66,28],[73,45,66,43],[73,49,66,47,"p"],[73,50,66,48],[73,55,66,53],[73,75,66,73],[74,4,68,2],[74,8,68,6,"d"],[74,9,68,7],[74,14,68,12],[74,23,68,21],[74,25,68,23],[75,6,69,4],[75,13,69,11],[75,17,69,15],[76,4,70,2],[77,4,72,2],[77,8,72,6,"allowReview"],[77,19,72,17],[77,23,72,21,"d"],[77,24,72,22],[77,29,72,27],[77,37,72,35],[77,39,72,37],[78,6,73,4],[78,13,73,11],[78,17,73,15],[79,4,74,2],[80,4,76,2],[80,11,76,9],[80,16,76,14],[81,2,77,0],[82,0,77,1],[82,3]],"functionMap":{"names":["<global>","moderatePhoto","isDecisionAllowed"],"mappings":"AAA,OC;CD8C;OEE;CF4B"},"hasCjsExports":false},"type":"js/module"}]}