{"dependencies":[{"name":"@babel/runtime/helpers/asyncToGenerator","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"YisBBiy2Xm9DEVdFebZ2nbgAHBo=","exportNames":["*"],"imports":1}},{"name":"@sentry/core","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":93,"index":93}}],"key":"/o+dASQcHF2bB25icdsM0E4TExc=","exportNames":["*"],"imports":1}},{"name":"../debug-build.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":94},"end":{"line":2,"column":48,"index":142}}],"key":"rfhktnzi6PvZxT1xtyHWbBktN/w=","exportNames":["*"],"imports":1}},{"name":"../helpers.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":143},"end":{"line":3,"column":39,"index":182}}],"key":"xGB1RU1bemGAHq3E44EIR7oSA2c=","exportNames":["*"],"imports":1}},{"name":"./utils.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":4,"column":0,"index":183},"end":{"line":4,"column":123,"index":306}}],"key":"NIaSEHO1E48gsZc7jH9Ex1xTHgE=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  Object.defineProperty(exports, \"startProfileForSpan\", {\n    enumerable: true,\n    get: function () {\n      return startProfileForSpan;\n    }\n  });\n  var _babelRuntimeHelpersAsyncToGenerator = require(_dependencyMap[0], \"@babel/runtime/helpers/asyncToGenerator\");\n  var _asyncToGenerator = _interopDefault(_babelRuntimeHelpersAsyncToGenerator);\n  var _sentryCore = require(_dependencyMap[1], \"@sentry/core\");\n  var _debugBuildJs = require(_dependencyMap[2], \"../debug-build.js\");\n  var _helpersJs = require(_dependencyMap[3], \"../helpers.js\");\n  var _utilsJs = require(_dependencyMap[4], \"./utils.js\");\n  /**\n   * Wraps startTransaction and stopTransaction with profiling related logic.\n   * startProfileForTransaction is called after the call to startTransaction in order to avoid our own code from\n   * being profiled. Because of that same reason, stopProfiling is called before the call to stopTransaction.\n   */\n  function startProfileForSpan(span) {\n    // Start the profiler and get the profiler instance.\n    var startTimestamp;\n    if ((0, _utilsJs.isAutomatedPageLoadSpan)(span)) {\n      startTimestamp = (0, _sentryCore.timestampInSeconds)() * 1000;\n    }\n    var profiler = (0, _utilsJs.startJSSelfProfile)();\n\n    // We failed to construct the profiler, so we skip.\n    // No need to log anything as this has already been logged in startProfile.\n    if (!profiler) {\n      return;\n    }\n    if (_debugBuildJs.DEBUG_BUILD) {\n      _sentryCore.debug.log(`[Profiling] started profiling span: ${(0, _sentryCore.spanToJSON)(span).description}`);\n    }\n\n    // We create \"unique\" span names to avoid concurrent spans with same names\n    // from being ignored by the profiler. From here on, only this span name should be used when\n    // calling the profiler methods. Note: we log the original name to the user to avoid confusion.\n    var profileId = (0, _sentryCore.uuid4)();\n\n    // A couple of important things to note here:\n    // `CpuProfilerBindings.stopProfiling` will be scheduled to run in 30seconds in order to exceed max profile duration.\n    // Whichever of the two (span.finish/timeout) is first to run, the profiling will be stopped and the gathered profile\n    // will be processed when the original span is finished. Since onProfileHandler can be invoked multiple times in the\n    // event of an error or user mistake (calling span.finish multiple times), it is important that the behavior of onProfileHandler\n    // is idempotent as we do not want any timings or profiles to be overridden by the last call to onProfileHandler.\n    // After the original finish method is called, the event will be reported through the integration and delegated to transport.\n    var processedProfile = null;\n    (0, _sentryCore.getCurrentScope)().setContext('profile', {\n      profile_id: profileId,\n      start_timestamp: startTimestamp\n    });\n\n    /**\n     * Idempotent handler for profile stop\n     */\n    function onProfileHandler() {\n      return _onProfileHandler.apply(this, arguments);\n    } // Enqueue a timeout to prevent profiles from running over max duration.\n    function _onProfileHandler() {\n      _onProfileHandler = (0, _asyncToGenerator.default)(function* () {\n        // Check if the profile exists and return it the behavior has to be idempotent as users may call span.finish multiple times.\n        if (!span) {\n          return;\n        }\n        // Satisfy the type checker, but profiler will always be defined here.\n        if (!profiler) {\n          return;\n        }\n        if (processedProfile) {\n          if (_debugBuildJs.DEBUG_BUILD) {\n            _sentryCore.debug.log('[Profiling] profile for:', (0, _sentryCore.spanToJSON)(span).description, 'already exists, returning early');\n          }\n          return;\n        }\n        return profiler.stop().then(profile => {\n          if (maxDurationTimeoutID) {\n            _helpersJs.WINDOW.clearTimeout(maxDurationTimeoutID);\n            maxDurationTimeoutID = undefined;\n          }\n          if (_debugBuildJs.DEBUG_BUILD) {\n            _sentryCore.debug.log(`[Profiling] stopped profiling of span: ${(0, _sentryCore.spanToJSON)(span).description}`);\n          }\n\n          // In case of an overlapping span, stopProfiling may return null and silently ignore the overlapping profile.\n          if (!profile) {\n            if (_debugBuildJs.DEBUG_BUILD) {\n              _sentryCore.debug.log(`[Profiling] profiler returned null profile for: ${(0, _sentryCore.spanToJSON)(span).description}`, 'this may indicate an overlapping span or a call to stopProfiling with a profile title that was never started');\n            }\n            return;\n          }\n          processedProfile = profile;\n          (0, _utilsJs.addProfileToGlobalCache)(profileId, profile);\n        }).catch(error => {\n          if (_debugBuildJs.DEBUG_BUILD) {\n            _sentryCore.debug.log('[Profiling] error while stopping profiler:', error);\n          }\n        });\n      });\n      return _onProfileHandler.apply(this, arguments);\n    }\n    var maxDurationTimeoutID = _helpersJs.WINDOW.setTimeout(() => {\n      if (_debugBuildJs.DEBUG_BUILD) {\n        _sentryCore.debug.log('[Profiling] max profile duration elapsed, stopping profiling for:', (0, _sentryCore.spanToJSON)(span).description);\n      }\n      // If the timeout exceeds, we want to stop profiling, but not finish the span\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      onProfileHandler();\n    }, _utilsJs.MAX_PROFILE_DURATION_MS);\n\n    // We need to reference the original end call to avoid creating an infinite loop\n    var originalEnd = span.end.bind(span);\n\n    /**\n     * Wraps span `end()` with profiling related logic.\n     * startProfiling is called after the call to spanStart in order to avoid our own code from\n     * being profiled. Because of that same reason, stopProfiling is called before the call to spanEnd.\n     */\n    function profilingWrappedSpanEnd() {\n      if (!span) {\n        return originalEnd();\n      }\n      // onProfileHandler should always return the same profile even if this is called multiple times.\n      // Always call onProfileHandler to ensure stopProfiling is called and the timeout is cleared.\n      void onProfileHandler().then(() => {\n        originalEnd();\n      }, () => {\n        // If onProfileHandler fails, we still want to call the original finish method.\n        originalEnd();\n      });\n      return span;\n    }\n    span.end = profilingWrappedSpanEnd;\n  }\n});","lineCount":145,"map":[[12,2,141,0,"Object"],[12,8,141,0],[12,9,141,0,"defineProperty"],[12,23,141,0],[12,24,141,0,"exports"],[12,31,141,0],[13,4,141,0,"enumerable"],[13,14,141,0],[14,4,141,0,"get"],[14,7,141,0],[14,18,141,0,"get"],[14,19,141,0],[15,6,141,0],[15,13,141,9,"startProfileForSpan"],[15,32,141,28],[16,4,141,28],[17,2,141,28],[18,2,141,31],[18,6,141,31,"_babelRuntimeHelpersAsyncToGenerator"],[18,42,141,31],[18,45,141,31,"require"],[18,52,141,31],[18,53,141,31,"_dependencyMap"],[18,67,141,31],[19,2,141,31],[19,6,141,31,"_asyncToGenerator"],[19,23,141,31],[19,26,141,31,"_interopDefault"],[19,41,141,31],[19,42,141,31,"_babelRuntimeHelpersAsyncToGenerator"],[19,78,141,31],[20,2,1,0],[20,6,1,0,"_sentryCore"],[20,17,1,0],[20,20,1,0,"require"],[20,27,1,0],[20,28,1,0,"_dependencyMap"],[20,42,1,0],[21,2,2,0],[21,6,2,0,"_debugBuildJs"],[21,19,2,0],[21,22,2,0,"require"],[21,29,2,0],[21,30,2,0,"_dependencyMap"],[21,44,2,0],[22,2,3,0],[22,6,3,0,"_helpersJs"],[22,16,3,0],[22,19,3,0,"require"],[22,26,3,0],[22,27,3,0,"_dependencyMap"],[22,41,3,0],[23,2,4,0],[23,6,4,0,"_utilsJs"],[23,14,4,0],[23,17,4,0,"require"],[23,24,4,0],[23,25,4,0,"_dependencyMap"],[23,39,4,0],[24,2,6,0],[25,0,7,0],[26,0,8,0],[27,0,9,0],[28,0,10,0],[29,2,11,0],[29,11,11,9,"startProfileForSpan"],[29,30,11,28,"startProfileForSpan"],[29,31,11,29,"span"],[29,35,11,33],[29,37,11,35],[30,4,12,2],[31,4,13,2],[31,8,13,6,"startTimestamp"],[31,22,13,20],[32,4,14,2],[32,8,14,6],[32,12,14,6,"isAutomatedPageLoadSpan"],[32,20,14,29],[32,21,14,29,"isAutomatedPageLoadSpan"],[32,44,14,29],[32,46,14,30,"span"],[32,50,14,34],[32,51,14,35],[32,53,14,37],[33,6,15,4,"startTimestamp"],[33,20,15,18],[33,23,15,21],[33,27,15,21,"timestampInSeconds"],[33,38,15,39],[33,39,15,39,"timestampInSeconds"],[33,57,15,39],[33,59,15,40],[33,60,15,41],[33,63,15,44],[33,67,15,48],[34,4,16,2],[35,4,18,2],[35,8,18,8,"profiler"],[35,16,18,16],[35,19,18,19],[35,23,18,19,"startJSSelfProfile"],[35,31,18,37],[35,32,18,37,"startJSSelfProfile"],[35,50,18,37],[35,52,18,38],[35,53,18,39],[37,4,20,2],[38,4,21,2],[39,4,22,2],[39,8,22,6],[39,9,22,7,"profiler"],[39,17,22,15],[39,19,22,17],[40,6,23,4],[41,4,24,2],[42,4,26,2],[42,8,26,6,"DEBUG_BUILD"],[42,21,26,17],[42,22,26,17,"DEBUG_BUILD"],[42,33,26,17],[42,35,26,19],[43,6,27,4,"debug"],[43,17,27,9],[43,18,27,9,"debug"],[43,23,27,9],[43,24,27,10,"log"],[43,27,27,13],[43,28,27,14],[43,67,27,53],[43,71,27,53,"spanToJSON"],[43,82,27,63],[43,83,27,63,"spanToJSON"],[43,93,27,63],[43,95,27,64,"span"],[43,99,27,68],[43,100,27,69],[43,101,27,70,"description"],[43,112,27,81],[43,114,27,83],[43,115,27,84],[44,4,28,2],[46,4,30,2],[47,4,31,2],[48,4,32,2],[49,4,33,2],[49,8,33,8,"profileId"],[49,17,33,17],[49,20,33,20],[49,24,33,20,"uuid4"],[49,35,33,25],[49,36,33,25,"uuid4"],[49,41,33,25],[49,43,33,26],[49,44,33,27],[51,4,35,2],[52,4,36,2],[53,4,37,2],[54,4,38,2],[55,4,39,2],[56,4,40,2],[57,4,41,2],[58,4,42,2],[58,8,42,6,"processedProfile"],[58,24,42,22],[58,27,42,25],[58,31,42,29],[59,4,44,2],[59,8,44,2,"getCurrentScope"],[59,19,44,17],[59,20,44,17,"getCurrentScope"],[59,35,44,17],[59,37,44,18],[59,38,44,19],[59,39,44,20,"setContext"],[59,49,44,30],[59,50,44,31],[59,59,44,40],[59,61,44,42],[60,6,45,4,"profile_id"],[60,16,45,14],[60,18,45,16,"profileId"],[60,27,45,25],[61,6,46,4,"start_timestamp"],[61,21,46,19],[61,23,46,21,"startTimestamp"],[62,4,47,2],[62,5,47,3],[62,6,47,4],[64,4,49,2],[65,0,50,0],[66,0,51,0],[67,4,49,2],[67,13,52,17,"onProfileHandler"],[67,29,52,33,"onProfileHandler"],[67,30,52,33],[68,6,52,33],[68,13,52,33,"_onProfileHandler"],[68,30,52,33],[68,31,52,33,"apply"],[68,36,52,33],[68,43,52,33,"arguments"],[68,52,52,33],[69,4,52,33],[69,6,101,2],[70,4,101,2],[70,13,101,2,"_onProfileHandler"],[70,31,101,2],[71,6,101,2,"_onProfileHandler"],[71,23,101,2],[71,30,101,2,"_asyncToGenerator"],[71,47,101,2],[71,48,101,2,"default"],[71,55,101,2],[71,57,52,2],[71,70,52,36],[72,8,53,4],[73,8,54,4],[73,12,54,8],[73,13,54,9,"span"],[73,17,54,13],[73,19,54,15],[74,10,55,6],[75,8,56,4],[76,8,57,4],[77,8,58,4],[77,12,58,8],[77,13,58,9,"profiler"],[77,21,58,17],[77,23,58,19],[78,10,59,6],[79,8,60,4],[80,8,61,4],[80,12,61,8,"processedProfile"],[80,28,61,24],[80,30,61,26],[81,10,62,6],[81,14,62,10,"DEBUG_BUILD"],[81,27,62,21],[81,28,62,21,"DEBUG_BUILD"],[81,39,62,21],[81,41,62,23],[82,12,63,8,"debug"],[82,23,63,13],[82,24,63,13,"debug"],[82,29,63,13],[82,30,63,14,"log"],[82,33,63,17],[82,34,63,18],[82,60,63,44],[82,62,63,46],[82,66,63,46,"spanToJSON"],[82,77,63,56],[82,78,63,56,"spanToJSON"],[82,88,63,56],[82,90,63,57,"span"],[82,94,63,61],[82,95,63,62],[82,96,63,63,"description"],[82,107,63,74],[82,109,63,76],[82,142,63,109],[82,143,63,110],[83,10,64,6],[84,10,65,6],[85,8,66,4],[86,8,68,4],[86,15,68,11,"profiler"],[86,23,68,19],[86,24,69,7,"stop"],[86,28,69,11],[86,29,69,12],[86,30,69,13],[86,31,70,7,"then"],[86,35,70,11],[86,36,70,13,"profile"],[86,43,70,20],[86,47,70,25],[87,10,71,8],[87,14,71,12,"maxDurationTimeoutID"],[87,34,71,32],[87,36,71,34],[88,12,72,10,"WINDOW"],[88,22,72,16],[88,23,72,16,"WINDOW"],[88,29,72,16],[88,30,72,17,"clearTimeout"],[88,42,72,29],[88,43,72,30,"maxDurationTimeoutID"],[88,63,72,50],[88,64,72,51],[89,12,73,10,"maxDurationTimeoutID"],[89,32,73,30],[89,35,73,33,"undefined"],[89,44,73,42],[90,10,74,8],[91,10,76,8],[91,14,76,12,"DEBUG_BUILD"],[91,27,76,23],[91,28,76,23,"DEBUG_BUILD"],[91,39,76,23],[91,41,76,25],[92,12,77,10,"debug"],[92,23,77,15],[92,24,77,15,"debug"],[92,29,77,15],[92,30,77,16,"log"],[92,33,77,19],[92,34,77,20],[92,76,77,62],[92,80,77,62,"spanToJSON"],[92,91,77,72],[92,92,77,72,"spanToJSON"],[92,102,77,72],[92,104,77,73,"span"],[92,108,77,77],[92,109,77,78],[92,110,77,79,"description"],[92,121,77,90],[92,123,77,92],[92,124,77,93],[93,10,78,8],[95,10,80,8],[96,10,81,8],[96,14,81,12],[96,15,81,13,"profile"],[96,22,81,20],[96,24,81,22],[97,12,82,10],[97,16,82,14,"DEBUG_BUILD"],[97,29,82,25],[97,30,82,25,"DEBUG_BUILD"],[97,41,82,25],[97,43,82,27],[98,14,83,12,"debug"],[98,25,83,17],[98,26,83,17,"debug"],[98,31,83,17],[98,32,83,18,"log"],[98,35,83,21],[98,36,84,14],[98,87,84,65],[98,91,84,65,"spanToJSON"],[98,102,84,75],[98,103,84,75,"spanToJSON"],[98,113,84,75],[98,115,84,76,"span"],[98,119,84,80],[98,120,84,81],[98,121,84,82,"description"],[98,132,84,93],[98,134,84,95],[98,136,85,14],[98,246,86,12],[98,247,86,13],[99,12,87,10],[100,12,88,10],[101,10,89,8],[102,10,91,8,"processedProfile"],[102,26,91,24],[102,29,91,27,"profile"],[102,36,91,34],[103,10,92,8],[103,14,92,8,"addProfileToGlobalCache"],[103,22,92,31],[103,23,92,31,"addProfileToGlobalCache"],[103,46,92,31],[103,48,92,32,"profileId"],[103,57,92,41],[103,59,92,43,"profile"],[103,66,92,50],[103,67,92,51],[104,8,93,6],[104,9,93,7],[104,10,93,8],[104,11,94,7,"catch"],[104,16,94,12],[104,17,94,13,"error"],[104,22,94,18],[104,26,94,22],[105,10,95,8],[105,14,95,12,"DEBUG_BUILD"],[105,27,95,23],[105,28,95,23,"DEBUG_BUILD"],[105,39,95,23],[105,41,95,25],[106,12,96,10,"debug"],[106,23,96,15],[106,24,96,15,"debug"],[106,29,96,15],[106,30,96,16,"log"],[106,33,96,19],[106,34,96,20],[106,78,96,64],[106,80,96,66,"error"],[106,85,96,71],[106,86,96,72],[107,10,97,8],[108,8,98,6],[108,9,98,7],[108,10,98,8],[109,6,99,2],[109,7,99,3],[110,6,99,3],[110,13,99,3,"_onProfileHandler"],[110,30,99,3],[110,31,99,3,"apply"],[110,36,99,3],[110,43,99,3,"arguments"],[110,52,99,3],[111,4,99,3],[112,4,102,2],[112,8,102,6,"maxDurationTimeoutID"],[112,28,102,26],[112,31,102,29,"WINDOW"],[112,41,102,35],[112,42,102,35,"WINDOW"],[112,48,102,35],[112,49,102,36,"setTimeout"],[112,59,102,46],[112,60,102,47],[112,66,102,53],[113,6,103,4],[113,10,103,8,"DEBUG_BUILD"],[113,23,103,19],[113,24,103,19,"DEBUG_BUILD"],[113,35,103,19],[113,37,103,21],[114,8,104,6,"debug"],[114,19,104,11],[114,20,104,11,"debug"],[114,25,104,11],[114,26,104,12,"log"],[114,29,104,15],[114,30,104,16],[114,97,104,83],[114,99,104,85],[114,103,104,85,"spanToJSON"],[114,114,104,95],[114,115,104,95,"spanToJSON"],[114,125,104,95],[114,127,104,96,"span"],[114,131,104,100],[114,132,104,101],[114,133,104,102,"description"],[114,144,104,113],[114,145,104,114],[115,6,105,4],[116,6,106,4],[117,6,107,4],[118,6,108,4,"onProfileHandler"],[118,22,108,20],[118,23,108,21],[118,24,108,22],[119,4,109,2],[119,5,109,3],[119,7,109,5,"MAX_PROFILE_DURATION_MS"],[119,15,109,28],[119,16,109,28,"MAX_PROFILE_DURATION_MS"],[119,39,109,28],[119,40,109,29],[121,4,111,2],[122,4,112,2],[122,8,112,8,"originalEnd"],[122,19,112,19],[122,22,112,22,"span"],[122,26,112,26],[122,27,112,27,"end"],[122,30,112,30],[122,31,112,31,"bind"],[122,35,112,35],[122,36,112,36,"span"],[122,40,112,40],[122,41,112,41],[124,4,114,2],[125,0,115,0],[126,0,116,0],[127,0,117,0],[128,0,118,0],[129,4,119,2],[129,13,119,11,"profilingWrappedSpanEnd"],[129,36,119,34,"profilingWrappedSpanEnd"],[129,37,119,34],[129,39,119,37],[130,6,120,4],[130,10,120,8],[130,11,120,9,"span"],[130,15,120,13],[130,17,120,15],[131,8,121,6],[131,15,121,13,"originalEnd"],[131,26,121,24],[131,27,121,25],[131,28,121,26],[132,6,122,4],[133,6,123,4],[134,6,124,4],[135,6,125,4],[135,11,125,9,"onProfileHandler"],[135,27,125,25],[135,28,125,26],[135,29,125,27],[135,30,125,28,"then"],[135,34,125,32],[135,35,126,6],[135,41,126,12],[136,8,127,8,"originalEnd"],[136,19,127,19],[136,20,127,20],[136,21,127,21],[137,6,128,6],[137,7,128,7],[137,9,129,6],[137,15,129,12],[138,8,130,8],[139,8,131,8,"originalEnd"],[139,19,131,19],[139,20,131,20],[139,21,131,21],[140,6,132,6],[140,7,133,4],[140,8,133,5],[141,6,135,4],[141,13,135,11,"span"],[141,17,135,15],[142,4,136,2],[143,4,138,2,"span"],[143,8,138,6],[143,9,138,7,"end"],[143,12,138,10],[143,15,138,13,"profilingWrappedSpanEnd"],[143,38,138,36],[144,2,139,0],[145,0,139,1],[145,3]],"functionMap":{"names":["<global>","startProfileForSpan","onProfileHandler","profiler.stop.then$argument_0","profiler.stop.then._catch$argument_0","WINDOW.setTimeout$argument_0","profilingWrappedSpanEnd","onProfileHandler.then$argument_0","onProfileHandler.then$argument_1"],"mappings":"AAA;ACU;ECyC;YCkB;ODuB;aEC;OFI;GDC;+CIG;GJO;EKU;MCO;ODE;MEC;OFG;GLI;CDG"},"hasCjsExports":false},"type":"js/module"}]}