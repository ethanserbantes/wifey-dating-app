{"dependencies":[{"name":"react","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":46,"index":46}}],"key":"RtGiGa+/H7VrI7GDQDLhO1UbpU8=","exportNames":["*"],"imports":1}},{"name":"@/utils/useUpload","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":47},"end":{"line":2,"column":42,"index":89}}],"key":"fmgUBhSYAJBo9LhumboFTPrCXjE=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  var _s = $RefreshSig$();\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  exports.useSendMessage = useSendMessage;\n  var _react = require(_dependencyMap[0], \"react\");\n  var _utilsUseUpload = require(_dependencyMap[1], \"@/utils/useUpload\");\n  var useUpload = _interopDefault(_utilsUseUpload);\n  function useSendMessage(matchId, user, setMessages, options) {\n    _s();\n    const onPaymentRequired = options?.onPaymentRequired;\n    const [inputText, setInputText] = (0, _react.useState)(\"\");\n    const [sending, setSending] = (0, _react.useState)(false);\n    const [voiceSending, setVoiceSending] = (0, _react.useState)(false);\n\n    // NEW: reply-to state\n    const [replyTo, setReplyTo] = (0, _react.useState)(null);\n    const [upload, {\n      loading: uploadLoading\n    }] = (0, useUpload.default)();\n    const clearReplyTo = (0, _react.useCallback)(() => {\n      setReplyTo(null);\n    }, []);\n    const sendMessage = async () => {\n      if (!inputText.trim() || !user || sending) return;\n      const messageText = inputText.trim();\n      const repliedToMessageId = replyTo?.id ?? null;\n      setInputText(\"\");\n      setSending(true);\n      try {\n        const response = await fetch(\"/api/messages/send\", {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\"\n          },\n          body: JSON.stringify({\n            matchId,\n            senderId: user.id,\n            messageText,\n            repliedToMessageId\n          })\n        });\n        if (!response.ok) {\n          // payment required -> open the date credit sheet and keep the draft.\n          if (response.status === 402) {\n            setInputText(messageText);\n            try {\n              onPaymentRequired?.();\n            } catch (e) {\n              console.error(e);\n            }\n            return;\n          }\n          const text = await response.text().catch(() => \"\");\n          throw new Error(`Failed to send message: [${response.status}] ${response.statusText} ${text}`);\n        }\n        const data = await response.json();\n        setMessages(prev => [...prev, data.message]);\n        clearReplyTo();\n      } catch (error) {\n        console.error(\"Error sending message:\", error);\n        setInputText(messageText);\n      } finally {\n        setSending(false);\n      }\n    };\n    const sendVoiceMemo = (0, _react.useCallback)(async ({\n      uri,\n      durationMs\n    }) => {\n      if (!user || voiceSending || uploadLoading) return;\n      if (!uri || typeof uri !== \"string\") return;\n      const repliedToMessageId = replyTo?.id ?? null;\n      setVoiceSending(true);\n      try {\n        const fileName = `voice-memo-${Date.now()}.m4a`;\n        const {\n          url,\n          error\n        } = await upload({\n          reactNativeAsset: {\n            uri,\n            fileName,\n            name: fileName,\n            mimeType: \"audio/m4a\"\n          }\n        });\n        if (error) {\n          throw new Error(error);\n        }\n        const response = await fetch(\"/api/messages/send\", {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\"\n          },\n          body: JSON.stringify({\n            matchId,\n            senderId: user.id,\n            audioUrl: url,\n            audioDurationMs: durationMs,\n            repliedToMessageId\n            // messageText intentionally omitted\n          })\n        });\n        if (!response.ok) {\n          // payment required -> open the date credit sheet.\n          if (response.status === 402) {\n            try {\n              onPaymentRequired?.();\n            } catch (e) {\n              console.error(e);\n            }\n            return;\n          }\n          const text = await response.text().catch(() => \"\");\n          throw new Error(`Failed to send voice memo: [${response.status}] ${response.statusText} ${text}`);\n        }\n        const data = await response.json();\n        setMessages(prev => [...prev, data.message]);\n        clearReplyTo();\n      } catch (error) {\n        console.error(\"Error sending voice memo:\", error);\n      } finally {\n        setVoiceSending(false);\n      }\n    }, [matchId, onPaymentRequired, replyTo?.id, upload, uploadLoading, user, voiceSending, setMessages, clearReplyTo]);\n    return {\n      inputText,\n      setInputText,\n      sending,\n      sendMessage,\n      voiceSending,\n      sendVoiceMemo,\n      replyTo,\n      setReplyTo,\n      clearReplyTo\n    };\n  }\n  _s(useSendMessage, \"RizVWJpAYduNRSTrCs85QCm+z5k=\", false, function () {\n    return [useUpload.default];\n  });\n});","lineCount":150,"map":[[13,2,4,0,"exports"],[13,9,4,0],[13,10,4,0,"useSendMessage"],[13,24,4,0],[13,27,4,0,"useSendMessage"],[13,41,4,0],[14,2,1,0],[14,6,1,0,"_react"],[14,12,1,0],[14,15,1,0,"require"],[14,22,1,0],[14,23,1,0,"_dependencyMap"],[14,37,1,0],[15,2,2,0],[15,6,2,0,"_utilsUseUpload"],[15,21,2,0],[15,24,2,0,"require"],[15,31,2,0],[15,32,2,0,"_dependencyMap"],[15,46,2,0],[16,2,2,0],[16,6,2,0,"useUpload"],[16,15,2,0],[16,18,2,0,"_interopDefault"],[16,33,2,0],[16,34,2,0,"_utilsUseUpload"],[16,49,2,0],[17,2,4,7],[17,11,4,16,"useSendMessage"],[17,25,4,30,"useSendMessage"],[17,26,4,31,"matchId"],[17,33,4,38],[17,35,4,40,"user"],[17,39,4,44],[17,41,4,46,"setMessages"],[17,52,4,57],[17,54,4,59,"options"],[17,61,4,66],[17,63,4,68],[18,4,4,68,"_s"],[18,6,4,68],[19,4,5,2],[19,10,5,8,"onPaymentRequired"],[19,27,5,25],[19,30,5,28,"options"],[19,37,5,35],[19,39,5,37,"onPaymentRequired"],[19,56,5,54],[20,4,7,2],[20,10,7,8],[20,11,7,9,"inputText"],[20,20,7,18],[20,22,7,20,"setInputText"],[20,34,7,32],[20,35,7,33],[20,38,7,36],[20,42,7,36,"useState"],[20,48,7,44],[20,49,7,44,"useState"],[20,57,7,44],[20,59,7,45],[20,61,7,47],[20,62,7,48],[21,4,8,2],[21,10,8,8],[21,11,8,9,"sending"],[21,18,8,16],[21,20,8,18,"setSending"],[21,30,8,28],[21,31,8,29],[21,34,8,32],[21,38,8,32,"useState"],[21,44,8,40],[21,45,8,40,"useState"],[21,53,8,40],[21,55,8,41],[21,60,8,46],[21,61,8,47],[22,4,9,2],[22,10,9,8],[22,11,9,9,"voiceSending"],[22,23,9,21],[22,25,9,23,"setVoiceSending"],[22,40,9,38],[22,41,9,39],[22,44,9,42],[22,48,9,42,"useState"],[22,54,9,50],[22,55,9,50,"useState"],[22,63,9,50],[22,65,9,51],[22,70,9,56],[22,71,9,57],[24,4,11,2],[25,4,12,2],[25,10,12,8],[25,11,12,9,"replyTo"],[25,18,12,16],[25,20,12,18,"setReplyTo"],[25,30,12,28],[25,31,12,29],[25,34,12,32],[25,38,12,32,"useState"],[25,44,12,40],[25,45,12,40,"useState"],[25,53,12,40],[25,55,12,41],[25,59,12,45],[25,60,12,46],[26,4,14,2],[26,10,14,8],[26,11,14,9,"upload"],[26,17,14,15],[26,19,14,17],[27,6,14,19,"loading"],[27,13,14,26],[27,15,14,28,"uploadLoading"],[28,4,14,42],[28,5,14,43],[28,6,14,44],[28,9,14,47],[28,13,14,47,"useUpload"],[28,22,14,56],[28,23,14,56,"default"],[28,30,14,56],[28,32,14,57],[28,33,14,58],[29,4,16,2],[29,10,16,8,"clearReplyTo"],[29,22,16,20],[29,25,16,23],[29,29,16,23,"useCallback"],[29,35,16,34],[29,36,16,34,"useCallback"],[29,47,16,34],[29,49,16,35],[29,55,16,41],[30,6,17,4,"setReplyTo"],[30,16,17,14],[30,17,17,15],[30,21,17,19],[30,22,17,20],[31,4,18,2],[31,5,18,3],[31,7,18,5],[31,9,18,7],[31,10,18,8],[32,4,20,2],[32,10,20,8,"sendMessage"],[32,21,20,19],[32,24,20,22],[32,30,20,22,"sendMessage"],[32,31,20,22],[32,36,20,34],[33,6,21,4],[33,10,21,8],[33,11,21,9,"inputText"],[33,20,21,18],[33,21,21,19,"trim"],[33,25,21,23],[33,26,21,24],[33,27,21,25],[33,31,21,29],[33,32,21,30,"user"],[33,36,21,34],[33,40,21,38,"sending"],[33,47,21,45],[33,49,21,47],[34,6,23,4],[34,12,23,10,"messageText"],[34,23,23,21],[34,26,23,24,"inputText"],[34,35,23,33],[34,36,23,34,"trim"],[34,40,23,38],[34,41,23,39],[34,42,23,40],[35,6,24,4],[35,12,24,10,"repliedToMessageId"],[35,30,24,28],[35,33,24,31,"replyTo"],[35,40,24,38],[35,42,24,40,"id"],[35,44,24,42],[35,48,24,46],[35,52,24,50],[36,6,26,4,"setInputText"],[36,18,26,16],[36,19,26,17],[36,21,26,19],[36,22,26,20],[37,6,27,4,"setSending"],[37,16,27,14],[37,17,27,15],[37,21,27,19],[37,22,27,20],[38,6,29,4],[38,10,29,8],[39,8,30,6],[39,14,30,12,"response"],[39,22,30,20],[39,25,30,23],[39,31,30,29,"fetch"],[39,36,30,34],[39,37,30,35],[39,57,30,55],[39,59,30,57],[40,10,31,8,"method"],[40,16,31,14],[40,18,31,16],[40,24,31,22],[41,10,32,8,"headers"],[41,17,32,15],[41,19,32,17],[42,12,32,19],[42,26,32,33],[42,28,32,35],[43,10,32,54],[43,11,32,55],[44,10,33,8,"body"],[44,14,33,12],[44,16,33,14,"JSON"],[44,20,33,18],[44,21,33,19,"stringify"],[44,30,33,28],[44,31,33,29],[45,12,34,10,"matchId"],[45,19,34,17],[46,12,35,10,"senderId"],[46,20,35,18],[46,22,35,20,"user"],[46,26,35,24],[46,27,35,25,"id"],[46,29,35,27],[47,12,36,10,"messageText"],[47,23,36,21],[48,12,37,10,"repliedToMessageId"],[49,10,38,8],[49,11,38,9],[50,8,39,6],[50,9,39,7],[50,10,39,8],[51,8,41,6],[51,12,41,10],[51,13,41,11,"response"],[51,21,41,19],[51,22,41,20,"ok"],[51,24,41,22],[51,26,41,24],[52,10,42,8],[53,10,43,8],[53,14,43,12,"response"],[53,22,43,20],[53,23,43,21,"status"],[53,29,43,27],[53,34,43,32],[53,37,43,35],[53,39,43,37],[54,12,44,10,"setInputText"],[54,24,44,22],[54,25,44,23,"messageText"],[54,36,44,34],[54,37,44,35],[55,12,45,10],[55,16,45,14],[56,14,46,12,"onPaymentRequired"],[56,31,46,29],[56,34,46,32],[56,35,46,33],[57,12,47,10],[57,13,47,11],[57,14,47,12],[57,21,47,19,"e"],[57,22,47,20],[57,24,47,22],[58,14,48,12,"console"],[58,21,48,19],[58,22,48,20,"error"],[58,27,48,25],[58,28,48,26,"e"],[58,29,48,27],[58,30,48,28],[59,12,49,10],[60,12,50,10],[61,10,51,8],[62,10,53,8],[62,16,53,14,"text"],[62,20,53,18],[62,23,53,21],[62,29,53,27,"response"],[62,37,53,35],[62,38,53,36,"text"],[62,42,53,40],[62,43,53,41],[62,44,53,42],[62,45,53,43,"catch"],[62,50,53,48],[62,51,53,49],[62,57,53,55],[62,59,53,57],[62,60,53,58],[63,10,54,8],[63,16,54,14],[63,20,54,18,"Error"],[63,25,54,23],[63,26,55,10],[63,54,55,38,"response"],[63,62,55,46],[63,63,55,47,"status"],[63,69,55,53],[63,74,55,58,"response"],[63,82,55,66],[63,83,55,67,"statusText"],[63,93,55,77],[63,97,55,81,"text"],[63,101,55,85],[63,103,56,8],[63,104,56,9],[64,8,57,6],[65,8,59,6],[65,14,59,12,"data"],[65,18,59,16],[65,21,59,19],[65,27,59,25,"response"],[65,35,59,33],[65,36,59,34,"json"],[65,40,59,38],[65,41,59,39],[65,42,59,40],[66,8,60,6,"setMessages"],[66,19,60,17],[66,20,60,19,"prev"],[66,24,60,23],[66,28,60,28],[66,29,60,29],[66,32,60,32,"prev"],[66,36,60,36],[66,38,60,38,"data"],[66,42,60,42],[66,43,60,43,"message"],[66,50,60,50],[66,51,60,51],[66,52,60,52],[67,8,61,6,"clearReplyTo"],[67,20,61,18],[67,21,61,19],[67,22,61,20],[68,6,62,4],[68,7,62,5],[68,8,62,6],[68,15,62,13,"error"],[68,20,62,18],[68,22,62,20],[69,8,63,6,"console"],[69,15,63,13],[69,16,63,14,"error"],[69,21,63,19],[69,22,63,20],[69,46,63,44],[69,48,63,46,"error"],[69,53,63,51],[69,54,63,52],[70,8,64,6,"setInputText"],[70,20,64,18],[70,21,64,19,"messageText"],[70,32,64,30],[70,33,64,31],[71,6,65,4],[71,7,65,5],[71,16,65,14],[72,8,66,6,"setSending"],[72,18,66,16],[72,19,66,17],[72,24,66,22],[72,25,66,23],[73,6,67,4],[74,4,68,2],[74,5,68,3],[75,4,70,2],[75,10,70,8,"sendVoiceMemo"],[75,23,70,21],[75,26,70,24],[75,30,70,24,"useCallback"],[75,36,70,35],[75,37,70,35,"useCallback"],[75,48,70,35],[75,50,71,4],[75,57,71,11],[76,6,71,13,"uri"],[76,9,71,16],[77,6,71,18,"durationMs"],[78,4,71,29],[78,5,71,30],[78,10,71,35],[79,6,72,6],[79,10,72,10],[79,11,72,11,"user"],[79,15,72,15],[79,19,72,19,"voiceSending"],[79,31,72,31],[79,35,72,35,"uploadLoading"],[79,48,72,48],[79,50,72,50],[80,6,73,6],[80,10,73,10],[80,11,73,11,"uri"],[80,14,73,14],[80,18,73,18],[80,25,73,25,"uri"],[80,28,73,28],[80,33,73,33],[80,41,73,41],[80,43,73,43],[81,6,75,6],[81,12,75,12,"repliedToMessageId"],[81,30,75,30],[81,33,75,33,"replyTo"],[81,40,75,40],[81,42,75,42,"id"],[81,44,75,44],[81,48,75,48],[81,52,75,52],[82,6,77,6,"setVoiceSending"],[82,21,77,21],[82,22,77,22],[82,26,77,26],[82,27,77,27],[83,6,78,6],[83,10,78,10],[84,8,79,8],[84,14,79,14,"fileName"],[84,22,79,22],[84,25,79,25],[84,39,79,39,"Date"],[84,43,79,43],[84,44,79,44,"now"],[84,47,79,47],[84,48,79,48],[84,49,79,49],[84,55,79,55],[85,8,80,8],[85,14,80,14],[86,10,80,16,"url"],[86,13,80,19],[87,10,80,21,"error"],[88,8,80,27],[88,9,80,28],[88,12,80,31],[88,18,80,37,"upload"],[88,24,80,43],[88,25,80,44],[89,10,81,10,"reactNativeAsset"],[89,26,81,26],[89,28,81,28],[90,12,82,12,"uri"],[90,15,82,15],[91,12,83,12,"fileName"],[91,20,83,20],[92,12,84,12,"name"],[92,16,84,16],[92,18,84,18,"fileName"],[92,26,84,26],[93,12,85,12,"mimeType"],[93,20,85,20],[93,22,85,22],[94,10,86,10],[95,8,87,8],[95,9,87,9],[95,10,87,10],[96,8,89,8],[96,12,89,12,"error"],[96,17,89,17],[96,19,89,19],[97,10,90,10],[97,16,90,16],[97,20,90,20,"Error"],[97,25,90,25],[97,26,90,26,"error"],[97,31,90,31],[97,32,90,32],[98,8,91,8],[99,8,93,8],[99,14,93,14,"response"],[99,22,93,22],[99,25,93,25],[99,31,93,31,"fetch"],[99,36,93,36],[99,37,93,37],[99,57,93,57],[99,59,93,59],[100,10,94,10,"method"],[100,16,94,16],[100,18,94,18],[100,24,94,24],[101,10,95,10,"headers"],[101,17,95,17],[101,19,95,19],[102,12,95,21],[102,26,95,35],[102,28,95,37],[103,10,95,56],[103,11,95,57],[104,10,96,10,"body"],[104,14,96,14],[104,16,96,16,"JSON"],[104,20,96,20],[104,21,96,21,"stringify"],[104,30,96,30],[104,31,96,31],[105,12,97,12,"matchId"],[105,19,97,19],[106,12,98,12,"senderId"],[106,20,98,20],[106,22,98,22,"user"],[106,26,98,26],[106,27,98,27,"id"],[106,29,98,29],[107,12,99,12,"audioUrl"],[107,20,99,20],[107,22,99,22,"url"],[107,25,99,25],[108,12,100,12,"audioDurationMs"],[108,27,100,27],[108,29,100,29,"durationMs"],[108,39,100,39],[109,12,101,12,"repliedToMessageId"],[110,12,102,12],[111,10,103,10],[111,11,103,11],[112,8,104,8],[112,9,104,9],[112,10,104,10],[113,8,106,8],[113,12,106,12],[113,13,106,13,"response"],[113,21,106,21],[113,22,106,22,"ok"],[113,24,106,24],[113,26,106,26],[114,10,107,10],[115,10,108,10],[115,14,108,14,"response"],[115,22,108,22],[115,23,108,23,"status"],[115,29,108,29],[115,34,108,34],[115,37,108,37],[115,39,108,39],[116,12,109,12],[116,16,109,16],[117,14,110,14,"onPaymentRequired"],[117,31,110,31],[117,34,110,34],[117,35,110,35],[118,12,111,12],[118,13,111,13],[118,14,111,14],[118,21,111,21,"e"],[118,22,111,22],[118,24,111,24],[119,14,112,14,"console"],[119,21,112,21],[119,22,112,22,"error"],[119,27,112,27],[119,28,112,28,"e"],[119,29,112,29],[119,30,112,30],[120,12,113,12],[121,12,114,12],[122,10,115,10],[123,10,117,10],[123,16,117,16,"text"],[123,20,117,20],[123,23,117,23],[123,29,117,29,"response"],[123,37,117,37],[123,38,117,38,"text"],[123,42,117,42],[123,43,117,43],[123,44,117,44],[123,45,117,45,"catch"],[123,50,117,50],[123,51,117,51],[123,57,117,57],[123,59,117,59],[123,60,117,60],[124,10,118,10],[124,16,118,16],[124,20,118,20,"Error"],[124,25,118,25],[124,26,119,12],[124,57,119,43,"response"],[124,65,119,51],[124,66,119,52,"status"],[124,72,119,58],[124,77,119,63,"response"],[124,85,119,71],[124,86,119,72,"statusText"],[124,96,119,82],[124,100,119,86,"text"],[124,104,119,90],[124,106,120,10],[124,107,120,11],[125,8,121,8],[126,8,123,8],[126,14,123,14,"data"],[126,18,123,18],[126,21,123,21],[126,27,123,27,"response"],[126,35,123,35],[126,36,123,36,"json"],[126,40,123,40],[126,41,123,41],[126,42,123,42],[127,8,124,8,"setMessages"],[127,19,124,19],[127,20,124,21,"prev"],[127,24,124,25],[127,28,124,30],[127,29,124,31],[127,32,124,34,"prev"],[127,36,124,38],[127,38,124,40,"data"],[127,42,124,44],[127,43,124,45,"message"],[127,50,124,52],[127,51,124,53],[127,52,124,54],[128,8,125,8,"clearReplyTo"],[128,20,125,20],[128,21,125,21],[128,22,125,22],[129,6,126,6],[129,7,126,7],[129,8,126,8],[129,15,126,15,"error"],[129,20,126,20],[129,22,126,22],[130,8,127,8,"console"],[130,15,127,15],[130,16,127,16,"error"],[130,21,127,21],[130,22,127,22],[130,49,127,49],[130,51,127,51,"error"],[130,56,127,56],[130,57,127,57],[131,6,128,6],[131,7,128,7],[131,16,128,16],[132,8,129,8,"setVoiceSending"],[132,23,129,23],[132,24,129,24],[132,29,129,29],[132,30,129,30],[133,6,130,6],[134,4,131,4],[134,5,131,5],[134,7,132,4],[134,8,133,6,"matchId"],[134,15,133,13],[134,17,134,6,"onPaymentRequired"],[134,34,134,23],[134,36,135,6,"replyTo"],[134,43,135,13],[134,45,135,15,"id"],[134,47,135,17],[134,49,136,6,"upload"],[134,55,136,12],[134,57,137,6,"uploadLoading"],[134,70,137,19],[134,72,138,6,"user"],[134,76,138,10],[134,78,139,6,"voiceSending"],[134,90,139,18],[134,92,140,6,"setMessages"],[134,103,140,17],[134,105,141,6,"clearReplyTo"],[134,117,141,18],[134,118,143,2],[134,119,143,3],[135,4,145,2],[135,11,145,9],[136,6,146,4,"inputText"],[136,15,146,13],[137,6,147,4,"setInputText"],[137,18,147,16],[138,6,148,4,"sending"],[138,13,148,11],[139,6,149,4,"sendMessage"],[139,17,149,15],[140,6,150,4,"voiceSending"],[140,18,150,16],[141,6,151,4,"sendVoiceMemo"],[141,19,151,17],[142,6,152,4,"replyTo"],[142,13,152,11],[143,6,153,4,"setReplyTo"],[143,16,153,14],[144,6,154,4,"clearReplyTo"],[145,4,155,2],[145,5,155,3],[146,2,156,0],[147,2,156,1,"_s"],[147,4,156,1],[147,5,4,16,"useSendMessage"],[147,19,4,30],[148,4,4,30],[148,12,14,47,"useUpload"],[148,21,14,56],[148,22,14,56,"default"],[148,29,14,56],[149,2,14,56],[150,0,14,56],[150,3]],"functionMap":{"names":["<global>","useSendMessage","clearReplyTo","sendMessage","response.text._catch$argument_0","setMessages$argument_0","sendVoiceMemo"],"mappings":"AAA;OCG;mCCY;GDE;sBEE;iDCiC,QD;kBEO,iCF;GFQ;IKG;mDF8C,QE;oBDO,iCC;KLO;CDyB"},"hasCjsExports":false},"type":"js/module"}]}