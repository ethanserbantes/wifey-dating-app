{"dependencies":[{"name":"expo/virtual/env","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"dgHc21cgR+buKc7O3/dChhD5JJk=","exportNames":["*"],"imports":1}},{"name":"@babel/runtime/helpers/asyncToGenerator","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"YisBBiy2Xm9DEVdFebZ2nbgAHBo=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  exports.moderatePhoto = moderatePhoto;\n  exports.isDecisionAllowed = isDecisionAllowed;\n  var _expoVirtualEnv = require(_dependencyMap[0], \"expo/virtual/env\");\n  var _babelRuntimeHelpersAsyncToGenerator = require(_dependencyMap[1], \"@babel/runtime/helpers/asyncToGenerator\");\n  var _asyncToGenerator = _interopDefault(_babelRuntimeHelpersAsyncToGenerator);\n  function moderatePhoto(_x) {\n    return _moderatePhoto.apply(this, arguments);\n  }\n  function _moderatePhoto() {\n    _moderatePhoto = (0, _asyncToGenerator.default)(function* (_ref) {\n      var userId = _ref.userId,\n        imageUrl = _ref.imageUrl,\n        purpose = _ref.purpose;\n      var url = typeof imageUrl === \"string\" ? imageUrl.trim() : \"\";\n      if (!url) {\n        return {\n          ok: false,\n          error: \"Missing image url\"\n        };\n      }\n      try {\n        var baseURL = _expoVirtualEnv.env.EXPO_PUBLIC_BASE_URL || \"\";\n        var endpoint = baseURL ? `${baseURL}/api/moderation/photo` : \"/api/moderation/photo\";\n        var resp = yield fetch(endpoint, {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\"\n          },\n          body: JSON.stringify({\n            userId: Number.isFinite(Number(userId)) ? Number(userId) : null,\n            imageUrl: url,\n            purpose: purpose ? String(purpose) : null\n          })\n        });\n        if (!resp.ok) {\n          var extra = \"\";\n          try {\n            var j = yield resp.json();\n            if (j?.error) extra = String(j.error);\n          } catch {\n            // ignore\n          }\n          throw new Error(extra || `When calling /api/moderation/photo, the response was [${resp.status}] ${resp.statusText}`);\n        }\n        var json = yield resp.json();\n        return {\n          ok: true,\n          decision: json?.decision || null,\n          safeSearch: json?.safeSearch || null,\n          moderationSkipped: !!json?.moderationSkipped\n        };\n      } catch (e) {\n        console.error(\"[MODERATION] moderatePhoto error\", e);\n        return {\n          ok: false,\n          error: e?.message || \"Moderation failed\"\n        };\n      }\n    });\n    return _moderatePhoto.apply(this, arguments);\n  }\n  function isDecisionAllowed(decision) {\n    var moderationSkipped = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n    var purpose = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : null;\n    // If the server had to skip moderation (Vision API disabled / misconfigured),\n    // don't block the user during signup/profile edits.\n    if (moderationSkipped) {\n      return true;\n    }\n    var d = String(decision || \"\").toLowerCase();\n    var p = String(purpose || \"\").toLowerCase();\n\n    // By default we only allow \"approve\".\n    // BUT: SafeSearch false positives happen a lot for normal selfies/swimsuit/fashion.\n    // For our two user-facing flows, we allow \"review\" (it still gets recorded server-side).\n    var allowReview = p === \"profile_photo\" || p === \"verification_photo\";\n    if (d === \"approve\") {\n      return true;\n    }\n    if (allowReview && d === \"review\") {\n      return true;\n    }\n    return false;\n  }\n});","lineCount":96,"map":[[12,2,1,0,"exports"],[12,9,1,0],[12,10,1,0,"moderatePhoto"],[12,23,1,0],[12,26,1,0,"moderatePhoto"],[12,39,1,0],[13,2,49,0,"exports"],[13,9,49,0],[13,10,49,0,"isDecisionAllowed"],[13,27,49,0],[13,30,49,0,"isDecisionAllowed"],[13,47,49,0],[14,2,77,1],[14,6,77,1,"_expoVirtualEnv"],[14,21,77,1],[14,24,77,1,"require"],[14,31,77,1],[14,32,77,1,"_dependencyMap"],[14,46,77,1],[15,2,77,1],[15,6,77,1,"_babelRuntimeHelpersAsyncToGenerator"],[15,42,77,1],[15,45,77,1,"require"],[15,52,77,1],[15,53,77,1,"_dependencyMap"],[15,67,77,1],[16,2,77,1],[16,6,77,1,"_asyncToGenerator"],[16,23,77,1],[16,26,77,1,"_interopDefault"],[16,41,77,1],[16,42,77,1,"_babelRuntimeHelpersAsyncToGenerator"],[16,78,77,1],[17,2,77,1],[17,11,1,22,"moderatePhoto"],[17,24,1,35,"moderatePhoto"],[17,25,1,35,"_x"],[17,27,1,35],[18,4,1,35],[18,11,1,35,"_moderatePhoto"],[18,25,1,35],[18,26,1,35,"apply"],[18,31,1,35],[18,38,1,35,"arguments"],[18,47,1,35],[19,2,1,35],[20,2,1,35],[20,11,1,35,"_moderatePhoto"],[20,26,1,35],[21,4,1,35,"_moderatePhoto"],[21,18,1,35],[21,25,1,35,"_asyncToGenerator"],[21,42,1,35],[21,43,1,35,"default"],[21,50,1,35],[21,52,1,7],[21,63,1,7,"_ref"],[21,67,1,7],[21,69,1,67],[22,6,1,67],[22,10,1,38,"userId"],[22,16,1,44],[22,19,1,44,"_ref"],[22,23,1,44],[22,24,1,38,"userId"],[22,30,1,44],[23,8,1,46,"imageUrl"],[23,16,1,54],[23,19,1,54,"_ref"],[23,23,1,54],[23,24,1,46,"imageUrl"],[23,32,1,54],[24,8,1,56,"purpose"],[24,15,1,63],[24,18,1,63,"_ref"],[24,22,1,63],[24,23,1,56,"purpose"],[24,30,1,63],[25,6,2,2],[25,10,2,8,"url"],[25,13,2,11],[25,16,2,14],[25,23,2,21,"imageUrl"],[25,31,2,29],[25,36,2,34],[25,44,2,42],[25,47,2,45,"imageUrl"],[25,55,2,53],[25,56,2,54,"trim"],[25,60,2,58],[25,61,2,59],[25,62,2,60],[25,65,2,63],[25,67,2,65],[26,6,3,2],[26,10,3,6],[26,11,3,7,"url"],[26,14,3,10],[26,16,3,12],[27,8,4,4],[27,15,4,11],[28,10,4,13,"ok"],[28,12,4,15],[28,14,4,17],[28,19,4,22],[29,10,4,24,"error"],[29,15,4,29],[29,17,4,31],[30,8,4,51],[30,9,4,52],[31,6,5,2],[32,6,7,2],[32,10,7,6],[33,8,8,4],[33,12,8,10,"baseURL"],[33,19,8,17],[33,22,8,20,"_expoVirtualEnv"],[33,37,8,20],[33,38,8,20,"env"],[33,41,8,20],[33,42,8,20,"EXPO_PUBLIC_BASE_URL"],[33,62,8,20],[33,66,8,56],[33,68,8,58],[34,8,9,4],[34,12,9,10,"endpoint"],[34,20,9,18],[34,23,9,21,"baseURL"],[34,30,9,28],[34,33,9,31],[34,36,9,34,"baseURL"],[34,43,9,41],[34,66,9,64],[34,69,9,67],[34,92,9,90],[35,8,11,4],[35,12,11,10,"resp"],[35,16,11,14],[35,25,11,23,"fetch"],[35,30,11,28],[35,31,11,29,"endpoint"],[35,39,11,37],[35,41,11,39],[36,10,12,6,"method"],[36,16,12,12],[36,18,12,14],[36,24,12,20],[37,10,13,6,"headers"],[37,17,13,13],[37,19,13,15],[38,12,13,17],[38,26,13,31],[38,28,13,33],[39,10,13,52],[39,11,13,53],[40,10,14,6,"body"],[40,14,14,10],[40,16,14,12,"JSON"],[40,20,14,16],[40,21,14,17,"stringify"],[40,30,14,26],[40,31,14,27],[41,12,15,8,"userId"],[41,18,15,14],[41,20,15,16,"Number"],[41,26,15,22],[41,27,15,23,"isFinite"],[41,35,15,31],[41,36,15,32,"Number"],[41,42,15,38],[41,43,15,39,"userId"],[41,49,15,45],[41,50,15,46],[41,51,15,47],[41,54,15,50,"Number"],[41,60,15,56],[41,61,15,57,"userId"],[41,67,15,63],[41,68,15,64],[41,71,15,67],[41,75,15,71],[42,12,16,8,"imageUrl"],[42,20,16,16],[42,22,16,18,"url"],[42,25,16,21],[43,12,17,8,"purpose"],[43,19,17,15],[43,21,17,17,"purpose"],[43,28,17,24],[43,31,17,27,"String"],[43,37,17,33],[43,38,17,34,"purpose"],[43,45,17,41],[43,46,17,42],[43,49,17,45],[44,10,18,6],[44,11,18,7],[45,8,19,4],[45,9,19,5],[45,10,19,6],[46,8,21,4],[46,12,21,8],[46,13,21,9,"resp"],[46,17,21,13],[46,18,21,14,"ok"],[46,20,21,16],[46,22,21,18],[47,10,22,6],[47,14,22,10,"extra"],[47,19,22,15],[47,22,22,18],[47,24,22,20],[48,10,23,6],[48,14,23,10],[49,12,24,8],[49,16,24,14,"j"],[49,17,24,15],[49,26,24,24,"resp"],[49,30,24,28],[49,31,24,29,"json"],[49,35,24,33],[49,36,24,34],[49,37,24,35],[50,12,25,8],[50,16,25,12,"j"],[50,17,25,13],[50,19,25,15,"error"],[50,24,25,20],[50,26,25,22,"extra"],[50,31,25,27],[50,34,25,30,"String"],[50,40,25,36],[50,41,25,37,"j"],[50,42,25,38],[50,43,25,39,"error"],[50,48,25,44],[50,49,25,45],[51,10,26,6],[51,11,26,7],[51,12,26,8],[51,18,26,14],[52,12,27,8],[53,10,27,8],[54,10,30,6],[54,16,30,12],[54,20,30,16,"Error"],[54,25,30,21],[54,26,31,8,"extra"],[54,31,31,13],[54,35,32,10],[54,92,32,67,"resp"],[54,96,32,71],[54,97,32,72,"status"],[54,103,32,78],[54,108,32,83,"resp"],[54,112,32,87],[54,113,32,88,"statusText"],[54,123,32,98],[54,125,33,6],[54,126,33,7],[55,8,34,4],[56,8,36,4],[56,12,36,10,"json"],[56,16,36,14],[56,25,36,23,"resp"],[56,29,36,27],[56,30,36,28,"json"],[56,34,36,32],[56,35,36,33],[56,36,36,34],[57,8,37,4],[57,15,37,11],[58,10,38,6,"ok"],[58,12,38,8],[58,14,38,10],[58,18,38,14],[59,10,39,6,"decision"],[59,18,39,14],[59,20,39,16,"json"],[59,24,39,20],[59,26,39,22,"decision"],[59,34,39,30],[59,38,39,34],[59,42,39,38],[60,10,40,6,"safeSearch"],[60,20,40,16],[60,22,40,18,"json"],[60,26,40,22],[60,28,40,24,"safeSearch"],[60,38,40,34],[60,42,40,38],[60,46,40,42],[61,10,41,6,"moderationSkipped"],[61,27,41,23],[61,29,41,25],[61,30,41,26],[61,31,41,27,"json"],[61,35,41,31],[61,37,41,33,"moderationSkipped"],[62,8,42,4],[62,9,42,5],[63,6,43,2],[63,7,43,3],[63,8,43,4],[63,15,43,11,"e"],[63,16,43,12],[63,18,43,14],[64,8,44,4,"console"],[64,15,44,11],[64,16,44,12,"error"],[64,21,44,17],[64,22,44,18],[64,56,44,52],[64,58,44,54,"e"],[64,59,44,55],[64,60,44,56],[65,8,45,4],[65,15,45,11],[66,10,45,13,"ok"],[66,12,45,15],[66,14,45,17],[66,19,45,22],[67,10,45,24,"error"],[67,15,45,29],[67,17,45,31,"e"],[67,18,45,32],[67,20,45,34,"message"],[67,27,45,41],[67,31,45,45],[68,8,45,65],[68,9,45,66],[69,6,46,2],[70,4,47,0],[70,5,47,1],[71,4,47,1],[71,11,47,1,"_moderatePhoto"],[71,25,47,1],[71,26,47,1,"apply"],[71,31,47,1],[71,38,47,1,"arguments"],[71,47,47,1],[72,2,47,1],[73,2,49,7],[73,11,49,16,"isDecisionAllowed"],[73,28,49,33,"isDecisionAllowed"],[73,29,50,2,"decision"],[73,37,50,10],[73,39,53,2],[74,4,53,2],[74,8,51,2,"moderationSkipped"],[74,25,51,19],[74,28,51,19,"arguments"],[74,37,51,19],[74,38,51,19,"length"],[74,44,51,19],[74,52,51,19,"arguments"],[74,61,51,19],[74,69,51,19,"undefined"],[74,78,51,19],[74,81,51,19,"arguments"],[74,90,51,19],[74,96,51,22],[74,101,51,27],[75,4,51,27],[75,8,52,2,"purpose"],[75,15,52,9],[75,18,52,9,"arguments"],[75,27,52,9],[75,28,52,9,"length"],[75,34,52,9],[75,42,52,9,"arguments"],[75,51,52,9],[75,59,52,9,"undefined"],[75,68,52,9],[75,71,52,9,"arguments"],[75,80,52,9],[75,86,52,12],[75,90,52,16],[76,4,54,2],[77,4,55,2],[78,4,56,2],[78,8,56,6,"moderationSkipped"],[78,25,56,23],[78,27,56,25],[79,6,57,4],[79,13,57,11],[79,17,57,15],[80,4,58,2],[81,4,60,2],[81,8,60,8,"d"],[81,9,60,9],[81,12,60,12,"String"],[81,18,60,18],[81,19,60,19,"decision"],[81,27,60,27],[81,31,60,31],[81,33,60,33],[81,34,60,34],[81,35,60,35,"toLowerCase"],[81,46,60,46],[81,47,60,47],[81,48,60,48],[82,4,61,2],[82,8,61,8,"p"],[82,9,61,9],[82,12,61,12,"String"],[82,18,61,18],[82,19,61,19,"purpose"],[82,26,61,26],[82,30,61,30],[82,32,61,32],[82,33,61,33],[82,34,61,34,"toLowerCase"],[82,45,61,45],[82,46,61,46],[82,47,61,47],[84,4,63,2],[85,4,64,2],[86,4,65,2],[87,4,66,2],[87,8,66,8,"allowReview"],[87,19,66,19],[87,22,66,22,"p"],[87,23,66,23],[87,28,66,28],[87,43,66,43],[87,47,66,47,"p"],[87,48,66,48],[87,53,66,53],[87,73,66,73],[88,4,68,2],[88,8,68,6,"d"],[88,9,68,7],[88,14,68,12],[88,23,68,21],[88,25,68,23],[89,6,69,4],[89,13,69,11],[89,17,69,15],[90,4,70,2],[91,4,72,2],[91,8,72,6,"allowReview"],[91,19,72,17],[91,23,72,21,"d"],[91,24,72,22],[91,29,72,27],[91,37,72,35],[91,39,72,37],[92,6,73,4],[92,13,73,11],[92,17,73,15],[93,4,74,2],[94,4,76,2],[94,11,76,9],[94,16,76,14],[95,2,77,0],[96,0,77,1],[96,3]],"functionMap":{"names":["<global>","moderatePhoto","isDecisionAllowed"],"mappings":"AAA,OC;CD8C;OEE;CF4B"},"hasCjsExports":false},"type":"js/module"}]}