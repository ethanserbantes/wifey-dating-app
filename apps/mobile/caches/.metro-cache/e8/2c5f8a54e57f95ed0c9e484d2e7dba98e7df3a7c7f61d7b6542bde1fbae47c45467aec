{"dependencies":[{"name":"@babel/runtime/helpers/asyncToGenerator","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"YisBBiy2Xm9DEVdFebZ2nbgAHBo=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  exports.moderatePhoto = moderatePhoto;\n  exports.isDecisionAllowed = isDecisionAllowed;\n  var _babelRuntimeHelpersAsyncToGenerator = require(_dependencyMap[0], \"@babel/runtime/helpers/asyncToGenerator\");\n  var _asyncToGenerator = _interopDefault(_babelRuntimeHelpersAsyncToGenerator);\n  function moderatePhoto(_x) {\n    return _moderatePhoto.apply(this, arguments);\n  }\n  function _moderatePhoto() {\n    _moderatePhoto = (0, _asyncToGenerator.default)(function* (_ref) {\n      var userId = _ref.userId,\n        imageUrl = _ref.imageUrl,\n        purpose = _ref.purpose;\n      var url = typeof imageUrl === \"string\" ? imageUrl.trim() : \"\";\n      if (!url) {\n        return {\n          ok: false,\n          error: \"Missing image url\"\n        };\n      }\n      try {\n        var resp = yield fetch(\"/api/moderation/photo\", {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\"\n          },\n          body: JSON.stringify({\n            userId: Number.isFinite(Number(userId)) ? Number(userId) : null,\n            imageUrl: url,\n            purpose: purpose ? String(purpose) : null\n          })\n        });\n        if (!resp.ok) {\n          var extra = \"\";\n          try {\n            var j = yield resp.json();\n            if (j?.error) extra = String(j.error);\n          } catch {\n            // ignore\n          }\n          throw new Error(extra || `When calling /api/moderation/photo, the response was [${resp.status}] ${resp.statusText}`);\n        }\n        var json = yield resp.json();\n        return {\n          ok: true,\n          decision: json?.decision || null,\n          safeSearch: json?.safeSearch || null,\n          moderationSkipped: !!json?.moderationSkipped\n        };\n      } catch (e) {\n        console.error(\"[MODERATION] moderatePhoto error\", e);\n        return {\n          ok: false,\n          error: e?.message || \"Moderation failed\"\n        };\n      }\n    });\n    return _moderatePhoto.apply(this, arguments);\n  }\n  function isDecisionAllowed(decision) {\n    var moderationSkipped = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n    var purpose = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : null;\n    // If the server had to skip moderation (Vision API disabled / misconfigured),\n    // don't block the user during signup/profile edits.\n    if (moderationSkipped) {\n      return true;\n    }\n    var d = String(decision || \"\").toLowerCase();\n    var p = String(purpose || \"\").toLowerCase();\n\n    // By default we only allow \"approve\".\n    // BUT: SafeSearch false positives happen a lot for normal selfies/swimsuit/fashion.\n    // For our two user-facing flows, we allow \"review\" (it still gets recorded server-side).\n    var allowReview = p === \"profile_photo\" || p === \"verification_photo\";\n    if (d === \"approve\") {\n      return true;\n    }\n    if (allowReview && d === \"review\") {\n      return true;\n    }\n    return false;\n  }\n});","lineCount":93,"map":[[12,2,1,0,"exports"],[12,9,1,0],[12,10,1,0,"moderatePhoto"],[12,23,1,0],[12,26,1,0,"moderatePhoto"],[12,39,1,0],[13,2,46,0,"exports"],[13,9,46,0],[13,10,46,0,"isDecisionAllowed"],[13,27,46,0],[13,30,46,0,"isDecisionAllowed"],[13,47,46,0],[14,2,74,1],[14,6,74,1,"_babelRuntimeHelpersAsyncToGenerator"],[14,42,74,1],[14,45,74,1,"require"],[14,52,74,1],[14,53,74,1,"_dependencyMap"],[14,67,74,1],[15,2,74,1],[15,6,74,1,"_asyncToGenerator"],[15,23,74,1],[15,26,74,1,"_interopDefault"],[15,41,74,1],[15,42,74,1,"_babelRuntimeHelpersAsyncToGenerator"],[15,78,74,1],[16,2,74,1],[16,11,1,22,"moderatePhoto"],[16,24,1,35,"moderatePhoto"],[16,25,1,35,"_x"],[16,27,1,35],[17,4,1,35],[17,11,1,35,"_moderatePhoto"],[17,25,1,35],[17,26,1,35,"apply"],[17,31,1,35],[17,38,1,35,"arguments"],[17,47,1,35],[18,2,1,35],[19,2,1,35],[19,11,1,35,"_moderatePhoto"],[19,26,1,35],[20,4,1,35,"_moderatePhoto"],[20,18,1,35],[20,25,1,35,"_asyncToGenerator"],[20,42,1,35],[20,43,1,35,"default"],[20,50,1,35],[20,52,1,7],[20,63,1,7,"_ref"],[20,67,1,7],[20,69,1,67],[21,6,1,67],[21,10,1,38,"userId"],[21,16,1,44],[21,19,1,44,"_ref"],[21,23,1,44],[21,24,1,38,"userId"],[21,30,1,44],[22,8,1,46,"imageUrl"],[22,16,1,54],[22,19,1,54,"_ref"],[22,23,1,54],[22,24,1,46,"imageUrl"],[22,32,1,54],[23,8,1,56,"purpose"],[23,15,1,63],[23,18,1,63,"_ref"],[23,22,1,63],[23,23,1,56,"purpose"],[23,30,1,63],[24,6,2,2],[24,10,2,8,"url"],[24,13,2,11],[24,16,2,14],[24,23,2,21,"imageUrl"],[24,31,2,29],[24,36,2,34],[24,44,2,42],[24,47,2,45,"imageUrl"],[24,55,2,53],[24,56,2,54,"trim"],[24,60,2,58],[24,61,2,59],[24,62,2,60],[24,65,2,63],[24,67,2,65],[25,6,3,2],[25,10,3,6],[25,11,3,7,"url"],[25,14,3,10],[25,16,3,12],[26,8,4,4],[26,15,4,11],[27,10,4,13,"ok"],[27,12,4,15],[27,14,4,17],[27,19,4,22],[28,10,4,24,"error"],[28,15,4,29],[28,17,4,31],[29,8,4,51],[29,9,4,52],[30,6,5,2],[31,6,7,2],[31,10,7,6],[32,8,8,4],[32,12,8,10,"resp"],[32,16,8,14],[32,25,8,23,"fetch"],[32,30,8,28],[32,31,8,29],[32,54,8,52],[32,56,8,54],[33,10,9,6,"method"],[33,16,9,12],[33,18,9,14],[33,24,9,20],[34,10,10,6,"headers"],[34,17,10,13],[34,19,10,15],[35,12,10,17],[35,26,10,31],[35,28,10,33],[36,10,10,52],[36,11,10,53],[37,10,11,6,"body"],[37,14,11,10],[37,16,11,12,"JSON"],[37,20,11,16],[37,21,11,17,"stringify"],[37,30,11,26],[37,31,11,27],[38,12,12,8,"userId"],[38,18,12,14],[38,20,12,16,"Number"],[38,26,12,22],[38,27,12,23,"isFinite"],[38,35,12,31],[38,36,12,32,"Number"],[38,42,12,38],[38,43,12,39,"userId"],[38,49,12,45],[38,50,12,46],[38,51,12,47],[38,54,12,50,"Number"],[38,60,12,56],[38,61,12,57,"userId"],[38,67,12,63],[38,68,12,64],[38,71,12,67],[38,75,12,71],[39,12,13,8,"imageUrl"],[39,20,13,16],[39,22,13,18,"url"],[39,25,13,21],[40,12,14,8,"purpose"],[40,19,14,15],[40,21,14,17,"purpose"],[40,28,14,24],[40,31,14,27,"String"],[40,37,14,33],[40,38,14,34,"purpose"],[40,45,14,41],[40,46,14,42],[40,49,14,45],[41,10,15,6],[41,11,15,7],[42,8,16,4],[42,9,16,5],[42,10,16,6],[43,8,18,4],[43,12,18,8],[43,13,18,9,"resp"],[43,17,18,13],[43,18,18,14,"ok"],[43,20,18,16],[43,22,18,18],[44,10,19,6],[44,14,19,10,"extra"],[44,19,19,15],[44,22,19,18],[44,24,19,20],[45,10,20,6],[45,14,20,10],[46,12,21,8],[46,16,21,14,"j"],[46,17,21,15],[46,26,21,24,"resp"],[46,30,21,28],[46,31,21,29,"json"],[46,35,21,33],[46,36,21,34],[46,37,21,35],[47,12,22,8],[47,16,22,12,"j"],[47,17,22,13],[47,19,22,15,"error"],[47,24,22,20],[47,26,22,22,"extra"],[47,31,22,27],[47,34,22,30,"String"],[47,40,22,36],[47,41,22,37,"j"],[47,42,22,38],[47,43,22,39,"error"],[47,48,22,44],[47,49,22,45],[48,10,23,6],[48,11,23,7],[48,12,23,8],[48,18,23,14],[49,12,24,8],[50,10,24,8],[51,10,27,6],[51,16,27,12],[51,20,27,16,"Error"],[51,25,27,21],[51,26,28,8,"extra"],[51,31,28,13],[51,35,29,10],[51,92,29,67,"resp"],[51,96,29,71],[51,97,29,72,"status"],[51,103,29,78],[51,108,29,83,"resp"],[51,112,29,87],[51,113,29,88,"statusText"],[51,123,29,98],[51,125,30,6],[51,126,30,7],[52,8,31,4],[53,8,33,4],[53,12,33,10,"json"],[53,16,33,14],[53,25,33,23,"resp"],[53,29,33,27],[53,30,33,28,"json"],[53,34,33,32],[53,35,33,33],[53,36,33,34],[54,8,34,4],[54,15,34,11],[55,10,35,6,"ok"],[55,12,35,8],[55,14,35,10],[55,18,35,14],[56,10,36,6,"decision"],[56,18,36,14],[56,20,36,16,"json"],[56,24,36,20],[56,26,36,22,"decision"],[56,34,36,30],[56,38,36,34],[56,42,36,38],[57,10,37,6,"safeSearch"],[57,20,37,16],[57,22,37,18,"json"],[57,26,37,22],[57,28,37,24,"safeSearch"],[57,38,37,34],[57,42,37,38],[57,46,37,42],[58,10,38,6,"moderationSkipped"],[58,27,38,23],[58,29,38,25],[58,30,38,26],[58,31,38,27,"json"],[58,35,38,31],[58,37,38,33,"moderationSkipped"],[59,8,39,4],[59,9,39,5],[60,6,40,2],[60,7,40,3],[60,8,40,4],[60,15,40,11,"e"],[60,16,40,12],[60,18,40,14],[61,8,41,4,"console"],[61,15,41,11],[61,16,41,12,"error"],[61,21,41,17],[61,22,41,18],[61,56,41,52],[61,58,41,54,"e"],[61,59,41,55],[61,60,41,56],[62,8,42,4],[62,15,42,11],[63,10,42,13,"ok"],[63,12,42,15],[63,14,42,17],[63,19,42,22],[64,10,42,24,"error"],[64,15,42,29],[64,17,42,31,"e"],[64,18,42,32],[64,20,42,34,"message"],[64,27,42,41],[64,31,42,45],[65,8,42,65],[65,9,42,66],[66,6,43,2],[67,4,44,0],[67,5,44,1],[68,4,44,1],[68,11,44,1,"_moderatePhoto"],[68,25,44,1],[68,26,44,1,"apply"],[68,31,44,1],[68,38,44,1,"arguments"],[68,47,44,1],[69,2,44,1],[70,2,46,7],[70,11,46,16,"isDecisionAllowed"],[70,28,46,33,"isDecisionAllowed"],[70,29,47,2,"decision"],[70,37,47,10],[70,39,50,2],[71,4,50,2],[71,8,48,2,"moderationSkipped"],[71,25,48,19],[71,28,48,19,"arguments"],[71,37,48,19],[71,38,48,19,"length"],[71,44,48,19],[71,52,48,19,"arguments"],[71,61,48,19],[71,69,48,19,"undefined"],[71,78,48,19],[71,81,48,19,"arguments"],[71,90,48,19],[71,96,48,22],[71,101,48,27],[72,4,48,27],[72,8,49,2,"purpose"],[72,15,49,9],[72,18,49,9,"arguments"],[72,27,49,9],[72,28,49,9,"length"],[72,34,49,9],[72,42,49,9,"arguments"],[72,51,49,9],[72,59,49,9,"undefined"],[72,68,49,9],[72,71,49,9,"arguments"],[72,80,49,9],[72,86,49,12],[72,90,49,16],[73,4,51,2],[74,4,52,2],[75,4,53,2],[75,8,53,6,"moderationSkipped"],[75,25,53,23],[75,27,53,25],[76,6,54,4],[76,13,54,11],[76,17,54,15],[77,4,55,2],[78,4,57,2],[78,8,57,8,"d"],[78,9,57,9],[78,12,57,12,"String"],[78,18,57,18],[78,19,57,19,"decision"],[78,27,57,27],[78,31,57,31],[78,33,57,33],[78,34,57,34],[78,35,57,35,"toLowerCase"],[78,46,57,46],[78,47,57,47],[78,48,57,48],[79,4,58,2],[79,8,58,8,"p"],[79,9,58,9],[79,12,58,12,"String"],[79,18,58,18],[79,19,58,19,"purpose"],[79,26,58,26],[79,30,58,30],[79,32,58,32],[79,33,58,33],[79,34,58,34,"toLowerCase"],[79,45,58,45],[79,46,58,46],[79,47,58,47],[81,4,60,2],[82,4,61,2],[83,4,62,2],[84,4,63,2],[84,8,63,8,"allowReview"],[84,19,63,19],[84,22,63,22,"p"],[84,23,63,23],[84,28,63,28],[84,43,63,43],[84,47,63,47,"p"],[84,48,63,48],[84,53,63,53],[84,73,63,73],[85,4,65,2],[85,8,65,6,"d"],[85,9,65,7],[85,14,65,12],[85,23,65,21],[85,25,65,23],[86,6,66,4],[86,13,66,11],[86,17,66,15],[87,4,67,2],[88,4,69,2],[88,8,69,6,"allowReview"],[88,19,69,17],[88,23,69,21,"d"],[88,24,69,22],[88,29,69,27],[88,37,69,35],[88,39,69,37],[89,6,70,4],[89,13,70,11],[89,17,70,15],[90,4,71,2],[91,4,73,2],[91,11,73,9],[91,16,73,14],[92,2,74,0],[93,0,74,1],[93,3]],"functionMap":{"names":["<global>","moderatePhoto","isDecisionAllowed"],"mappings":"AAA,OC;CD2C;OEE;CF4B"},"hasCjsExports":false},"type":"js/module"}]}