{"dependencies":[{"name":"react","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":46,"index":46}}],"key":"RtGiGa+/H7VrI7GDQDLhO1UbpU8=","exportNames":["*"],"imports":1}},{"name":"@/utils/useUpload","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":47},"end":{"line":2,"column":42,"index":89}}],"key":"fmgUBhSYAJBo9LhumboFTPrCXjE=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  exports.useSendMessage = useSendMessage;\n  var _react = require(_dependencyMap[0], \"react\");\n  var _utilsUseUpload = require(_dependencyMap[1], \"@/utils/useUpload\");\n  var useUpload = _interopDefault(_utilsUseUpload);\n  function useSendMessage(matchId, user, setMessages, options) {\n    const onPaymentRequired = options?.onPaymentRequired;\n    const [inputText, setInputText] = (0, _react.useState)(\"\");\n    const [sending, setSending] = (0, _react.useState)(false);\n    const [voiceSending, setVoiceSending] = (0, _react.useState)(false);\n\n    // NEW: reply-to state\n    const [replyTo, setReplyTo] = (0, _react.useState)(null);\n    const [upload, {\n      loading: uploadLoading\n    }] = (0, useUpload.default)();\n    const clearReplyTo = (0, _react.useCallback)(() => {\n      setReplyTo(null);\n    }, []);\n    const sendMessage = async () => {\n      if (!inputText.trim() || !user || sending) return;\n      const messageText = inputText.trim();\n      const repliedToMessageId = replyTo?.id ?? null;\n      setInputText(\"\");\n      setSending(true);\n      try {\n        const response = await fetch(\"/api/messages/send\", {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\"\n          },\n          body: JSON.stringify({\n            matchId,\n            senderId: user.id,\n            messageText,\n            repliedToMessageId\n          })\n        });\n        if (!response.ok) {\n          // payment required -> open the date credit sheet and keep the draft.\n          if (response.status === 402) {\n            setInputText(messageText);\n            try {\n              onPaymentRequired?.();\n            } catch (e) {\n              console.error(e);\n            }\n            return;\n          }\n          const text = await response.text().catch(() => \"\");\n          throw new Error(`Failed to send message: [${response.status}] ${response.statusText} ${text}`);\n        }\n        const data = await response.json();\n        setMessages(prev => [...prev, data.message]);\n        clearReplyTo();\n      } catch (error) {\n        console.error(\"Error sending message:\", error);\n        setInputText(messageText);\n      } finally {\n        setSending(false);\n      }\n    };\n    const sendVoiceMemo = (0, _react.useCallback)(async ({\n      uri,\n      durationMs\n    }) => {\n      if (!user || voiceSending || uploadLoading) return;\n      if (!uri || typeof uri !== \"string\") return;\n      const repliedToMessageId = replyTo?.id ?? null;\n      setVoiceSending(true);\n      try {\n        const fileName = `voice-memo-${Date.now()}.m4a`;\n        const {\n          url,\n          error\n        } = await upload({\n          reactNativeAsset: {\n            uri,\n            fileName,\n            name: fileName,\n            mimeType: \"audio/m4a\"\n          }\n        });\n        if (error) {\n          throw new Error(error);\n        }\n        const response = await fetch(\"/api/messages/send\", {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\"\n          },\n          body: JSON.stringify({\n            matchId,\n            senderId: user.id,\n            audioUrl: url,\n            audioDurationMs: durationMs,\n            repliedToMessageId\n            // messageText intentionally omitted\n          })\n        });\n        if (!response.ok) {\n          // payment required -> open the date credit sheet.\n          if (response.status === 402) {\n            try {\n              onPaymentRequired?.();\n            } catch (e) {\n              console.error(e);\n            }\n            return;\n          }\n          const text = await response.text().catch(() => \"\");\n          throw new Error(`Failed to send voice memo: [${response.status}] ${response.statusText} ${text}`);\n        }\n        const data = await response.json();\n        setMessages(prev => [...prev, data.message]);\n        clearReplyTo();\n      } catch (error) {\n        console.error(\"Error sending voice memo:\", error);\n      } finally {\n        setVoiceSending(false);\n      }\n    }, [matchId, onPaymentRequired, replyTo?.id, upload, uploadLoading, user, voiceSending, setMessages, clearReplyTo]);\n    return {\n      inputText,\n      setInputText,\n      sending,\n      sendMessage,\n      voiceSending,\n      sendVoiceMemo,\n      replyTo,\n      setReplyTo,\n      clearReplyTo\n    };\n  }\n});","lineCount":145,"map":[[12,2,4,0,"exports"],[12,9,4,0],[12,10,4,0,"useSendMessage"],[12,24,4,0],[12,27,4,0,"useSendMessage"],[12,41,4,0],[13,2,1,0],[13,6,1,0,"_react"],[13,12,1,0],[13,15,1,0,"require"],[13,22,1,0],[13,23,1,0,"_dependencyMap"],[13,37,1,0],[14,2,2,0],[14,6,2,0,"_utilsUseUpload"],[14,21,2,0],[14,24,2,0,"require"],[14,31,2,0],[14,32,2,0,"_dependencyMap"],[14,46,2,0],[15,2,2,0],[15,6,2,0,"useUpload"],[15,15,2,0],[15,18,2,0,"_interopDefault"],[15,33,2,0],[15,34,2,0,"_utilsUseUpload"],[15,49,2,0],[16,2,4,7],[16,11,4,16,"useSendMessage"],[16,25,4,30,"useSendMessage"],[16,26,4,31,"matchId"],[16,33,4,38],[16,35,4,40,"user"],[16,39,4,44],[16,41,4,46,"setMessages"],[16,52,4,57],[16,54,4,59,"options"],[16,61,4,66],[16,63,4,68],[17,4,5,2],[17,10,5,8,"onPaymentRequired"],[17,27,5,25],[17,30,5,28,"options"],[17,37,5,35],[17,39,5,37,"onPaymentRequired"],[17,56,5,54],[18,4,7,2],[18,10,7,8],[18,11,7,9,"inputText"],[18,20,7,18],[18,22,7,20,"setInputText"],[18,34,7,32],[18,35,7,33],[18,38,7,36],[18,42,7,36,"useState"],[18,48,7,44],[18,49,7,44,"useState"],[18,57,7,44],[18,59,7,45],[18,61,7,47],[18,62,7,48],[19,4,8,2],[19,10,8,8],[19,11,8,9,"sending"],[19,18,8,16],[19,20,8,18,"setSending"],[19,30,8,28],[19,31,8,29],[19,34,8,32],[19,38,8,32,"useState"],[19,44,8,40],[19,45,8,40,"useState"],[19,53,8,40],[19,55,8,41],[19,60,8,46],[19,61,8,47],[20,4,9,2],[20,10,9,8],[20,11,9,9,"voiceSending"],[20,23,9,21],[20,25,9,23,"setVoiceSending"],[20,40,9,38],[20,41,9,39],[20,44,9,42],[20,48,9,42,"useState"],[20,54,9,50],[20,55,9,50,"useState"],[20,63,9,50],[20,65,9,51],[20,70,9,56],[20,71,9,57],[22,4,11,2],[23,4,12,2],[23,10,12,8],[23,11,12,9,"replyTo"],[23,18,12,16],[23,20,12,18,"setReplyTo"],[23,30,12,28],[23,31,12,29],[23,34,12,32],[23,38,12,32,"useState"],[23,44,12,40],[23,45,12,40,"useState"],[23,53,12,40],[23,55,12,41],[23,59,12,45],[23,60,12,46],[24,4,14,2],[24,10,14,8],[24,11,14,9,"upload"],[24,17,14,15],[24,19,14,17],[25,6,14,19,"loading"],[25,13,14,26],[25,15,14,28,"uploadLoading"],[26,4,14,42],[26,5,14,43],[26,6,14,44],[26,9,14,47],[26,13,14,47,"useUpload"],[26,22,14,56],[26,23,14,56,"default"],[26,30,14,56],[26,32,14,57],[26,33,14,58],[27,4,16,2],[27,10,16,8,"clearReplyTo"],[27,22,16,20],[27,25,16,23],[27,29,16,23,"useCallback"],[27,35,16,34],[27,36,16,34,"useCallback"],[27,47,16,34],[27,49,16,35],[27,55,16,41],[28,6,17,4,"setReplyTo"],[28,16,17,14],[28,17,17,15],[28,21,17,19],[28,22,17,20],[29,4,18,2],[29,5,18,3],[29,7,18,5],[29,9,18,7],[29,10,18,8],[30,4,20,2],[30,10,20,8,"sendMessage"],[30,21,20,19],[30,24,20,22],[30,30,20,22,"sendMessage"],[30,31,20,22],[30,36,20,34],[31,6,21,4],[31,10,21,8],[31,11,21,9,"inputText"],[31,20,21,18],[31,21,21,19,"trim"],[31,25,21,23],[31,26,21,24],[31,27,21,25],[31,31,21,29],[31,32,21,30,"user"],[31,36,21,34],[31,40,21,38,"sending"],[31,47,21,45],[31,49,21,47],[32,6,23,4],[32,12,23,10,"messageText"],[32,23,23,21],[32,26,23,24,"inputText"],[32,35,23,33],[32,36,23,34,"trim"],[32,40,23,38],[32,41,23,39],[32,42,23,40],[33,6,24,4],[33,12,24,10,"repliedToMessageId"],[33,30,24,28],[33,33,24,31,"replyTo"],[33,40,24,38],[33,42,24,40,"id"],[33,44,24,42],[33,48,24,46],[33,52,24,50],[34,6,26,4,"setInputText"],[34,18,26,16],[34,19,26,17],[34,21,26,19],[34,22,26,20],[35,6,27,4,"setSending"],[35,16,27,14],[35,17,27,15],[35,21,27,19],[35,22,27,20],[36,6,29,4],[36,10,29,8],[37,8,30,6],[37,14,30,12,"response"],[37,22,30,20],[37,25,30,23],[37,31,30,29,"fetch"],[37,36,30,34],[37,37,30,35],[37,57,30,55],[37,59,30,57],[38,10,31,8,"method"],[38,16,31,14],[38,18,31,16],[38,24,31,22],[39,10,32,8,"headers"],[39,17,32,15],[39,19,32,17],[40,12,32,19],[40,26,32,33],[40,28,32,35],[41,10,32,54],[41,11,32,55],[42,10,33,8,"body"],[42,14,33,12],[42,16,33,14,"JSON"],[42,20,33,18],[42,21,33,19,"stringify"],[42,30,33,28],[42,31,33,29],[43,12,34,10,"matchId"],[43,19,34,17],[44,12,35,10,"senderId"],[44,20,35,18],[44,22,35,20,"user"],[44,26,35,24],[44,27,35,25,"id"],[44,29,35,27],[45,12,36,10,"messageText"],[45,23,36,21],[46,12,37,10,"repliedToMessageId"],[47,10,38,8],[47,11,38,9],[48,8,39,6],[48,9,39,7],[48,10,39,8],[49,8,41,6],[49,12,41,10],[49,13,41,11,"response"],[49,21,41,19],[49,22,41,20,"ok"],[49,24,41,22],[49,26,41,24],[50,10,42,8],[51,10,43,8],[51,14,43,12,"response"],[51,22,43,20],[51,23,43,21,"status"],[51,29,43,27],[51,34,43,32],[51,37,43,35],[51,39,43,37],[52,12,44,10,"setInputText"],[52,24,44,22],[52,25,44,23,"messageText"],[52,36,44,34],[52,37,44,35],[53,12,45,10],[53,16,45,14],[54,14,46,12,"onPaymentRequired"],[54,31,46,29],[54,34,46,32],[54,35,46,33],[55,12,47,10],[55,13,47,11],[55,14,47,12],[55,21,47,19,"e"],[55,22,47,20],[55,24,47,22],[56,14,48,12,"console"],[56,21,48,19],[56,22,48,20,"error"],[56,27,48,25],[56,28,48,26,"e"],[56,29,48,27],[56,30,48,28],[57,12,49,10],[58,12,50,10],[59,10,51,8],[60,10,53,8],[60,16,53,14,"text"],[60,20,53,18],[60,23,53,21],[60,29,53,27,"response"],[60,37,53,35],[60,38,53,36,"text"],[60,42,53,40],[60,43,53,41],[60,44,53,42],[60,45,53,43,"catch"],[60,50,53,48],[60,51,53,49],[60,57,53,55],[60,59,53,57],[60,60,53,58],[61,10,54,8],[61,16,54,14],[61,20,54,18,"Error"],[61,25,54,23],[61,26,55,10],[61,54,55,38,"response"],[61,62,55,46],[61,63,55,47,"status"],[61,69,55,53],[61,74,55,58,"response"],[61,82,55,66],[61,83,55,67,"statusText"],[61,93,55,77],[61,97,55,81,"text"],[61,101,55,85],[61,103,56,8],[61,104,56,9],[62,8,57,6],[63,8,59,6],[63,14,59,12,"data"],[63,18,59,16],[63,21,59,19],[63,27,59,25,"response"],[63,35,59,33],[63,36,59,34,"json"],[63,40,59,38],[63,41,59,39],[63,42,59,40],[64,8,60,6,"setMessages"],[64,19,60,17],[64,20,60,19,"prev"],[64,24,60,23],[64,28,60,28],[64,29,60,29],[64,32,60,32,"prev"],[64,36,60,36],[64,38,60,38,"data"],[64,42,60,42],[64,43,60,43,"message"],[64,50,60,50],[64,51,60,51],[64,52,60,52],[65,8,61,6,"clearReplyTo"],[65,20,61,18],[65,21,61,19],[65,22,61,20],[66,6,62,4],[66,7,62,5],[66,8,62,6],[66,15,62,13,"error"],[66,20,62,18],[66,22,62,20],[67,8,63,6,"console"],[67,15,63,13],[67,16,63,14,"error"],[67,21,63,19],[67,22,63,20],[67,46,63,44],[67,48,63,46,"error"],[67,53,63,51],[67,54,63,52],[68,8,64,6,"setInputText"],[68,20,64,18],[68,21,64,19,"messageText"],[68,32,64,30],[68,33,64,31],[69,6,65,4],[69,7,65,5],[69,16,65,14],[70,8,66,6,"setSending"],[70,18,66,16],[70,19,66,17],[70,24,66,22],[70,25,66,23],[71,6,67,4],[72,4,68,2],[72,5,68,3],[73,4,70,2],[73,10,70,8,"sendVoiceMemo"],[73,23,70,21],[73,26,70,24],[73,30,70,24,"useCallback"],[73,36,70,35],[73,37,70,35,"useCallback"],[73,48,70,35],[73,50,71,4],[73,57,71,11],[74,6,71,13,"uri"],[74,9,71,16],[75,6,71,18,"durationMs"],[76,4,71,29],[76,5,71,30],[76,10,71,35],[77,6,72,6],[77,10,72,10],[77,11,72,11,"user"],[77,15,72,15],[77,19,72,19,"voiceSending"],[77,31,72,31],[77,35,72,35,"uploadLoading"],[77,48,72,48],[77,50,72,50],[78,6,73,6],[78,10,73,10],[78,11,73,11,"uri"],[78,14,73,14],[78,18,73,18],[78,25,73,25,"uri"],[78,28,73,28],[78,33,73,33],[78,41,73,41],[78,43,73,43],[79,6,75,6],[79,12,75,12,"repliedToMessageId"],[79,30,75,30],[79,33,75,33,"replyTo"],[79,40,75,40],[79,42,75,42,"id"],[79,44,75,44],[79,48,75,48],[79,52,75,52],[80,6,77,6,"setVoiceSending"],[80,21,77,21],[80,22,77,22],[80,26,77,26],[80,27,77,27],[81,6,78,6],[81,10,78,10],[82,8,79,8],[82,14,79,14,"fileName"],[82,22,79,22],[82,25,79,25],[82,39,79,39,"Date"],[82,43,79,43],[82,44,79,44,"now"],[82,47,79,47],[82,48,79,48],[82,49,79,49],[82,55,79,55],[83,8,80,8],[83,14,80,14],[84,10,80,16,"url"],[84,13,80,19],[85,10,80,21,"error"],[86,8,80,27],[86,9,80,28],[86,12,80,31],[86,18,80,37,"upload"],[86,24,80,43],[86,25,80,44],[87,10,81,10,"reactNativeAsset"],[87,26,81,26],[87,28,81,28],[88,12,82,12,"uri"],[88,15,82,15],[89,12,83,12,"fileName"],[89,20,83,20],[90,12,84,12,"name"],[90,16,84,16],[90,18,84,18,"fileName"],[90,26,84,26],[91,12,85,12,"mimeType"],[91,20,85,20],[91,22,85,22],[92,10,86,10],[93,8,87,8],[93,9,87,9],[93,10,87,10],[94,8,89,8],[94,12,89,12,"error"],[94,17,89,17],[94,19,89,19],[95,10,90,10],[95,16,90,16],[95,20,90,20,"Error"],[95,25,90,25],[95,26,90,26,"error"],[95,31,90,31],[95,32,90,32],[96,8,91,8],[97,8,93,8],[97,14,93,14,"response"],[97,22,93,22],[97,25,93,25],[97,31,93,31,"fetch"],[97,36,93,36],[97,37,93,37],[97,57,93,57],[97,59,93,59],[98,10,94,10,"method"],[98,16,94,16],[98,18,94,18],[98,24,94,24],[99,10,95,10,"headers"],[99,17,95,17],[99,19,95,19],[100,12,95,21],[100,26,95,35],[100,28,95,37],[101,10,95,56],[101,11,95,57],[102,10,96,10,"body"],[102,14,96,14],[102,16,96,16,"JSON"],[102,20,96,20],[102,21,96,21,"stringify"],[102,30,96,30],[102,31,96,31],[103,12,97,12,"matchId"],[103,19,97,19],[104,12,98,12,"senderId"],[104,20,98,20],[104,22,98,22,"user"],[104,26,98,26],[104,27,98,27,"id"],[104,29,98,29],[105,12,99,12,"audioUrl"],[105,20,99,20],[105,22,99,22,"url"],[105,25,99,25],[106,12,100,12,"audioDurationMs"],[106,27,100,27],[106,29,100,29,"durationMs"],[106,39,100,39],[107,12,101,12,"repliedToMessageId"],[108,12,102,12],[109,10,103,10],[109,11,103,11],[110,8,104,8],[110,9,104,9],[110,10,104,10],[111,8,106,8],[111,12,106,12],[111,13,106,13,"response"],[111,21,106,21],[111,22,106,22,"ok"],[111,24,106,24],[111,26,106,26],[112,10,107,10],[113,10,108,10],[113,14,108,14,"response"],[113,22,108,22],[113,23,108,23,"status"],[113,29,108,29],[113,34,108,34],[113,37,108,37],[113,39,108,39],[114,12,109,12],[114,16,109,16],[115,14,110,14,"onPaymentRequired"],[115,31,110,31],[115,34,110,34],[115,35,110,35],[116,12,111,12],[116,13,111,13],[116,14,111,14],[116,21,111,21,"e"],[116,22,111,22],[116,24,111,24],[117,14,112,14,"console"],[117,21,112,21],[117,22,112,22,"error"],[117,27,112,27],[117,28,112,28,"e"],[117,29,112,29],[117,30,112,30],[118,12,113,12],[119,12,114,12],[120,10,115,10],[121,10,117,10],[121,16,117,16,"text"],[121,20,117,20],[121,23,117,23],[121,29,117,29,"response"],[121,37,117,37],[121,38,117,38,"text"],[121,42,117,42],[121,43,117,43],[121,44,117,44],[121,45,117,45,"catch"],[121,50,117,50],[121,51,117,51],[121,57,117,57],[121,59,117,59],[121,60,117,60],[122,10,118,10],[122,16,118,16],[122,20,118,20,"Error"],[122,25,118,25],[122,26,119,12],[122,57,119,43,"response"],[122,65,119,51],[122,66,119,52,"status"],[122,72,119,58],[122,77,119,63,"response"],[122,85,119,71],[122,86,119,72,"statusText"],[122,96,119,82],[122,100,119,86,"text"],[122,104,119,90],[122,106,120,10],[122,107,120,11],[123,8,121,8],[124,8,123,8],[124,14,123,14,"data"],[124,18,123,18],[124,21,123,21],[124,27,123,27,"response"],[124,35,123,35],[124,36,123,36,"json"],[124,40,123,40],[124,41,123,41],[124,42,123,42],[125,8,124,8,"setMessages"],[125,19,124,19],[125,20,124,21,"prev"],[125,24,124,25],[125,28,124,30],[125,29,124,31],[125,32,124,34,"prev"],[125,36,124,38],[125,38,124,40,"data"],[125,42,124,44],[125,43,124,45,"message"],[125,50,124,52],[125,51,124,53],[125,52,124,54],[126,8,125,8,"clearReplyTo"],[126,20,125,20],[126,21,125,21],[126,22,125,22],[127,6,126,6],[127,7,126,7],[127,8,126,8],[127,15,126,15,"error"],[127,20,126,20],[127,22,126,22],[128,8,127,8,"console"],[128,15,127,15],[128,16,127,16,"error"],[128,21,127,21],[128,22,127,22],[128,49,127,49],[128,51,127,51,"error"],[128,56,127,56],[128,57,127,57],[129,6,128,6],[129,7,128,7],[129,16,128,16],[130,8,129,8,"setVoiceSending"],[130,23,129,23],[130,24,129,24],[130,29,129,29],[130,30,129,30],[131,6,130,6],[132,4,131,4],[132,5,131,5],[132,7,132,4],[132,8,133,6,"matchId"],[132,15,133,13],[132,17,134,6,"onPaymentRequired"],[132,34,134,23],[132,36,135,6,"replyTo"],[132,43,135,13],[132,45,135,15,"id"],[132,47,135,17],[132,49,136,6,"upload"],[132,55,136,12],[132,57,137,6,"uploadLoading"],[132,70,137,19],[132,72,138,6,"user"],[132,76,138,10],[132,78,139,6,"voiceSending"],[132,90,139,18],[132,92,140,6,"setMessages"],[132,103,140,17],[132,105,141,6,"clearReplyTo"],[132,117,141,18],[132,118,143,2],[132,119,143,3],[133,4,145,2],[133,11,145,9],[134,6,146,4,"inputText"],[134,15,146,13],[135,6,147,4,"setInputText"],[135,18,147,16],[136,6,148,4,"sending"],[136,13,148,11],[137,6,149,4,"sendMessage"],[137,17,149,15],[138,6,150,4,"voiceSending"],[138,18,150,16],[139,6,151,4,"sendVoiceMemo"],[139,19,151,17],[140,6,152,4,"replyTo"],[140,13,152,11],[141,6,153,4,"setReplyTo"],[141,16,153,14],[142,6,154,4,"clearReplyTo"],[143,4,155,2],[143,5,155,3],[144,2,156,0],[145,0,156,1],[145,3]],"functionMap":{"names":["<global>","useSendMessage","clearReplyTo","sendMessage","response.text._catch$argument_0","setMessages$argument_0","sendVoiceMemo"],"mappings":"AAA;OCG;mCCY;GDE;sBEE;iDCiC,QD;kBEO,iCF;GFQ;IKG;mDF8C,QE;oBDO,iCC;KLO;CDyB"},"hasCjsExports":false},"type":"js/module"}]}