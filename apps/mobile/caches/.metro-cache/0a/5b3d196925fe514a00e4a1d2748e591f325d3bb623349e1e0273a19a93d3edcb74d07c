{"dependencies":[{"name":"react","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":52,"index":52}}],"key":"RtGiGa+/H7VrI7GDQDLhO1UbpU8=","exportNames":["*"],"imports":1}},{"name":"@react-native-async-storage/async-storage","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":53},"end":{"line":2,"column":69,"index":122}}],"key":"0kSRlooyBOaYM9tlTtK91nq+uds=","exportNames":["*"],"imports":1}},{"name":"@tanstack/react-query","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":123},"end":{"line":3,"column":49,"index":172}}],"key":"Pzwu/0TIyhnZOrC9PAkpZx92hFo=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  var _s = $RefreshSig$();\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  Object.defineProperty(exports, \"default\", {\n    enumerable: true,\n    get: function () {\n      return useMatchesBadge;\n    }\n  });\n  var _react = require(_dependencyMap[0], \"react\");\n  var _reactNativeAsyncStorageAsyncStorage = require(_dependencyMap[1], \"@react-native-async-storage/async-storage\");\n  var AsyncStorage = _interopDefault(_reactNativeAsyncStorageAsyncStorage);\n  var _tanstackReactQuery = require(_dependencyMap[2], \"@tanstack/react-query\");\n  function useMatchesBadge() {\n    _s();\n    const [userId, setUserId] = (0, _react.useState)(null);\n    const pollRef = (0, _react.useRef)(null);\n    (0, _react.useEffect)(() => {\n      let cancelled = false;\n      const load = async () => {\n        try {\n          const raw = await AsyncStorage.default.getItem(\"user\");\n          if (!raw) {\n            if (!cancelled) setUserId(null);\n            return false;\n          }\n          const user = JSON.parse(raw);\n\n          // IMPORTANT: normalize to a number so react-query keys match invalidations\n          // elsewhere in the app (which always use Number(userId)).\n          const parsed = Number(user?.id);\n          const nextId = Number.isFinite(parsed) ? parsed : null;\n          if (!cancelled) {\n            setUserId(nextId);\n          }\n          return Boolean(nextId);\n        } catch (e) {\n          console.error(e);\n          if (!cancelled) setUserId(null);\n          return false;\n        }\n      };\n\n      // IMPORTANT: Root layouts can mount before login finishes.\n      // Keep checking until a user appears so the badge works right after sign-in.\n      load().then(found => {\n        if (cancelled) return;\n        if (found) return;\n        if (pollRef.current) {\n          clearInterval(pollRef.current);\n        }\n        pollRef.current = setInterval(() => {\n          if (cancelled) return;\n          load().then(nowFound => {\n            if (cancelled) return;\n            if (nowFound && pollRef.current) {\n              clearInterval(pollRef.current);\n              pollRef.current = null;\n            }\n          });\n        }, 1500);\n      });\n      return () => {\n        cancelled = true;\n        if (pollRef.current) {\n          clearInterval(pollRef.current);\n          pollRef.current = null;\n        }\n      };\n    }, []);\n\n    // IMPORTANT: We use the same /api/matches endpoint as the Messages screen.\n    // This avoids the \"badge shows 0 until I open Messages\" problem.\n    const matchesQuery = (0, _tanstackReactQuery.useQuery)({\n      queryKey: [\"matchesForBadge\", userId],\n      enabled: Number.isFinite(Number(userId)),\n      queryFn: async () => {\n        const response = await fetch(`/api/matches?userId=${userId}`);\n        if (!response.ok) {\n          throw new Error(`When fetching /api/matches for badge, the response was [${response.status}] ${response.statusText}`);\n        }\n        return response.json();\n      },\n      refetchInterval: 2000,\n      refetchIntervalInBackground: true,\n      staleTime: 0\n    });\n    const matches = Array.isArray(matchesQuery.data?.matches) ? matchesQuery.data.matches : [];\n    const unseenMatches = matches.reduce((sum, m) => {\n      return sum + (m?.is_new_match ? 1 : 0);\n    }, 0);\n    const unreadMessages = matches.reduce((sum, m) => {\n      const n = Number(m?.unread_count) || 0;\n      return sum + n;\n    }, 0);\n    const badgeCount = unseenMatches + unreadMessages;\n    return {\n      userId,\n      unseenMatches,\n      unreadMessages,\n      badgeCount,\n      isLoading: matchesQuery.isLoading,\n      refetch: matchesQuery.refetch\n    };\n  }\n  _s(useMatchesBadge, \"ONROCQNIs7wqEaySM+ciYIG36zo=\", false, function () {\n    return [_tanstackReactQuery.useQuery];\n  });\n});","lineCount":118,"map":[[13,2,5,15,"Object"],[13,8,5,15],[13,9,5,15,"defineProperty"],[13,23,5,15],[13,24,5,15,"exports"],[13,31,5,15],[14,4,5,15,"enumerable"],[14,14,5,15],[15,4,5,15,"get"],[15,7,5,15],[15,18,5,15,"get"],[15,19,5,15],[16,6,5,15],[16,13,5,15,"useMatchesBadge"],[16,28,5,15],[17,4,5,15],[18,2,5,15],[19,2,1,0],[19,6,1,0,"_react"],[19,12,1,0],[19,15,1,0,"require"],[19,22,1,0],[19,23,1,0,"_dependencyMap"],[19,37,1,0],[20,2,2,0],[20,6,2,0,"_reactNativeAsyncStorageAsyncStorage"],[20,42,2,0],[20,45,2,0,"require"],[20,52,2,0],[20,53,2,0,"_dependencyMap"],[20,67,2,0],[21,2,2,0],[21,6,2,0,"AsyncStorage"],[21,18,2,0],[21,21,2,0,"_interopDefault"],[21,36,2,0],[21,37,2,0,"_reactNativeAsyncStorageAsyncStorage"],[21,73,2,0],[22,2,3,0],[22,6,3,0,"_tanstackReactQuery"],[22,25,3,0],[22,28,3,0,"require"],[22,35,3,0],[22,36,3,0,"_dependencyMap"],[22,50,3,0],[23,2,5,15],[23,11,5,24,"useMatchesBadge"],[23,26,5,39,"useMatchesBadge"],[23,27,5,39],[23,29,5,42],[24,4,5,42,"_s"],[24,6,5,42],[25,4,6,2],[25,10,6,8],[25,11,6,9,"userId"],[25,17,6,15],[25,19,6,17,"setUserId"],[25,28,6,26],[25,29,6,27],[25,32,6,30],[25,36,6,30,"useState"],[25,42,6,38],[25,43,6,38,"useState"],[25,51,6,38],[25,53,6,39],[25,57,6,43],[25,58,6,44],[26,4,7,2],[26,10,7,8,"pollRef"],[26,17,7,15],[26,20,7,18],[26,24,7,18,"useRef"],[26,30,7,24],[26,31,7,24,"useRef"],[26,37,7,24],[26,39,7,25],[26,43,7,29],[26,44,7,30],[27,4,9,2],[27,8,9,2,"useEffect"],[27,14,9,11],[27,15,9,11,"useEffect"],[27,24,9,11],[27,26,9,12],[27,32,9,18],[28,6,10,4],[28,10,10,8,"cancelled"],[28,19,10,17],[28,22,10,20],[28,27,10,25],[29,6,12,4],[29,12,12,10,"load"],[29,16,12,14],[29,19,12,17],[29,25,12,17,"load"],[29,26,12,17],[29,31,12,29],[30,8,13,6],[30,12,13,10],[31,10,14,8],[31,16,14,14,"raw"],[31,19,14,17],[31,22,14,20],[31,28,14,26,"AsyncStorage"],[31,40,14,38],[31,41,14,38,"default"],[31,48,14,38],[31,49,14,39,"getItem"],[31,56,14,46],[31,57,14,47],[31,63,14,53],[31,64,14,54],[32,10,15,8],[32,14,15,12],[32,15,15,13,"raw"],[32,18,15,16],[32,20,15,18],[33,12,16,10],[33,16,16,14],[33,17,16,15,"cancelled"],[33,26,16,24],[33,28,16,26,"setUserId"],[33,37,16,35],[33,38,16,36],[33,42,16,40],[33,43,16,41],[34,12,17,10],[34,19,17,17],[34,24,17,22],[35,10,18,8],[36,10,19,8],[36,16,19,14,"user"],[36,20,19,18],[36,23,19,21,"JSON"],[36,27,19,25],[36,28,19,26,"parse"],[36,33,19,31],[36,34,19,32,"raw"],[36,37,19,35],[36,38,19,36],[38,10,21,8],[39,10,22,8],[40,10,23,8],[40,16,23,14,"parsed"],[40,22,23,20],[40,25,23,23,"Number"],[40,31,23,29],[40,32,23,30,"user"],[40,36,23,34],[40,38,23,36,"id"],[40,40,23,38],[40,41,23,39],[41,10,24,8],[41,16,24,14,"nextId"],[41,22,24,20],[41,25,24,23,"Number"],[41,31,24,29],[41,32,24,30,"isFinite"],[41,40,24,38],[41,41,24,39,"parsed"],[41,47,24,45],[41,48,24,46],[41,51,24,49,"parsed"],[41,57,24,55],[41,60,24,58],[41,64,24,62],[42,10,26,8],[42,14,26,12],[42,15,26,13,"cancelled"],[42,24,26,22],[42,26,26,24],[43,12,27,10,"setUserId"],[43,21,27,19],[43,22,27,20,"nextId"],[43,28,27,26],[43,29,27,27],[44,10,28,8],[45,10,29,8],[45,17,29,15,"Boolean"],[45,24,29,22],[45,25,29,23,"nextId"],[45,31,29,29],[45,32,29,30],[46,8,30,6],[46,9,30,7],[46,10,30,8],[46,17,30,15,"e"],[46,18,30,16],[46,20,30,18],[47,10,31,8,"console"],[47,17,31,15],[47,18,31,16,"error"],[47,23,31,21],[47,24,31,22,"e"],[47,25,31,23],[47,26,31,24],[48,10,32,8],[48,14,32,12],[48,15,32,13,"cancelled"],[48,24,32,22],[48,26,32,24,"setUserId"],[48,35,32,33],[48,36,32,34],[48,40,32,38],[48,41,32,39],[49,10,33,8],[49,17,33,15],[49,22,33,20],[50,8,34,6],[51,6,35,4],[51,7,35,5],[53,6,37,4],[54,6,38,4],[55,6,39,4,"load"],[55,10,39,8],[55,11,39,9],[55,12,39,10],[55,13,39,11,"then"],[55,17,39,15],[55,18,39,17,"found"],[55,23,39,22],[55,27,39,27],[56,8,40,6],[56,12,40,10,"cancelled"],[56,21,40,19],[56,23,40,21],[57,8,41,6],[57,12,41,10,"found"],[57,17,41,15],[57,19,41,17],[58,8,43,6],[58,12,43,10,"pollRef"],[58,19,43,17],[58,20,43,18,"current"],[58,27,43,25],[58,29,43,27],[59,10,44,8,"clearInterval"],[59,23,44,21],[59,24,44,22,"pollRef"],[59,31,44,29],[59,32,44,30,"current"],[59,39,44,37],[59,40,44,38],[60,8,45,6],[61,8,47,6,"pollRef"],[61,15,47,13],[61,16,47,14,"current"],[61,23,47,21],[61,26,47,24,"setInterval"],[61,37,47,35],[61,38,47,36],[61,44,47,42],[62,10,48,8],[62,14,48,12,"cancelled"],[62,23,48,21],[62,25,48,23],[63,10,49,8,"load"],[63,14,49,12],[63,15,49,13],[63,16,49,14],[63,17,49,15,"then"],[63,21,49,19],[63,22,49,21,"nowFound"],[63,30,49,29],[63,34,49,34],[64,12,50,10],[64,16,50,14,"cancelled"],[64,25,50,23],[64,27,50,25],[65,12,51,10],[65,16,51,14,"nowFound"],[65,24,51,22],[65,28,51,26,"pollRef"],[65,35,51,33],[65,36,51,34,"current"],[65,43,51,41],[65,45,51,43],[66,14,52,12,"clearInterval"],[66,27,52,25],[66,28,52,26,"pollRef"],[66,35,52,33],[66,36,52,34,"current"],[66,43,52,41],[66,44,52,42],[67,14,53,12,"pollRef"],[67,21,53,19],[67,22,53,20,"current"],[67,29,53,27],[67,32,53,30],[67,36,53,34],[68,12,54,10],[69,10,55,8],[69,11,55,9],[69,12,55,10],[70,8,56,6],[70,9,56,7],[70,11,56,9],[70,15,56,13],[70,16,56,14],[71,6,57,4],[71,7,57,5],[71,8,57,6],[72,6,59,4],[72,13,59,11],[72,19,59,17],[73,8,60,6,"cancelled"],[73,17,60,15],[73,20,60,18],[73,24,60,22],[74,8,61,6],[74,12,61,10,"pollRef"],[74,19,61,17],[74,20,61,18,"current"],[74,27,61,25],[74,29,61,27],[75,10,62,8,"clearInterval"],[75,23,62,21],[75,24,62,22,"pollRef"],[75,31,62,29],[75,32,62,30,"current"],[75,39,62,37],[75,40,62,38],[76,10,63,8,"pollRef"],[76,17,63,15],[76,18,63,16,"current"],[76,25,63,23],[76,28,63,26],[76,32,63,30],[77,8,64,6],[78,6,65,4],[78,7,65,5],[79,4,66,2],[79,5,66,3],[79,7,66,5],[79,9,66,7],[79,10,66,8],[81,4,68,2],[82,4,69,2],[83,4,70,2],[83,10,70,8,"matchesQuery"],[83,22,70,20],[83,25,70,23],[83,29,70,23,"useQuery"],[83,48,70,31],[83,49,70,31,"useQuery"],[83,57,70,31],[83,59,70,32],[84,6,71,4,"queryKey"],[84,14,71,12],[84,16,71,14],[84,17,71,15],[84,34,71,32],[84,36,71,34,"userId"],[84,42,71,40],[84,43,71,41],[85,6,72,4,"enabled"],[85,13,72,11],[85,15,72,13,"Number"],[85,21,72,19],[85,22,72,20,"isFinite"],[85,30,72,28],[85,31,72,29,"Number"],[85,37,72,35],[85,38,72,36,"userId"],[85,44,72,42],[85,45,72,43],[85,46,72,44],[86,6,73,4,"queryFn"],[86,13,73,11],[86,15,73,13],[86,21,73,13,"queryFn"],[86,22,73,13],[86,27,73,25],[87,8,74,6],[87,14,74,12,"response"],[87,22,74,20],[87,25,74,23],[87,31,74,29,"fetch"],[87,36,74,34],[87,37,74,35],[87,60,74,58,"userId"],[87,66,74,64],[87,68,74,66],[87,69,74,67],[88,8,75,6],[88,12,75,10],[88,13,75,11,"response"],[88,21,75,19],[88,22,75,20,"ok"],[88,24,75,22],[88,26,75,24],[89,10,76,8],[89,16,76,14],[89,20,76,18,"Error"],[89,25,76,23],[89,26,77,10],[89,85,77,69,"response"],[89,93,77,77],[89,94,77,78,"status"],[89,100,77,84],[89,105,77,89,"response"],[89,113,77,97],[89,114,77,98,"statusText"],[89,124,77,108],[89,126,78,8],[89,127,78,9],[90,8,79,6],[91,8,80,6],[91,15,80,13,"response"],[91,23,80,21],[91,24,80,22,"json"],[91,28,80,26],[91,29,80,27],[91,30,80,28],[92,6,81,4],[92,7,81,5],[93,6,82,4,"refetchInterval"],[93,21,82,19],[93,23,82,21],[93,27,82,25],[94,6,83,4,"refetchIntervalInBackground"],[94,33,83,31],[94,35,83,33],[94,39,83,37],[95,6,84,4,"staleTime"],[95,15,84,13],[95,17,84,15],[96,4,85,2],[96,5,85,3],[96,6,85,4],[97,4,87,2],[97,10,87,8,"matches"],[97,17,87,15],[97,20,87,18,"Array"],[97,25,87,23],[97,26,87,24,"isArray"],[97,33,87,31],[97,34,87,32,"matchesQuery"],[97,46,87,44],[97,47,87,45,"data"],[97,51,87,49],[97,53,87,51,"matches"],[97,60,87,58],[97,61,87,59],[97,64,88,6,"matchesQuery"],[97,76,88,18],[97,77,88,19,"data"],[97,81,88,23],[97,82,88,24,"matches"],[97,89,88,31],[97,92,89,6],[97,94,89,8],[98,4,91,2],[98,10,91,8,"unseenMatches"],[98,23,91,21],[98,26,91,24,"matches"],[98,33,91,31],[98,34,91,32,"reduce"],[98,40,91,38],[98,41,91,39],[98,42,91,40,"sum"],[98,45,91,43],[98,47,91,45,"m"],[98,48,91,46],[98,53,91,51],[99,6,92,4],[99,13,92,11,"sum"],[99,16,92,14],[99,20,92,18,"m"],[99,21,92,19],[99,23,92,21,"is_new_match"],[99,35,92,33],[99,38,92,36],[99,39,92,37],[99,42,92,40],[99,43,92,41],[99,44,92,42],[100,4,93,2],[100,5,93,3],[100,7,93,5],[100,8,93,6],[100,9,93,7],[101,4,95,2],[101,10,95,8,"unreadMessages"],[101,24,95,22],[101,27,95,25,"matches"],[101,34,95,32],[101,35,95,33,"reduce"],[101,41,95,39],[101,42,95,40],[101,43,95,41,"sum"],[101,46,95,44],[101,48,95,46,"m"],[101,49,95,47],[101,54,95,52],[102,6,96,4],[102,12,96,10,"n"],[102,13,96,11],[102,16,96,14,"Number"],[102,22,96,20],[102,23,96,21,"m"],[102,24,96,22],[102,26,96,24,"unread_count"],[102,38,96,36],[102,39,96,37],[102,43,96,41],[102,44,96,42],[103,6,97,4],[103,13,97,11,"sum"],[103,16,97,14],[103,19,97,17,"n"],[103,20,97,18],[104,4,98,2],[104,5,98,3],[104,7,98,5],[104,8,98,6],[104,9,98,7],[105,4,100,2],[105,10,100,8,"badgeCount"],[105,20,100,18],[105,23,100,21,"unseenMatches"],[105,36,100,34],[105,39,100,37,"unreadMessages"],[105,53,100,51],[106,4,102,2],[106,11,102,9],[107,6,103,4,"userId"],[107,12,103,10],[108,6,104,4,"unseenMatches"],[108,19,104,17],[109,6,105,4,"unreadMessages"],[109,20,105,18],[110,6,106,4,"badgeCount"],[110,16,106,14],[111,6,107,4,"isLoading"],[111,15,107,13],[111,17,107,15,"matchesQuery"],[111,29,107,27],[111,30,107,28,"isLoading"],[111,39,107,37],[112,6,108,4,"refetch"],[112,13,108,11],[112,15,108,13,"matchesQuery"],[112,27,108,25],[112,28,108,26,"refetch"],[113,4,109,2],[113,5,109,3],[114,2,110,0],[115,2,110,1,"_s"],[115,4,110,1],[115,5,5,24,"useMatchesBadge"],[115,20,5,39],[116,4,5,39],[116,12,70,23,"useQuery"],[116,31,70,31],[116,32,70,31,"useQuery"],[116,40,70,31],[117,2,70,31],[118,0,70,31],[118,3]],"functionMap":{"names":["<global>","useMatchesBadge","useEffect$argument_0","load","load.then$argument_0","setInterval$argument_0","<anonymous>","useQuery$argument_0.queryFn","matches.reduce$argument_0"],"mappings":"AAA;eCI;YCI;iBCG;KDuB;gBEI;oCCQ;oBDE;SCM;ODC;KFC;WIE;KJM;GDC;aMO;KNQ;uCOU;GPE;wCOE;GPG;CDY"},"hasCjsExports":false},"type":"js/module"}]}