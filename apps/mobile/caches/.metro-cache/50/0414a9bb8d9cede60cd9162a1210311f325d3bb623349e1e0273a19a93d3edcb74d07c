{"dependencies":[{"name":"@babel/runtime/helpers/asyncToGenerator","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"YisBBiy2Xm9DEVdFebZ2nbgAHBo=","exportNames":["*"],"imports":1}},{"name":"@babel/runtime/helpers/slicedToArray","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"5y7e5+zC7teYEEC6niD9f5zII1M=","exportNames":["*"],"imports":1}},{"name":"react","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":52,"index":52}}],"key":"RtGiGa+/H7VrI7GDQDLhO1UbpU8=","exportNames":["*"],"imports":1}},{"name":"@react-native-async-storage/async-storage","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":53},"end":{"line":2,"column":69,"index":122}}],"key":"0kSRlooyBOaYM9tlTtK91nq+uds=","exportNames":["*"],"imports":1}},{"name":"@tanstack/react-query","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":123},"end":{"line":3,"column":49,"index":172}}],"key":"Pzwu/0TIyhnZOrC9PAkpZx92hFo=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  var _s = $RefreshSig$();\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  Object.defineProperty(exports, \"default\", {\n    enumerable: true,\n    get: function () {\n      return useMatchesBadge;\n    }\n  });\n  var _babelRuntimeHelpersAsyncToGenerator = require(_dependencyMap[0], \"@babel/runtime/helpers/asyncToGenerator\");\n  var _asyncToGenerator = _interopDefault(_babelRuntimeHelpersAsyncToGenerator);\n  var _babelRuntimeHelpersSlicedToArray = require(_dependencyMap[1], \"@babel/runtime/helpers/slicedToArray\");\n  var _slicedToArray = _interopDefault(_babelRuntimeHelpersSlicedToArray);\n  var _react = require(_dependencyMap[2], \"react\");\n  var _reactNativeAsyncStorageAsyncStorage = require(_dependencyMap[3], \"@react-native-async-storage/async-storage\");\n  var AsyncStorage = _interopDefault(_reactNativeAsyncStorageAsyncStorage);\n  var _tanstackReactQuery = require(_dependencyMap[4], \"@tanstack/react-query\");\n  function useMatchesBadge() {\n    _s();\n    var _useState = (0, _react.useState)(null),\n      _useState2 = (0, _slicedToArray.default)(_useState, 2),\n      userId = _useState2[0],\n      setUserId = _useState2[1];\n    var pollRef = (0, _react.useRef)(null);\n    (0, _react.useEffect)(() => {\n      var cancelled = false;\n      var load = /*#__PURE__*/function () {\n        var _ref = (0, _asyncToGenerator.default)(function* () {\n          try {\n            var raw = yield AsyncStorage.default.getItem(\"user\");\n            if (!raw) {\n              if (!cancelled) setUserId(null);\n              return false;\n            }\n            var user = JSON.parse(raw);\n\n            // IMPORTANT: normalize to a number so react-query keys match invalidations\n            // elsewhere in the app (which always use Number(userId)).\n            var parsed = Number(user?.id);\n            var nextId = Number.isFinite(parsed) ? parsed : null;\n            if (!cancelled) {\n              setUserId(nextId);\n            }\n            return Boolean(nextId);\n          } catch (e) {\n            console.error(e);\n            if (!cancelled) setUserId(null);\n            return false;\n          }\n        });\n        return function load() {\n          return _ref.apply(this, arguments);\n        };\n      }();\n\n      // IMPORTANT: Root layouts can mount before login finishes.\n      // Keep checking until a user appears so the badge works right after sign-in.\n      load().then(found => {\n        if (cancelled) return;\n        if (found) return;\n        if (pollRef.current) {\n          clearInterval(pollRef.current);\n        }\n        pollRef.current = setInterval(() => {\n          if (cancelled) return;\n          load().then(nowFound => {\n            if (cancelled) return;\n            if (nowFound && pollRef.current) {\n              clearInterval(pollRef.current);\n              pollRef.current = null;\n            }\n          });\n        }, 1500);\n      });\n      return () => {\n        cancelled = true;\n        if (pollRef.current) {\n          clearInterval(pollRef.current);\n          pollRef.current = null;\n        }\n      };\n    }, []);\n\n    // IMPORTANT: We use the same /api/matches endpoint as the Messages screen.\n    // This avoids the \"badge shows 0 until I open Messages\" problem.\n    var matchesQuery = (0, _tanstackReactQuery.useQuery)({\n      queryKey: [\"matchesForBadge\", userId],\n      enabled: Number.isFinite(Number(userId)),\n      queryFn: function () {\n        var _ref2 = (0, _asyncToGenerator.default)(function* () {\n          var response = yield fetch(`/api/matches?userId=${userId}`);\n          if (!response.ok) {\n            throw new Error(`When fetching /api/matches for badge, the response was [${response.status}] ${response.statusText}`);\n          }\n          return response.json();\n        });\n        return function queryFn() {\n          return _ref2.apply(this, arguments);\n        };\n      }(),\n      refetchInterval: 2000,\n      refetchIntervalInBackground: true,\n      staleTime: 0\n    });\n    var matches = Array.isArray(matchesQuery.data?.matches) ? matchesQuery.data.matches : [];\n    var unseenMatches = matches.reduce((sum, m) => {\n      return sum + (m?.is_new_match ? 1 : 0);\n    }, 0);\n    var unreadMessages = matches.reduce((sum, m) => {\n      var n = Number(m?.unread_count) || 0;\n      return sum + n;\n    }, 0);\n    var badgeCount = unseenMatches + unreadMessages;\n    return {\n      userId,\n      unseenMatches,\n      unreadMessages,\n      badgeCount,\n      isLoading: matchesQuery.isLoading,\n      refetch: matchesQuery.refetch\n    };\n  }\n  _s(useMatchesBadge, \"ONROCQNIs7wqEaySM+ciYIG36zo=\", false, function () {\n    return [_tanstackReactQuery.useQuery];\n  });\n});","lineCount":135,"map":[[13,2,5,15,"Object"],[13,8,5,15],[13,9,5,15,"defineProperty"],[13,23,5,15],[13,24,5,15,"exports"],[13,31,5,15],[14,4,5,15,"enumerable"],[14,14,5,15],[15,4,5,15,"get"],[15,7,5,15],[15,18,5,15,"get"],[15,19,5,15],[16,6,5,15],[16,13,5,15,"useMatchesBadge"],[16,28,5,15],[17,4,5,15],[18,2,5,15],[19,2,110,1],[19,6,110,1,"_babelRuntimeHelpersAsyncToGenerator"],[19,42,110,1],[19,45,110,1,"require"],[19,52,110,1],[19,53,110,1,"_dependencyMap"],[19,67,110,1],[20,2,110,1],[20,6,110,1,"_asyncToGenerator"],[20,23,110,1],[20,26,110,1,"_interopDefault"],[20,41,110,1],[20,42,110,1,"_babelRuntimeHelpersAsyncToGenerator"],[20,78,110,1],[21,2,110,1],[21,6,110,1,"_babelRuntimeHelpersSlicedToArray"],[21,39,110,1],[21,42,110,1,"require"],[21,49,110,1],[21,50,110,1,"_dependencyMap"],[21,64,110,1],[22,2,110,1],[22,6,110,1,"_slicedToArray"],[22,20,110,1],[22,23,110,1,"_interopDefault"],[22,38,110,1],[22,39,110,1,"_babelRuntimeHelpersSlicedToArray"],[22,72,110,1],[23,2,1,0],[23,6,1,0,"_react"],[23,12,1,0],[23,15,1,0,"require"],[23,22,1,0],[23,23,1,0,"_dependencyMap"],[23,37,1,0],[24,2,2,0],[24,6,2,0,"_reactNativeAsyncStorageAsyncStorage"],[24,42,2,0],[24,45,2,0,"require"],[24,52,2,0],[24,53,2,0,"_dependencyMap"],[24,67,2,0],[25,2,2,0],[25,6,2,0,"AsyncStorage"],[25,18,2,0],[25,21,2,0,"_interopDefault"],[25,36,2,0],[25,37,2,0,"_reactNativeAsyncStorageAsyncStorage"],[25,73,2,0],[26,2,3,0],[26,6,3,0,"_tanstackReactQuery"],[26,25,3,0],[26,28,3,0,"require"],[26,35,3,0],[26,36,3,0,"_dependencyMap"],[26,50,3,0],[27,2,5,15],[27,11,5,24,"useMatchesBadge"],[27,26,5,39,"useMatchesBadge"],[27,27,5,39],[27,29,5,42],[28,4,5,42,"_s"],[28,6,5,42],[29,4,6,2],[29,8,6,2,"_useState"],[29,17,6,2],[29,20,6,30],[29,24,6,30,"useState"],[29,30,6,38],[29,31,6,38,"useState"],[29,39,6,38],[29,41,6,39],[29,45,6,43],[29,46,6,44],[30,6,6,44,"_useState2"],[30,16,6,44],[30,23,6,44,"_slicedToArray"],[30,37,6,44],[30,38,6,44,"default"],[30,45,6,44],[30,47,6,44,"_useState"],[30,56,6,44],[31,6,6,9,"userId"],[31,12,6,15],[31,15,6,15,"_useState2"],[31,25,6,15],[32,6,6,17,"setUserId"],[32,15,6,26],[32,18,6,26,"_useState2"],[32,28,6,26],[33,4,7,2],[33,8,7,8,"pollRef"],[33,15,7,15],[33,18,7,18],[33,22,7,18,"useRef"],[33,28,7,24],[33,29,7,24,"useRef"],[33,35,7,24],[33,37,7,25],[33,41,7,29],[33,42,7,30],[34,4,9,2],[34,8,9,2,"useEffect"],[34,14,9,11],[34,15,9,11,"useEffect"],[34,24,9,11],[34,26,9,12],[34,32,9,18],[35,6,10,4],[35,10,10,8,"cancelled"],[35,19,10,17],[35,22,10,20],[35,27,10,25],[36,6,12,4],[36,10,12,10,"load"],[36,14,12,14],[37,8,12,14],[37,12,12,14,"_ref"],[37,16,12,14],[37,23,12,14,"_asyncToGenerator"],[37,40,12,14],[37,41,12,14,"default"],[37,48,12,14],[37,50,12,17],[37,63,12,29],[38,10,13,6],[38,14,13,10],[39,12,14,8],[39,16,14,14,"raw"],[39,19,14,17],[39,28,14,26,"AsyncStorage"],[39,40,14,38],[39,41,14,38,"default"],[39,48,14,38],[39,49,14,39,"getItem"],[39,56,14,46],[39,57,14,47],[39,63,14,53],[39,64,14,54],[40,12,15,8],[40,16,15,12],[40,17,15,13,"raw"],[40,20,15,16],[40,22,15,18],[41,14,16,10],[41,18,16,14],[41,19,16,15,"cancelled"],[41,28,16,24],[41,30,16,26,"setUserId"],[41,39,16,35],[41,40,16,36],[41,44,16,40],[41,45,16,41],[42,14,17,10],[42,21,17,17],[42,26,17,22],[43,12,18,8],[44,12,19,8],[44,16,19,14,"user"],[44,20,19,18],[44,23,19,21,"JSON"],[44,27,19,25],[44,28,19,26,"parse"],[44,33,19,31],[44,34,19,32,"raw"],[44,37,19,35],[44,38,19,36],[46,12,21,8],[47,12,22,8],[48,12,23,8],[48,16,23,14,"parsed"],[48,22,23,20],[48,25,23,23,"Number"],[48,31,23,29],[48,32,23,30,"user"],[48,36,23,34],[48,38,23,36,"id"],[48,40,23,38],[48,41,23,39],[49,12,24,8],[49,16,24,14,"nextId"],[49,22,24,20],[49,25,24,23,"Number"],[49,31,24,29],[49,32,24,30,"isFinite"],[49,40,24,38],[49,41,24,39,"parsed"],[49,47,24,45],[49,48,24,46],[49,51,24,49,"parsed"],[49,57,24,55],[49,60,24,58],[49,64,24,62],[50,12,26,8],[50,16,26,12],[50,17,26,13,"cancelled"],[50,26,26,22],[50,28,26,24],[51,14,27,10,"setUserId"],[51,23,27,19],[51,24,27,20,"nextId"],[51,30,27,26],[51,31,27,27],[52,12,28,8],[53,12,29,8],[53,19,29,15,"Boolean"],[53,26,29,22],[53,27,29,23,"nextId"],[53,33,29,29],[53,34,29,30],[54,10,30,6],[54,11,30,7],[54,12,30,8],[54,19,30,15,"e"],[54,20,30,16],[54,22,30,18],[55,12,31,8,"console"],[55,19,31,15],[55,20,31,16,"error"],[55,25,31,21],[55,26,31,22,"e"],[55,27,31,23],[55,28,31,24],[56,12,32,8],[56,16,32,12],[56,17,32,13,"cancelled"],[56,26,32,22],[56,28,32,24,"setUserId"],[56,37,32,33],[56,38,32,34],[56,42,32,38],[56,43,32,39],[57,12,33,8],[57,19,33,15],[57,24,33,20],[58,10,34,6],[59,8,35,4],[59,9,35,5],[60,8,35,5],[60,24,12,10,"load"],[60,28,12,14,"load"],[60,29,12,14],[61,10,12,14],[61,17,12,14,"_ref"],[61,21,12,14],[61,22,12,14,"apply"],[61,27,12,14],[61,34,12,14,"arguments"],[61,43,12,14],[62,8,12,14],[63,6,12,14],[63,9,35,5],[65,6,37,4],[66,6,38,4],[67,6,39,4,"load"],[67,10,39,8],[67,11,39,9],[67,12,39,10],[67,13,39,11,"then"],[67,17,39,15],[67,18,39,17,"found"],[67,23,39,22],[67,27,39,27],[68,8,40,6],[68,12,40,10,"cancelled"],[68,21,40,19],[68,23,40,21],[69,8,41,6],[69,12,41,10,"found"],[69,17,41,15],[69,19,41,17],[70,8,43,6],[70,12,43,10,"pollRef"],[70,19,43,17],[70,20,43,18,"current"],[70,27,43,25],[70,29,43,27],[71,10,44,8,"clearInterval"],[71,23,44,21],[71,24,44,22,"pollRef"],[71,31,44,29],[71,32,44,30,"current"],[71,39,44,37],[71,40,44,38],[72,8,45,6],[73,8,47,6,"pollRef"],[73,15,47,13],[73,16,47,14,"current"],[73,23,47,21],[73,26,47,24,"setInterval"],[73,37,47,35],[73,38,47,36],[73,44,47,42],[74,10,48,8],[74,14,48,12,"cancelled"],[74,23,48,21],[74,25,48,23],[75,10,49,8,"load"],[75,14,49,12],[75,15,49,13],[75,16,49,14],[75,17,49,15,"then"],[75,21,49,19],[75,22,49,21,"nowFound"],[75,30,49,29],[75,34,49,34],[76,12,50,10],[76,16,50,14,"cancelled"],[76,25,50,23],[76,27,50,25],[77,12,51,10],[77,16,51,14,"nowFound"],[77,24,51,22],[77,28,51,26,"pollRef"],[77,35,51,33],[77,36,51,34,"current"],[77,43,51,41],[77,45,51,43],[78,14,52,12,"clearInterval"],[78,27,52,25],[78,28,52,26,"pollRef"],[78,35,52,33],[78,36,52,34,"current"],[78,43,52,41],[78,44,52,42],[79,14,53,12,"pollRef"],[79,21,53,19],[79,22,53,20,"current"],[79,29,53,27],[79,32,53,30],[79,36,53,34],[80,12,54,10],[81,10,55,8],[81,11,55,9],[81,12,55,10],[82,8,56,6],[82,9,56,7],[82,11,56,9],[82,15,56,13],[82,16,56,14],[83,6,57,4],[83,7,57,5],[83,8,57,6],[84,6,59,4],[84,13,59,11],[84,19,59,17],[85,8,60,6,"cancelled"],[85,17,60,15],[85,20,60,18],[85,24,60,22],[86,8,61,6],[86,12,61,10,"pollRef"],[86,19,61,17],[86,20,61,18,"current"],[86,27,61,25],[86,29,61,27],[87,10,62,8,"clearInterval"],[87,23,62,21],[87,24,62,22,"pollRef"],[87,31,62,29],[87,32,62,30,"current"],[87,39,62,37],[87,40,62,38],[88,10,63,8,"pollRef"],[88,17,63,15],[88,18,63,16,"current"],[88,25,63,23],[88,28,63,26],[88,32,63,30],[89,8,64,6],[90,6,65,4],[90,7,65,5],[91,4,66,2],[91,5,66,3],[91,7,66,5],[91,9,66,7],[91,10,66,8],[93,4,68,2],[94,4,69,2],[95,4,70,2],[95,8,70,8,"matchesQuery"],[95,20,70,20],[95,23,70,23],[95,27,70,23,"useQuery"],[95,46,70,31],[95,47,70,31,"useQuery"],[95,55,70,31],[95,57,70,32],[96,6,71,4,"queryKey"],[96,14,71,12],[96,16,71,14],[96,17,71,15],[96,34,71,32],[96,36,71,34,"userId"],[96,42,71,40],[96,43,71,41],[97,6,72,4,"enabled"],[97,13,72,11],[97,15,72,13,"Number"],[97,21,72,19],[97,22,72,20,"isFinite"],[97,30,72,28],[97,31,72,29,"Number"],[97,37,72,35],[97,38,72,36,"userId"],[97,44,72,42],[97,45,72,43],[97,46,72,44],[98,6,73,4,"queryFn"],[98,13,73,11],[99,8,73,11],[99,12,73,11,"_ref2"],[99,17,73,11],[99,24,73,11,"_asyncToGenerator"],[99,41,73,11],[99,42,73,11,"default"],[99,49,73,11],[99,51,73,13],[99,64,73,25],[100,10,74,6],[100,14,74,12,"response"],[100,22,74,20],[100,31,74,29,"fetch"],[100,36,74,34],[100,37,74,35],[100,60,74,58,"userId"],[100,66,74,64],[100,68,74,66],[100,69,74,67],[101,10,75,6],[101,14,75,10],[101,15,75,11,"response"],[101,23,75,19],[101,24,75,20,"ok"],[101,26,75,22],[101,28,75,24],[102,12,76,8],[102,18,76,14],[102,22,76,18,"Error"],[102,27,76,23],[102,28,77,10],[102,87,77,69,"response"],[102,95,77,77],[102,96,77,78,"status"],[102,102,77,84],[102,107,77,89,"response"],[102,115,77,97],[102,116,77,98,"statusText"],[102,126,77,108],[102,128,78,8],[102,129,78,9],[103,10,79,6],[104,10,80,6],[104,17,80,13,"response"],[104,25,80,21],[104,26,80,22,"json"],[104,30,80,26],[104,31,80,27],[104,32,80,28],[105,8,81,4],[105,9,81,5],[106,8,81,5],[106,24,73,4,"queryFn"],[106,31,73,11,"queryFn"],[106,32,73,11],[107,10,73,11],[107,17,73,11,"_ref2"],[107,22,73,11],[107,23,73,11,"apply"],[107,28,73,11],[107,35,73,11,"arguments"],[107,44,73,11],[108,8,73,11],[109,6,73,11],[109,9,81,5],[110,6,82,4,"refetchInterval"],[110,21,82,19],[110,23,82,21],[110,27,82,25],[111,6,83,4,"refetchIntervalInBackground"],[111,33,83,31],[111,35,83,33],[111,39,83,37],[112,6,84,4,"staleTime"],[112,15,84,13],[112,17,84,15],[113,4,85,2],[113,5,85,3],[113,6,85,4],[114,4,87,2],[114,8,87,8,"matches"],[114,15,87,15],[114,18,87,18,"Array"],[114,23,87,23],[114,24,87,24,"isArray"],[114,31,87,31],[114,32,87,32,"matchesQuery"],[114,44,87,44],[114,45,87,45,"data"],[114,49,87,49],[114,51,87,51,"matches"],[114,58,87,58],[114,59,87,59],[114,62,88,6,"matchesQuery"],[114,74,88,18],[114,75,88,19,"data"],[114,79,88,23],[114,80,88,24,"matches"],[114,87,88,31],[114,90,89,6],[114,92,89,8],[115,4,91,2],[115,8,91,8,"unseenMatches"],[115,21,91,21],[115,24,91,24,"matches"],[115,31,91,31],[115,32,91,32,"reduce"],[115,38,91,38],[115,39,91,39],[115,40,91,40,"sum"],[115,43,91,43],[115,45,91,45,"m"],[115,46,91,46],[115,51,91,51],[116,6,92,4],[116,13,92,11,"sum"],[116,16,92,14],[116,20,92,18,"m"],[116,21,92,19],[116,23,92,21,"is_new_match"],[116,35,92,33],[116,38,92,36],[116,39,92,37],[116,42,92,40],[116,43,92,41],[116,44,92,42],[117,4,93,2],[117,5,93,3],[117,7,93,5],[117,8,93,6],[117,9,93,7],[118,4,95,2],[118,8,95,8,"unreadMessages"],[118,22,95,22],[118,25,95,25,"matches"],[118,32,95,32],[118,33,95,33,"reduce"],[118,39,95,39],[118,40,95,40],[118,41,95,41,"sum"],[118,44,95,44],[118,46,95,46,"m"],[118,47,95,47],[118,52,95,52],[119,6,96,4],[119,10,96,10,"n"],[119,11,96,11],[119,14,96,14,"Number"],[119,20,96,20],[119,21,96,21,"m"],[119,22,96,22],[119,24,96,24,"unread_count"],[119,36,96,36],[119,37,96,37],[119,41,96,41],[119,42,96,42],[120,6,97,4],[120,13,97,11,"sum"],[120,16,97,14],[120,19,97,17,"n"],[120,20,97,18],[121,4,98,2],[121,5,98,3],[121,7,98,5],[121,8,98,6],[121,9,98,7],[122,4,100,2],[122,8,100,8,"badgeCount"],[122,18,100,18],[122,21,100,21,"unseenMatches"],[122,34,100,34],[122,37,100,37,"unreadMessages"],[122,51,100,51],[123,4,102,2],[123,11,102,9],[124,6,103,4,"userId"],[124,12,103,10],[125,6,104,4,"unseenMatches"],[125,19,104,17],[126,6,105,4,"unreadMessages"],[126,20,105,18],[127,6,106,4,"badgeCount"],[127,16,106,14],[128,6,107,4,"isLoading"],[128,15,107,13],[128,17,107,15,"matchesQuery"],[128,29,107,27],[128,30,107,28,"isLoading"],[128,39,107,37],[129,6,108,4,"refetch"],[129,13,108,11],[129,15,108,13,"matchesQuery"],[129,27,108,25],[129,28,108,26,"refetch"],[130,4,109,2],[130,5,109,3],[131,2,110,0],[132,2,110,1,"_s"],[132,4,110,1],[132,5,5,24,"useMatchesBadge"],[132,20,5,39],[133,4,5,39],[133,12,70,23,"useQuery"],[133,31,70,31],[133,32,70,31,"useQuery"],[133,40,70,31],[134,2,70,31],[135,0,70,31],[135,3]],"functionMap":{"names":["<global>","useMatchesBadge","useEffect$argument_0","load","load.then$argument_0","setInterval$argument_0","<anonymous>","useQuery$argument_0.queryFn","matches.reduce$argument_0"],"mappings":"AAA;eCI;YCI;iBCG;KDuB;gBEI;oCCQ;oBDE;SCM;ODC;KFC;WIE;KJM;GDC;aMO;KNQ;uCOU;GPE;wCOE;GPG;CDY"},"hasCjsExports":false},"type":"js/module"}]}