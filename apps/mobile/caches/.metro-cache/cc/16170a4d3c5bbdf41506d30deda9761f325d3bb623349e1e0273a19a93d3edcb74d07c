{"dependencies":[{"name":"@babel/runtime/helpers/asyncToGenerator","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"YisBBiy2Xm9DEVdFebZ2nbgAHBo=","exportNames":["*"],"imports":1}},{"name":"@babel/runtime/helpers/slicedToArray","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"5y7e5+zC7teYEEC6niD9f5zII1M=","exportNames":["*"],"imports":1}},{"name":"react","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":52,"index":52}}],"key":"RtGiGa+/H7VrI7GDQDLhO1UbpU8=","exportNames":["*"],"imports":1}},{"name":"@react-native-async-storage/async-storage","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":53},"end":{"line":2,"column":69,"index":122}}],"key":"0kSRlooyBOaYM9tlTtK91nq+uds=","exportNames":["*"],"imports":1}},{"name":"@tanstack/react-query","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":123},"end":{"line":3,"column":49,"index":172}}],"key":"Pzwu/0TIyhnZOrC9PAkpZx92hFo=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  Object.defineProperty(exports, \"default\", {\n    enumerable: true,\n    get: function () {\n      return useMatchesBadge;\n    }\n  });\n  var _babelRuntimeHelpersAsyncToGenerator = require(_dependencyMap[0]);\n  var _asyncToGenerator = _interopDefault(_babelRuntimeHelpersAsyncToGenerator);\n  var _babelRuntimeHelpersSlicedToArray = require(_dependencyMap[1]);\n  var _slicedToArray = _interopDefault(_babelRuntimeHelpersSlicedToArray);\n  var _react = require(_dependencyMap[2]);\n  var _reactNativeAsyncStorageAsyncStorage = require(_dependencyMap[3]);\n  var AsyncStorage = _interopDefault(_reactNativeAsyncStorageAsyncStorage);\n  var _tanstackReactQuery = require(_dependencyMap[4]);\n  function useMatchesBadge() {\n    var _useState = (0, _react.useState)(null),\n      _useState2 = (0, _slicedToArray.default)(_useState, 2),\n      userId = _useState2[0],\n      setUserId = _useState2[1];\n    var pollRef = (0, _react.useRef)(null);\n    (0, _react.useEffect)(() => {\n      var cancelled = false;\n      var load = /*#__PURE__*/function () {\n        var _ref = (0, _asyncToGenerator.default)(function* () {\n          try {\n            var raw = yield AsyncStorage.default.getItem(\"user\");\n            if (!raw) {\n              if (!cancelled) setUserId(null);\n              return false;\n            }\n            var user = JSON.parse(raw);\n\n            // IMPORTANT: normalize to a number so react-query keys match invalidations\n            // elsewhere in the app (which always use Number(userId)).\n            var parsed = Number(user?.id);\n            var nextId = Number.isFinite(parsed) ? parsed : null;\n            if (!cancelled) {\n              setUserId(nextId);\n            }\n            return Boolean(nextId);\n          } catch (e) {\n            console.error(e);\n            if (!cancelled) setUserId(null);\n            return false;\n          }\n        });\n        return function load() {\n          return _ref.apply(this, arguments);\n        };\n      }();\n\n      // IMPORTANT: Root layouts can mount before login finishes.\n      // Keep checking until a user appears so the badge works right after sign-in.\n      load().then(found => {\n        if (cancelled) return;\n        if (found) return;\n        if (pollRef.current) {\n          clearInterval(pollRef.current);\n        }\n        pollRef.current = setInterval(() => {\n          if (cancelled) return;\n          load().then(nowFound => {\n            if (cancelled) return;\n            if (nowFound && pollRef.current) {\n              clearInterval(pollRef.current);\n              pollRef.current = null;\n            }\n          });\n        }, 1500);\n      });\n      return () => {\n        cancelled = true;\n        if (pollRef.current) {\n          clearInterval(pollRef.current);\n          pollRef.current = null;\n        }\n      };\n    }, []);\n\n    // IMPORTANT: We use the same /api/matches endpoint as the Messages screen.\n    // This avoids the \"badge shows 0 until I open Messages\" problem.\n    var matchesQuery = (0, _tanstackReactQuery.useQuery)({\n      queryKey: [\"matchesForBadge\", userId],\n      enabled: Number.isFinite(Number(userId)),\n      queryFn: function () {\n        var _ref2 = (0, _asyncToGenerator.default)(function* () {\n          var response = yield fetch(`/api/matches?userId=${userId}`);\n          if (!response.ok) {\n            throw new Error(`When fetching /api/matches for badge, the response was [${response.status}] ${response.statusText}`);\n          }\n          return response.json();\n        });\n        return function queryFn() {\n          return _ref2.apply(this, arguments);\n        };\n      }(),\n      refetchInterval: 2000,\n      refetchIntervalInBackground: true,\n      staleTime: 0\n    });\n    var matches = Array.isArray(matchesQuery.data?.matches) ? matchesQuery.data.matches : [];\n    var unseenMatches = matches.reduce((sum, m) => {\n      return sum + (m?.is_new_match ? 1 : 0);\n    }, 0);\n    var unreadMessages = matches.reduce((sum, m) => {\n      var n = Number(m?.unread_count) || 0;\n      return sum + n;\n    }, 0);\n    var badgeCount = unseenMatches + unreadMessages;\n    return {\n      userId,\n      unseenMatches,\n      unreadMessages,\n      badgeCount,\n      isLoading: matchesQuery.isLoading,\n      refetch: matchesQuery.refetch\n    };\n  }\n});","lineCount":130,"map":[[12,2,5,15,"Object"],[12,8,5,15],[12,9,5,15,"defineProperty"],[12,23,5,15],[12,24,5,15,"exports"],[12,31,5,15],[13,4,5,15,"enumerable"],[13,14,5,15],[14,4,5,15,"get"],[14,7,5,15],[14,18,5,15,"get"],[14,19,5,15],[15,6,5,15],[15,13,5,15,"useMatchesBadge"],[15,28,5,15],[16,4,5,15],[17,2,5,15],[18,2,110,1],[18,6,110,1,"_babelRuntimeHelpersAsyncToGenerator"],[18,42,110,1],[18,45,110,1,"require"],[18,52,110,1],[18,53,110,1,"_dependencyMap"],[18,67,110,1],[19,2,110,1],[19,6,110,1,"_asyncToGenerator"],[19,23,110,1],[19,26,110,1,"_interopDefault"],[19,41,110,1],[19,42,110,1,"_babelRuntimeHelpersAsyncToGenerator"],[19,78,110,1],[20,2,110,1],[20,6,110,1,"_babelRuntimeHelpersSlicedToArray"],[20,39,110,1],[20,42,110,1,"require"],[20,49,110,1],[20,50,110,1,"_dependencyMap"],[20,64,110,1],[21,2,110,1],[21,6,110,1,"_slicedToArray"],[21,20,110,1],[21,23,110,1,"_interopDefault"],[21,38,110,1],[21,39,110,1,"_babelRuntimeHelpersSlicedToArray"],[21,72,110,1],[22,2,1,0],[22,6,1,0,"_react"],[22,12,1,0],[22,15,1,0,"require"],[22,22,1,0],[22,23,1,0,"_dependencyMap"],[22,37,1,0],[23,2,2,0],[23,6,2,0,"_reactNativeAsyncStorageAsyncStorage"],[23,42,2,0],[23,45,2,0,"require"],[23,52,2,0],[23,53,2,0,"_dependencyMap"],[23,67,2,0],[24,2,2,0],[24,6,2,0,"AsyncStorage"],[24,18,2,0],[24,21,2,0,"_interopDefault"],[24,36,2,0],[24,37,2,0,"_reactNativeAsyncStorageAsyncStorage"],[24,73,2,0],[25,2,3,0],[25,6,3,0,"_tanstackReactQuery"],[25,25,3,0],[25,28,3,0,"require"],[25,35,3,0],[25,36,3,0,"_dependencyMap"],[25,50,3,0],[26,2,5,15],[26,11,5,24,"useMatchesBadge"],[26,26,5,39,"useMatchesBadge"],[26,27,5,39],[26,29,5,42],[27,4,6,2],[27,8,6,2,"_useState"],[27,17,6,2],[27,20,6,30],[27,24,6,30,"useState"],[27,30,6,38],[27,31,6,38,"useState"],[27,39,6,38],[27,41,6,39],[27,45,6,43],[27,46,6,44],[28,6,6,44,"_useState2"],[28,16,6,44],[28,23,6,44,"_slicedToArray"],[28,37,6,44],[28,38,6,44,"default"],[28,45,6,44],[28,47,6,44,"_useState"],[28,56,6,44],[29,6,6,9,"userId"],[29,12,6,15],[29,15,6,15,"_useState2"],[29,25,6,15],[30,6,6,17,"setUserId"],[30,15,6,26],[30,18,6,26,"_useState2"],[30,28,6,26],[31,4,7,2],[31,8,7,8,"pollRef"],[31,15,7,15],[31,18,7,18],[31,22,7,18,"useRef"],[31,28,7,24],[31,29,7,24,"useRef"],[31,35,7,24],[31,37,7,25],[31,41,7,29],[31,42,7,30],[32,4,9,2],[32,8,9,2,"useEffect"],[32,14,9,11],[32,15,9,11,"useEffect"],[32,24,9,11],[32,26,9,12],[32,32,9,18],[33,6,10,4],[33,10,10,8,"cancelled"],[33,19,10,17],[33,22,10,20],[33,27,10,25],[34,6,12,4],[34,10,12,10,"load"],[34,14,12,14],[35,8,12,14],[35,12,12,14,"_ref"],[35,16,12,14],[35,23,12,14,"_asyncToGenerator"],[35,40,12,14],[35,41,12,14,"default"],[35,48,12,14],[35,50,12,17],[35,63,12,29],[36,10,13,6],[36,14,13,10],[37,12,14,8],[37,16,14,14,"raw"],[37,19,14,17],[37,28,14,26,"AsyncStorage"],[37,40,14,38],[37,41,14,38,"default"],[37,48,14,38],[37,49,14,39,"getItem"],[37,56,14,46],[37,57,14,47],[37,63,14,53],[37,64,14,54],[38,12,15,8],[38,16,15,12],[38,17,15,13,"raw"],[38,20,15,16],[38,22,15,18],[39,14,16,10],[39,18,16,14],[39,19,16,15,"cancelled"],[39,28,16,24],[39,30,16,26,"setUserId"],[39,39,16,35],[39,40,16,36],[39,44,16,40],[39,45,16,41],[40,14,17,10],[40,21,17,17],[40,26,17,22],[41,12,18,8],[42,12,19,8],[42,16,19,14,"user"],[42,20,19,18],[42,23,19,21,"JSON"],[42,27,19,25],[42,28,19,26,"parse"],[42,33,19,31],[42,34,19,32,"raw"],[42,37,19,35],[42,38,19,36],[44,12,21,8],[45,12,22,8],[46,12,23,8],[46,16,23,14,"parsed"],[46,22,23,20],[46,25,23,23,"Number"],[46,31,23,29],[46,32,23,30,"user"],[46,36,23,34],[46,38,23,36,"id"],[46,40,23,38],[46,41,23,39],[47,12,24,8],[47,16,24,14,"nextId"],[47,22,24,20],[47,25,24,23,"Number"],[47,31,24,29],[47,32,24,30,"isFinite"],[47,40,24,38],[47,41,24,39,"parsed"],[47,47,24,45],[47,48,24,46],[47,51,24,49,"parsed"],[47,57,24,55],[47,60,24,58],[47,64,24,62],[48,12,26,8],[48,16,26,12],[48,17,26,13,"cancelled"],[48,26,26,22],[48,28,26,24],[49,14,27,10,"setUserId"],[49,23,27,19],[49,24,27,20,"nextId"],[49,30,27,26],[49,31,27,27],[50,12,28,8],[51,12,29,8],[51,19,29,15,"Boolean"],[51,26,29,22],[51,27,29,23,"nextId"],[51,33,29,29],[51,34,29,30],[52,10,30,6],[52,11,30,7],[52,12,30,8],[52,19,30,15,"e"],[52,20,30,16],[52,22,30,18],[53,12,31,8,"console"],[53,19,31,15],[53,20,31,16,"error"],[53,25,31,21],[53,26,31,22,"e"],[53,27,31,23],[53,28,31,24],[54,12,32,8],[54,16,32,12],[54,17,32,13,"cancelled"],[54,26,32,22],[54,28,32,24,"setUserId"],[54,37,32,33],[54,38,32,34],[54,42,32,38],[54,43,32,39],[55,12,33,8],[55,19,33,15],[55,24,33,20],[56,10,34,6],[57,8,35,4],[57,9,35,5],[58,8,35,5],[58,24,12,10,"load"],[58,28,12,14,"load"],[58,29,12,14],[59,10,12,14],[59,17,12,14,"_ref"],[59,21,12,14],[59,22,12,14,"apply"],[59,27,12,14],[59,34,12,14,"arguments"],[59,43,12,14],[60,8,12,14],[61,6,12,14],[61,9,35,5],[63,6,37,4],[64,6,38,4],[65,6,39,4,"load"],[65,10,39,8],[65,11,39,9],[65,12,39,10],[65,13,39,11,"then"],[65,17,39,15],[65,18,39,17,"found"],[65,23,39,22],[65,27,39,27],[66,8,40,6],[66,12,40,10,"cancelled"],[66,21,40,19],[66,23,40,21],[67,8,41,6],[67,12,41,10,"found"],[67,17,41,15],[67,19,41,17],[68,8,43,6],[68,12,43,10,"pollRef"],[68,19,43,17],[68,20,43,18,"current"],[68,27,43,25],[68,29,43,27],[69,10,44,8,"clearInterval"],[69,23,44,21],[69,24,44,22,"pollRef"],[69,31,44,29],[69,32,44,30,"current"],[69,39,44,37],[69,40,44,38],[70,8,45,6],[71,8,47,6,"pollRef"],[71,15,47,13],[71,16,47,14,"current"],[71,23,47,21],[71,26,47,24,"setInterval"],[71,37,47,35],[71,38,47,36],[71,44,47,42],[72,10,48,8],[72,14,48,12,"cancelled"],[72,23,48,21],[72,25,48,23],[73,10,49,8,"load"],[73,14,49,12],[73,15,49,13],[73,16,49,14],[73,17,49,15,"then"],[73,21,49,19],[73,22,49,21,"nowFound"],[73,30,49,29],[73,34,49,34],[74,12,50,10],[74,16,50,14,"cancelled"],[74,25,50,23],[74,27,50,25],[75,12,51,10],[75,16,51,14,"nowFound"],[75,24,51,22],[75,28,51,26,"pollRef"],[75,35,51,33],[75,36,51,34,"current"],[75,43,51,41],[75,45,51,43],[76,14,52,12,"clearInterval"],[76,27,52,25],[76,28,52,26,"pollRef"],[76,35,52,33],[76,36,52,34,"current"],[76,43,52,41],[76,44,52,42],[77,14,53,12,"pollRef"],[77,21,53,19],[77,22,53,20,"current"],[77,29,53,27],[77,32,53,30],[77,36,53,34],[78,12,54,10],[79,10,55,8],[79,11,55,9],[79,12,55,10],[80,8,56,6],[80,9,56,7],[80,11,56,9],[80,15,56,13],[80,16,56,14],[81,6,57,4],[81,7,57,5],[81,8,57,6],[82,6,59,4],[82,13,59,11],[82,19,59,17],[83,8,60,6,"cancelled"],[83,17,60,15],[83,20,60,18],[83,24,60,22],[84,8,61,6],[84,12,61,10,"pollRef"],[84,19,61,17],[84,20,61,18,"current"],[84,27,61,25],[84,29,61,27],[85,10,62,8,"clearInterval"],[85,23,62,21],[85,24,62,22,"pollRef"],[85,31,62,29],[85,32,62,30,"current"],[85,39,62,37],[85,40,62,38],[86,10,63,8,"pollRef"],[86,17,63,15],[86,18,63,16,"current"],[86,25,63,23],[86,28,63,26],[86,32,63,30],[87,8,64,6],[88,6,65,4],[88,7,65,5],[89,4,66,2],[89,5,66,3],[89,7,66,5],[89,9,66,7],[89,10,66,8],[91,4,68,2],[92,4,69,2],[93,4,70,2],[93,8,70,8,"matchesQuery"],[93,20,70,20],[93,23,70,23],[93,27,70,23,"useQuery"],[93,46,70,31],[93,47,70,31,"useQuery"],[93,55,70,31],[93,57,70,32],[94,6,71,4,"queryKey"],[94,14,71,12],[94,16,71,14],[94,17,71,15],[94,34,71,32],[94,36,71,34,"userId"],[94,42,71,40],[94,43,71,41],[95,6,72,4,"enabled"],[95,13,72,11],[95,15,72,13,"Number"],[95,21,72,19],[95,22,72,20,"isFinite"],[95,30,72,28],[95,31,72,29,"Number"],[95,37,72,35],[95,38,72,36,"userId"],[95,44,72,42],[95,45,72,43],[95,46,72,44],[96,6,73,4,"queryFn"],[96,13,73,11],[97,8,73,11],[97,12,73,11,"_ref2"],[97,17,73,11],[97,24,73,11,"_asyncToGenerator"],[97,41,73,11],[97,42,73,11,"default"],[97,49,73,11],[97,51,73,13],[97,64,73,25],[98,10,74,6],[98,14,74,12,"response"],[98,22,74,20],[98,31,74,29,"fetch"],[98,36,74,34],[98,37,74,35],[98,60,74,58,"userId"],[98,66,74,64],[98,68,74,66],[98,69,74,67],[99,10,75,6],[99,14,75,10],[99,15,75,11,"response"],[99,23,75,19],[99,24,75,20,"ok"],[99,26,75,22],[99,28,75,24],[100,12,76,8],[100,18,76,14],[100,22,76,18,"Error"],[100,27,76,23],[100,28,77,10],[100,87,77,69,"response"],[100,95,77,77],[100,96,77,78,"status"],[100,102,77,84],[100,107,77,89,"response"],[100,115,77,97],[100,116,77,98,"statusText"],[100,126,77,108],[100,128,78,8],[100,129,78,9],[101,10,79,6],[102,10,80,6],[102,17,80,13,"response"],[102,25,80,21],[102,26,80,22,"json"],[102,30,80,26],[102,31,80,27],[102,32,80,28],[103,8,81,4],[103,9,81,5],[104,8,81,5],[104,24,73,4,"queryFn"],[104,31,73,11,"queryFn"],[104,32,73,11],[105,10,73,11],[105,17,73,11,"_ref2"],[105,22,73,11],[105,23,73,11,"apply"],[105,28,73,11],[105,35,73,11,"arguments"],[105,44,73,11],[106,8,73,11],[107,6,73,11],[107,9,81,5],[108,6,82,4,"refetchInterval"],[108,21,82,19],[108,23,82,21],[108,27,82,25],[109,6,83,4,"refetchIntervalInBackground"],[109,33,83,31],[109,35,83,33],[109,39,83,37],[110,6,84,4,"staleTime"],[110,15,84,13],[110,17,84,15],[111,4,85,2],[111,5,85,3],[111,6,85,4],[112,4,87,2],[112,8,87,8,"matches"],[112,15,87,15],[112,18,87,18,"Array"],[112,23,87,23],[112,24,87,24,"isArray"],[112,31,87,31],[112,32,87,32,"matchesQuery"],[112,44,87,44],[112,45,87,45,"data"],[112,49,87,49],[112,51,87,51,"matches"],[112,58,87,58],[112,59,87,59],[112,62,88,6,"matchesQuery"],[112,74,88,18],[112,75,88,19,"data"],[112,79,88,23],[112,80,88,24,"matches"],[112,87,88,31],[112,90,89,6],[112,92,89,8],[113,4,91,2],[113,8,91,8,"unseenMatches"],[113,21,91,21],[113,24,91,24,"matches"],[113,31,91,31],[113,32,91,32,"reduce"],[113,38,91,38],[113,39,91,39],[113,40,91,40,"sum"],[113,43,91,43],[113,45,91,45,"m"],[113,46,91,46],[113,51,91,51],[114,6,92,4],[114,13,92,11,"sum"],[114,16,92,14],[114,20,92,18,"m"],[114,21,92,19],[114,23,92,21,"is_new_match"],[114,35,92,33],[114,38,92,36],[114,39,92,37],[114,42,92,40],[114,43,92,41],[114,44,92,42],[115,4,93,2],[115,5,93,3],[115,7,93,5],[115,8,93,6],[115,9,93,7],[116,4,95,2],[116,8,95,8,"unreadMessages"],[116,22,95,22],[116,25,95,25,"matches"],[116,32,95,32],[116,33,95,33,"reduce"],[116,39,95,39],[116,40,95,40],[116,41,95,41,"sum"],[116,44,95,44],[116,46,95,46,"m"],[116,47,95,47],[116,52,95,52],[117,6,96,4],[117,10,96,10,"n"],[117,11,96,11],[117,14,96,14,"Number"],[117,20,96,20],[117,21,96,21,"m"],[117,22,96,22],[117,24,96,24,"unread_count"],[117,36,96,36],[117,37,96,37],[117,41,96,41],[117,42,96,42],[118,6,97,4],[118,13,97,11,"sum"],[118,16,97,14],[118,19,97,17,"n"],[118,20,97,18],[119,4,98,2],[119,5,98,3],[119,7,98,5],[119,8,98,6],[119,9,98,7],[120,4,100,2],[120,8,100,8,"badgeCount"],[120,18,100,18],[120,21,100,21,"unseenMatches"],[120,34,100,34],[120,37,100,37,"unreadMessages"],[120,51,100,51],[121,4,102,2],[121,11,102,9],[122,6,103,4,"userId"],[122,12,103,10],[123,6,104,4,"unseenMatches"],[123,19,104,17],[124,6,105,4,"unreadMessages"],[124,20,105,18],[125,6,106,4,"badgeCount"],[125,16,106,14],[126,6,107,4,"isLoading"],[126,15,107,13],[126,17,107,15,"matchesQuery"],[126,29,107,27],[126,30,107,28,"isLoading"],[126,39,107,37],[127,6,108,4,"refetch"],[127,13,108,11],[127,15,108,13,"matchesQuery"],[127,27,108,25],[127,28,108,26,"refetch"],[128,4,109,2],[128,5,109,3],[129,2,110,0],[130,0,110,1],[130,3]],"functionMap":{"names":["<global>","useMatchesBadge","useEffect$argument_0","load","load.then$argument_0","setInterval$argument_0","<anonymous>","useQuery$argument_0.queryFn","matches.reduce$argument_0"],"mappings":"AAA;eCI;YCI;iBCG;KDuB;gBEI;oCCQ;oBDE;SCM;ODC;KFC;WIE;KJM;GDC;aMO;KNQ;uCOU;GPE;wCOE;GPG;CDY"},"hasCjsExports":false},"type":"js/module"}]}