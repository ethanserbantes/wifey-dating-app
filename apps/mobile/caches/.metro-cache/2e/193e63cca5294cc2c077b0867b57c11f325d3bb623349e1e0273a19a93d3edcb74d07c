{"dependencies":[{"name":"react","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":52,"index":52}}],"key":"RtGiGa+/H7VrI7GDQDLhO1UbpU8=","exportNames":["*"],"imports":1}},{"name":"@react-native-async-storage/async-storage","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":53},"end":{"line":2,"column":69,"index":122}}],"key":"0kSRlooyBOaYM9tlTtK91nq+uds=","exportNames":["*"],"imports":1}},{"name":"@tanstack/react-query","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":123},"end":{"line":3,"column":49,"index":172}}],"key":"Pzwu/0TIyhnZOrC9PAkpZx92hFo=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  Object.defineProperty(exports, \"default\", {\n    enumerable: true,\n    get: function () {\n      return useMatchesBadge;\n    }\n  });\n  var _react = require(_dependencyMap[0], \"react\");\n  var _reactNativeAsyncStorageAsyncStorage = require(_dependencyMap[1], \"@react-native-async-storage/async-storage\");\n  var AsyncStorage = _interopDefault(_reactNativeAsyncStorageAsyncStorage);\n  var _tanstackReactQuery = require(_dependencyMap[2], \"@tanstack/react-query\");\n  function useMatchesBadge() {\n    const [userId, setUserId] = (0, _react.useState)(null);\n    const pollRef = (0, _react.useRef)(null);\n    (0, _react.useEffect)(() => {\n      let cancelled = false;\n      const load = async () => {\n        try {\n          const raw = await AsyncStorage.default.getItem(\"user\");\n          if (!raw) {\n            if (!cancelled) setUserId(null);\n            return false;\n          }\n          const user = JSON.parse(raw);\n\n          // IMPORTANT: normalize to a number so react-query keys match invalidations\n          // elsewhere in the app (which always use Number(userId)).\n          const parsed = Number(user?.id);\n          const nextId = Number.isFinite(parsed) ? parsed : null;\n          if (!cancelled) {\n            setUserId(nextId);\n          }\n          return Boolean(nextId);\n        } catch (e) {\n          console.error(e);\n          if (!cancelled) setUserId(null);\n          return false;\n        }\n      };\n\n      // IMPORTANT: Root layouts can mount before login finishes.\n      // Keep checking until a user appears so the badge works right after sign-in.\n      load().then(found => {\n        if (cancelled) return;\n        if (found) return;\n        if (pollRef.current) {\n          clearInterval(pollRef.current);\n        }\n        pollRef.current = setInterval(() => {\n          if (cancelled) return;\n          load().then(nowFound => {\n            if (cancelled) return;\n            if (nowFound && pollRef.current) {\n              clearInterval(pollRef.current);\n              pollRef.current = null;\n            }\n          });\n        }, 1500);\n      });\n      return () => {\n        cancelled = true;\n        if (pollRef.current) {\n          clearInterval(pollRef.current);\n          pollRef.current = null;\n        }\n      };\n    }, []);\n\n    // IMPORTANT: We use the same /api/matches endpoint as the Messages screen.\n    // This avoids the \"badge shows 0 until I open Messages\" problem.\n    const matchesQuery = (0, _tanstackReactQuery.useQuery)({\n      queryKey: [\"matchesForBadge\", userId],\n      enabled: Number.isFinite(Number(userId)),\n      queryFn: async () => {\n        const response = await fetch(`/api/matches?userId=${userId}`);\n        if (!response.ok) {\n          throw new Error(`When fetching /api/matches for badge, the response was [${response.status}] ${response.statusText}`);\n        }\n        return response.json();\n      },\n      refetchInterval: 2000,\n      refetchIntervalInBackground: true,\n      staleTime: 0\n    });\n    const matches = Array.isArray(matchesQuery.data?.matches) ? matchesQuery.data.matches : [];\n    const unseenMatches = matches.reduce((sum, m) => {\n      return sum + (m?.is_new_match ? 1 : 0);\n    }, 0);\n    const unreadMessages = matches.reduce((sum, m) => {\n      const n = Number(m?.unread_count) || 0;\n      return sum + n;\n    }, 0);\n    const badgeCount = unseenMatches + unreadMessages;\n    return {\n      userId,\n      unseenMatches,\n      unreadMessages,\n      badgeCount,\n      isLoading: matchesQuery.isLoading,\n      refetch: matchesQuery.refetch\n    };\n  }\n});","lineCount":113,"map":[[12,2,5,15,"Object"],[12,8,5,15],[12,9,5,15,"defineProperty"],[12,23,5,15],[12,24,5,15,"exports"],[12,31,5,15],[13,4,5,15,"enumerable"],[13,14,5,15],[14,4,5,15,"get"],[14,7,5,15],[14,18,5,15,"get"],[14,19,5,15],[15,6,5,15],[15,13,5,15,"useMatchesBadge"],[15,28,5,15],[16,4,5,15],[17,2,5,15],[18,2,1,0],[18,6,1,0,"_react"],[18,12,1,0],[18,15,1,0,"require"],[18,22,1,0],[18,23,1,0,"_dependencyMap"],[18,37,1,0],[19,2,2,0],[19,6,2,0,"_reactNativeAsyncStorageAsyncStorage"],[19,42,2,0],[19,45,2,0,"require"],[19,52,2,0],[19,53,2,0,"_dependencyMap"],[19,67,2,0],[20,2,2,0],[20,6,2,0,"AsyncStorage"],[20,18,2,0],[20,21,2,0,"_interopDefault"],[20,36,2,0],[20,37,2,0,"_reactNativeAsyncStorageAsyncStorage"],[20,73,2,0],[21,2,3,0],[21,6,3,0,"_tanstackReactQuery"],[21,25,3,0],[21,28,3,0,"require"],[21,35,3,0],[21,36,3,0,"_dependencyMap"],[21,50,3,0],[22,2,5,15],[22,11,5,24,"useMatchesBadge"],[22,26,5,39,"useMatchesBadge"],[22,27,5,39],[22,29,5,42],[23,4,6,2],[23,10,6,8],[23,11,6,9,"userId"],[23,17,6,15],[23,19,6,17,"setUserId"],[23,28,6,26],[23,29,6,27],[23,32,6,30],[23,36,6,30,"useState"],[23,42,6,38],[23,43,6,38,"useState"],[23,51,6,38],[23,53,6,39],[23,57,6,43],[23,58,6,44],[24,4,7,2],[24,10,7,8,"pollRef"],[24,17,7,15],[24,20,7,18],[24,24,7,18,"useRef"],[24,30,7,24],[24,31,7,24,"useRef"],[24,37,7,24],[24,39,7,25],[24,43,7,29],[24,44,7,30],[25,4,9,2],[25,8,9,2,"useEffect"],[25,14,9,11],[25,15,9,11,"useEffect"],[25,24,9,11],[25,26,9,12],[25,32,9,18],[26,6,10,4],[26,10,10,8,"cancelled"],[26,19,10,17],[26,22,10,20],[26,27,10,25],[27,6,12,4],[27,12,12,10,"load"],[27,16,12,14],[27,19,12,17],[27,25,12,17,"load"],[27,26,12,17],[27,31,12,29],[28,8,13,6],[28,12,13,10],[29,10,14,8],[29,16,14,14,"raw"],[29,19,14,17],[29,22,14,20],[29,28,14,26,"AsyncStorage"],[29,40,14,38],[29,41,14,38,"default"],[29,48,14,38],[29,49,14,39,"getItem"],[29,56,14,46],[29,57,14,47],[29,63,14,53],[29,64,14,54],[30,10,15,8],[30,14,15,12],[30,15,15,13,"raw"],[30,18,15,16],[30,20,15,18],[31,12,16,10],[31,16,16,14],[31,17,16,15,"cancelled"],[31,26,16,24],[31,28,16,26,"setUserId"],[31,37,16,35],[31,38,16,36],[31,42,16,40],[31,43,16,41],[32,12,17,10],[32,19,17,17],[32,24,17,22],[33,10,18,8],[34,10,19,8],[34,16,19,14,"user"],[34,20,19,18],[34,23,19,21,"JSON"],[34,27,19,25],[34,28,19,26,"parse"],[34,33,19,31],[34,34,19,32,"raw"],[34,37,19,35],[34,38,19,36],[36,10,21,8],[37,10,22,8],[38,10,23,8],[38,16,23,14,"parsed"],[38,22,23,20],[38,25,23,23,"Number"],[38,31,23,29],[38,32,23,30,"user"],[38,36,23,34],[38,38,23,36,"id"],[38,40,23,38],[38,41,23,39],[39,10,24,8],[39,16,24,14,"nextId"],[39,22,24,20],[39,25,24,23,"Number"],[39,31,24,29],[39,32,24,30,"isFinite"],[39,40,24,38],[39,41,24,39,"parsed"],[39,47,24,45],[39,48,24,46],[39,51,24,49,"parsed"],[39,57,24,55],[39,60,24,58],[39,64,24,62],[40,10,26,8],[40,14,26,12],[40,15,26,13,"cancelled"],[40,24,26,22],[40,26,26,24],[41,12,27,10,"setUserId"],[41,21,27,19],[41,22,27,20,"nextId"],[41,28,27,26],[41,29,27,27],[42,10,28,8],[43,10,29,8],[43,17,29,15,"Boolean"],[43,24,29,22],[43,25,29,23,"nextId"],[43,31,29,29],[43,32,29,30],[44,8,30,6],[44,9,30,7],[44,10,30,8],[44,17,30,15,"e"],[44,18,30,16],[44,20,30,18],[45,10,31,8,"console"],[45,17,31,15],[45,18,31,16,"error"],[45,23,31,21],[45,24,31,22,"e"],[45,25,31,23],[45,26,31,24],[46,10,32,8],[46,14,32,12],[46,15,32,13,"cancelled"],[46,24,32,22],[46,26,32,24,"setUserId"],[46,35,32,33],[46,36,32,34],[46,40,32,38],[46,41,32,39],[47,10,33,8],[47,17,33,15],[47,22,33,20],[48,8,34,6],[49,6,35,4],[49,7,35,5],[51,6,37,4],[52,6,38,4],[53,6,39,4,"load"],[53,10,39,8],[53,11,39,9],[53,12,39,10],[53,13,39,11,"then"],[53,17,39,15],[53,18,39,17,"found"],[53,23,39,22],[53,27,39,27],[54,8,40,6],[54,12,40,10,"cancelled"],[54,21,40,19],[54,23,40,21],[55,8,41,6],[55,12,41,10,"found"],[55,17,41,15],[55,19,41,17],[56,8,43,6],[56,12,43,10,"pollRef"],[56,19,43,17],[56,20,43,18,"current"],[56,27,43,25],[56,29,43,27],[57,10,44,8,"clearInterval"],[57,23,44,21],[57,24,44,22,"pollRef"],[57,31,44,29],[57,32,44,30,"current"],[57,39,44,37],[57,40,44,38],[58,8,45,6],[59,8,47,6,"pollRef"],[59,15,47,13],[59,16,47,14,"current"],[59,23,47,21],[59,26,47,24,"setInterval"],[59,37,47,35],[59,38,47,36],[59,44,47,42],[60,10,48,8],[60,14,48,12,"cancelled"],[60,23,48,21],[60,25,48,23],[61,10,49,8,"load"],[61,14,49,12],[61,15,49,13],[61,16,49,14],[61,17,49,15,"then"],[61,21,49,19],[61,22,49,21,"nowFound"],[61,30,49,29],[61,34,49,34],[62,12,50,10],[62,16,50,14,"cancelled"],[62,25,50,23],[62,27,50,25],[63,12,51,10],[63,16,51,14,"nowFound"],[63,24,51,22],[63,28,51,26,"pollRef"],[63,35,51,33],[63,36,51,34,"current"],[63,43,51,41],[63,45,51,43],[64,14,52,12,"clearInterval"],[64,27,52,25],[64,28,52,26,"pollRef"],[64,35,52,33],[64,36,52,34,"current"],[64,43,52,41],[64,44,52,42],[65,14,53,12,"pollRef"],[65,21,53,19],[65,22,53,20,"current"],[65,29,53,27],[65,32,53,30],[65,36,53,34],[66,12,54,10],[67,10,55,8],[67,11,55,9],[67,12,55,10],[68,8,56,6],[68,9,56,7],[68,11,56,9],[68,15,56,13],[68,16,56,14],[69,6,57,4],[69,7,57,5],[69,8,57,6],[70,6,59,4],[70,13,59,11],[70,19,59,17],[71,8,60,6,"cancelled"],[71,17,60,15],[71,20,60,18],[71,24,60,22],[72,8,61,6],[72,12,61,10,"pollRef"],[72,19,61,17],[72,20,61,18,"current"],[72,27,61,25],[72,29,61,27],[73,10,62,8,"clearInterval"],[73,23,62,21],[73,24,62,22,"pollRef"],[73,31,62,29],[73,32,62,30,"current"],[73,39,62,37],[73,40,62,38],[74,10,63,8,"pollRef"],[74,17,63,15],[74,18,63,16,"current"],[74,25,63,23],[74,28,63,26],[74,32,63,30],[75,8,64,6],[76,6,65,4],[76,7,65,5],[77,4,66,2],[77,5,66,3],[77,7,66,5],[77,9,66,7],[77,10,66,8],[79,4,68,2],[80,4,69,2],[81,4,70,2],[81,10,70,8,"matchesQuery"],[81,22,70,20],[81,25,70,23],[81,29,70,23,"useQuery"],[81,48,70,31],[81,49,70,31,"useQuery"],[81,57,70,31],[81,59,70,32],[82,6,71,4,"queryKey"],[82,14,71,12],[82,16,71,14],[82,17,71,15],[82,34,71,32],[82,36,71,34,"userId"],[82,42,71,40],[82,43,71,41],[83,6,72,4,"enabled"],[83,13,72,11],[83,15,72,13,"Number"],[83,21,72,19],[83,22,72,20,"isFinite"],[83,30,72,28],[83,31,72,29,"Number"],[83,37,72,35],[83,38,72,36,"userId"],[83,44,72,42],[83,45,72,43],[83,46,72,44],[84,6,73,4,"queryFn"],[84,13,73,11],[84,15,73,13],[84,21,73,13,"queryFn"],[84,22,73,13],[84,27,73,25],[85,8,74,6],[85,14,74,12,"response"],[85,22,74,20],[85,25,74,23],[85,31,74,29,"fetch"],[85,36,74,34],[85,37,74,35],[85,60,74,58,"userId"],[85,66,74,64],[85,68,74,66],[85,69,74,67],[86,8,75,6],[86,12,75,10],[86,13,75,11,"response"],[86,21,75,19],[86,22,75,20,"ok"],[86,24,75,22],[86,26,75,24],[87,10,76,8],[87,16,76,14],[87,20,76,18,"Error"],[87,25,76,23],[87,26,77,10],[87,85,77,69,"response"],[87,93,77,77],[87,94,77,78,"status"],[87,100,77,84],[87,105,77,89,"response"],[87,113,77,97],[87,114,77,98,"statusText"],[87,124,77,108],[87,126,78,8],[87,127,78,9],[88,8,79,6],[89,8,80,6],[89,15,80,13,"response"],[89,23,80,21],[89,24,80,22,"json"],[89,28,80,26],[89,29,80,27],[89,30,80,28],[90,6,81,4],[90,7,81,5],[91,6,82,4,"refetchInterval"],[91,21,82,19],[91,23,82,21],[91,27,82,25],[92,6,83,4,"refetchIntervalInBackground"],[92,33,83,31],[92,35,83,33],[92,39,83,37],[93,6,84,4,"staleTime"],[93,15,84,13],[93,17,84,15],[94,4,85,2],[94,5,85,3],[94,6,85,4],[95,4,87,2],[95,10,87,8,"matches"],[95,17,87,15],[95,20,87,18,"Array"],[95,25,87,23],[95,26,87,24,"isArray"],[95,33,87,31],[95,34,87,32,"matchesQuery"],[95,46,87,44],[95,47,87,45,"data"],[95,51,87,49],[95,53,87,51,"matches"],[95,60,87,58],[95,61,87,59],[95,64,88,6,"matchesQuery"],[95,76,88,18],[95,77,88,19,"data"],[95,81,88,23],[95,82,88,24,"matches"],[95,89,88,31],[95,92,89,6],[95,94,89,8],[96,4,91,2],[96,10,91,8,"unseenMatches"],[96,23,91,21],[96,26,91,24,"matches"],[96,33,91,31],[96,34,91,32,"reduce"],[96,40,91,38],[96,41,91,39],[96,42,91,40,"sum"],[96,45,91,43],[96,47,91,45,"m"],[96,48,91,46],[96,53,91,51],[97,6,92,4],[97,13,92,11,"sum"],[97,16,92,14],[97,20,92,18,"m"],[97,21,92,19],[97,23,92,21,"is_new_match"],[97,35,92,33],[97,38,92,36],[97,39,92,37],[97,42,92,40],[97,43,92,41],[97,44,92,42],[98,4,93,2],[98,5,93,3],[98,7,93,5],[98,8,93,6],[98,9,93,7],[99,4,95,2],[99,10,95,8,"unreadMessages"],[99,24,95,22],[99,27,95,25,"matches"],[99,34,95,32],[99,35,95,33,"reduce"],[99,41,95,39],[99,42,95,40],[99,43,95,41,"sum"],[99,46,95,44],[99,48,95,46,"m"],[99,49,95,47],[99,54,95,52],[100,6,96,4],[100,12,96,10,"n"],[100,13,96,11],[100,16,96,14,"Number"],[100,22,96,20],[100,23,96,21,"m"],[100,24,96,22],[100,26,96,24,"unread_count"],[100,38,96,36],[100,39,96,37],[100,43,96,41],[100,44,96,42],[101,6,97,4],[101,13,97,11,"sum"],[101,16,97,14],[101,19,97,17,"n"],[101,20,97,18],[102,4,98,2],[102,5,98,3],[102,7,98,5],[102,8,98,6],[102,9,98,7],[103,4,100,2],[103,10,100,8,"badgeCount"],[103,20,100,18],[103,23,100,21,"unseenMatches"],[103,36,100,34],[103,39,100,37,"unreadMessages"],[103,53,100,51],[104,4,102,2],[104,11,102,9],[105,6,103,4,"userId"],[105,12,103,10],[106,6,104,4,"unseenMatches"],[106,19,104,17],[107,6,105,4,"unreadMessages"],[107,20,105,18],[108,6,106,4,"badgeCount"],[108,16,106,14],[109,6,107,4,"isLoading"],[109,15,107,13],[109,17,107,15,"matchesQuery"],[109,29,107,27],[109,30,107,28,"isLoading"],[109,39,107,37],[110,6,108,4,"refetch"],[110,13,108,11],[110,15,108,13,"matchesQuery"],[110,27,108,25],[110,28,108,26,"refetch"],[111,4,109,2],[111,5,109,3],[112,2,110,0],[113,0,110,1],[113,3]],"functionMap":{"names":["<global>","useMatchesBadge","useEffect$argument_0","load","load.then$argument_0","setInterval$argument_0","<anonymous>","useQuery$argument_0.queryFn","matches.reduce$argument_0"],"mappings":"AAA;eCI;YCI;iBCG;KDuB;gBEI;oCCQ;oBDE;SCM;ODC;KFC;WIE;KJM;GDC;aMO;KNQ;uCOU;GPE;wCOE;GPG;CDY"},"hasCjsExports":false},"type":"js/module"}]}