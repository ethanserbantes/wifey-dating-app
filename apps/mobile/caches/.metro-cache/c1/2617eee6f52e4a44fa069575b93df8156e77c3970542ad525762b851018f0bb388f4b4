{"dependencies":[{"name":"@babel/runtime/helpers/slicedToArray","data":{"asyncType":null,"isESMImport":false,"locs":[],"key":"5y7e5+zC7teYEEC6niD9f5zII1M=","exportNames":["*"],"imports":1}},{"name":"../../currentScopes.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":51,"index":51}}],"key":"wyofRZtYR2H2+OElRwz4anlbKJw=","exportNames":["*"],"imports":1}},{"name":"../../tracing/spanstatus.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":52},"end":{"line":2,"column":64,"index":116}}],"key":"xTnLe4eZ8UwJZsOO8L+5TFoq+AE=","exportNames":["*"],"imports":1}},{"name":"./piiFiltering.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":117},"end":{"line":3,"column":61,"index":178}}],"key":"g8Iorv1/7lRJCYn1bQz8ezoQumo=","exportNames":["*"],"imports":1}},{"name":"./resultExtraction.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":4,"column":0,"index":179},"end":{"line":4,"column":99,"index":278}}],"key":"9tSfyC9Xqnyu5xaUHnRnNhIZQoE=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  Object.defineProperty(exports, \"cleanupPendingSpansForTransport\", {\n    enumerable: true,\n    get: function () {\n      return cleanupPendingSpansForTransport;\n    }\n  });\n  Object.defineProperty(exports, \"completeSpanWithResults\", {\n    enumerable: true,\n    get: function () {\n      return completeSpanWithResults;\n    }\n  });\n  Object.defineProperty(exports, \"storeSpanForRequest\", {\n    enumerable: true,\n    get: function () {\n      return storeSpanForRequest;\n    }\n  });\n  var _babelRuntimeHelpersSlicedToArray = require(_dependencyMap[0]);\n  var _slicedToArray = _interopDefault(_babelRuntimeHelpersSlicedToArray);\n  var _currentScopesJs = require(_dependencyMap[1]);\n  var _tracingSpanstatusJs = require(_dependencyMap[2]);\n  var _piiFilteringJs = require(_dependencyMap[3]);\n  var _resultExtractionJs = require(_dependencyMap[4]);\n  /**\n   * Request-span correlation system for MCP server instrumentation\n   *\n   * Handles mapping requestId to span data for correlation with handler execution.\n   * Uses WeakMap to scope correlation maps per transport instance, preventing\n   * request ID collisions between different MCP sessions.\n   */\n\n  /**\n   * Transport-scoped correlation system that prevents collisions between different MCP sessions\n   * @internal Each transport instance gets its own correlation map, eliminating request ID conflicts\n   */\n  var transportToSpanMap = new WeakMap();\n\n  /**\n   * Gets or creates the span map for a specific transport instance\n   * @internal\n   * @param transport - MCP transport instance\n   * @returns Span map for the transport\n   */\n  function getOrCreateSpanMap(transport) {\n    var spanMap = transportToSpanMap.get(transport);\n    if (!spanMap) {\n      spanMap = new Map();\n      transportToSpanMap.set(transport, spanMap);\n    }\n    return spanMap;\n  }\n\n  /**\n   * Stores span context for later correlation with handler execution\n   * @param transport - MCP transport instance\n   * @param requestId - Request identifier\n   * @param span - Active span to correlate\n   * @param method - MCP method name\n   */\n  function storeSpanForRequest(transport, requestId, span, method) {\n    var spanMap = getOrCreateSpanMap(transport);\n    spanMap.set(requestId, {\n      span,\n      method,\n      startTime: Date.now()\n    });\n  }\n\n  /**\n   * Completes span with tool results and cleans up correlation\n   * @param transport - MCP transport instance\n   * @param requestId - Request identifier\n   * @param result - Tool execution result for attribute extraction\n   */\n  function completeSpanWithResults(transport, requestId, result) {\n    var spanMap = getOrCreateSpanMap(transport);\n    var spanData = spanMap.get(requestId);\n    if (spanData) {\n      var span = spanData.span,\n        method = spanData.method;\n      if (method === 'tools/call') {\n        var rawToolAttributes = (0, _resultExtractionJs.extractToolResultAttributes)(result);\n        var client = (0, _currentScopesJs.getClient)();\n        var sendDefaultPii = Boolean(client?.getOptions().sendDefaultPii);\n        var toolAttributes = (0, _piiFilteringJs.filterMcpPiiFromSpanData)(rawToolAttributes, sendDefaultPii);\n        span.setAttributes(toolAttributes);\n      } else if (method === 'prompts/get') {\n        var rawPromptAttributes = (0, _resultExtractionJs.extractPromptResultAttributes)(result);\n        var _client = (0, _currentScopesJs.getClient)();\n        var _sendDefaultPii = Boolean(_client?.getOptions().sendDefaultPii);\n        var promptAttributes = (0, _piiFilteringJs.filterMcpPiiFromSpanData)(rawPromptAttributes, _sendDefaultPii);\n        span.setAttributes(promptAttributes);\n      }\n      span.end();\n      spanMap.delete(requestId);\n    }\n  }\n\n  /**\n   * Cleans up pending spans for a specific transport (when that transport closes)\n   * @param transport - MCP transport instance\n   */\n  function cleanupPendingSpansForTransport(transport) {\n    var spanMap = transportToSpanMap.get(transport);\n    if (spanMap) {\n      for (var _ref of spanMap) {\n        var _ref2 = (0, _slicedToArray.default)(_ref, 2);\n        var spanData = _ref2[1];\n        spanData.span.setStatus({\n          code: _tracingSpanstatusJs.SPAN_STATUS_ERROR,\n          message: 'cancelled'\n        });\n        spanData.span.end();\n      }\n      spanMap.clear();\n    }\n  }\n});","lineCount":130,"map":[[12,2,103,0,"Object"],[12,8,103,0],[12,9,103,0,"defineProperty"],[12,23,103,0],[12,24,103,0,"exports"],[12,31,103,0],[13,4,103,0,"enumerable"],[13,14,103,0],[14,4,103,0,"get"],[14,7,103,0],[14,18,103,0,"get"],[14,19,103,0],[15,6,103,0],[15,13,103,9,"cleanupPendingSpansForTransport"],[15,44,103,40],[16,4,103,40],[17,2,103,40],[18,2,103,0,"Object"],[18,8,103,0],[18,9,103,0,"defineProperty"],[18,23,103,0],[18,24,103,0,"exports"],[18,31,103,0],[19,4,103,0,"enumerable"],[19,14,103,0],[20,4,103,0,"get"],[20,7,103,0],[20,18,103,0,"get"],[20,19,103,0],[21,6,103,0],[21,13,103,42,"completeSpanWithResults"],[21,36,103,65],[22,4,103,65],[23,2,103,65],[24,2,103,0,"Object"],[24,8,103,0],[24,9,103,0,"defineProperty"],[24,23,103,0],[24,24,103,0,"exports"],[24,31,103,0],[25,4,103,0,"enumerable"],[25,14,103,0],[26,4,103,0,"get"],[26,7,103,0],[26,18,103,0,"get"],[26,19,103,0],[27,6,103,0],[27,13,103,67,"storeSpanForRequest"],[27,32,103,86],[28,4,103,86],[29,2,103,86],[30,2,103,89],[30,6,103,89,"_babelRuntimeHelpersSlicedToArray"],[30,39,103,89],[30,42,103,89,"require"],[30,49,103,89],[30,50,103,89,"_dependencyMap"],[30,64,103,89],[31,2,103,89],[31,6,103,89,"_slicedToArray"],[31,20,103,89],[31,23,103,89,"_interopDefault"],[31,38,103,89],[31,39,103,89,"_babelRuntimeHelpersSlicedToArray"],[31,72,103,89],[32,2,1,0],[32,6,1,0,"_currentScopesJs"],[32,22,1,0],[32,25,1,0,"require"],[32,32,1,0],[32,33,1,0,"_dependencyMap"],[32,47,1,0],[33,2,2,0],[33,6,2,0,"_tracingSpanstatusJs"],[33,26,2,0],[33,29,2,0,"require"],[33,36,2,0],[33,37,2,0,"_dependencyMap"],[33,51,2,0],[34,2,3,0],[34,6,3,0,"_piiFilteringJs"],[34,21,3,0],[34,24,3,0,"require"],[34,31,3,0],[34,32,3,0,"_dependencyMap"],[34,46,3,0],[35,2,4,0],[35,6,4,0,"_resultExtractionJs"],[35,25,4,0],[35,28,4,0,"require"],[35,35,4,0],[35,36,4,0,"_dependencyMap"],[35,50,4,0],[36,2,6,0],[37,0,7,0],[38,0,8,0],[39,0,9,0],[40,0,10,0],[41,0,11,0],[42,0,12,0],[44,2,15,0],[45,0,16,0],[46,0,17,0],[47,0,18,0],[48,2,19,0],[48,6,19,6,"transportToSpanMap"],[48,24,19,24],[48,27,19,27],[48,31,19,31,"WeakMap"],[48,38,19,38],[48,39,19,39],[48,40,19,40],[50,2,21,0],[51,0,22,0],[52,0,23,0],[53,0,24,0],[54,0,25,0],[55,0,26,0],[56,2,27,0],[56,11,27,9,"getOrCreateSpanMap"],[56,29,27,27,"getOrCreateSpanMap"],[56,30,27,28,"transport"],[56,39,27,37],[56,41,27,39],[57,4,28,2],[57,8,28,6,"spanMap"],[57,15,28,13],[57,18,28,16,"transportToSpanMap"],[57,36,28,34],[57,37,28,35,"get"],[57,40,28,38],[57,41,28,39,"transport"],[57,50,28,48],[57,51,28,49],[58,4,29,2],[58,8,29,6],[58,9,29,7,"spanMap"],[58,16,29,14],[58,18,29,16],[59,6,30,4,"spanMap"],[59,13,30,11],[59,16,30,14],[59,20,30,18,"Map"],[59,23,30,21],[59,24,30,22],[59,25,30,23],[60,6,31,4,"transportToSpanMap"],[60,24,31,22],[60,25,31,23,"set"],[60,28,31,26],[60,29,31,27,"transport"],[60,38,31,36],[60,40,31,38,"spanMap"],[60,47,31,45],[60,48,31,46],[61,4,32,2],[62,4,33,2],[62,11,33,9,"spanMap"],[62,18,33,16],[63,2,34,0],[65,2,36,0],[66,0,37,0],[67,0,38,0],[68,0,39,0],[69,0,40,0],[70,0,41,0],[71,0,42,0],[72,2,43,0],[72,11,43,9,"storeSpanForRequest"],[72,30,43,28,"storeSpanForRequest"],[72,31,43,29,"transport"],[72,40,43,38],[72,42,43,40,"requestId"],[72,51,43,49],[72,53,43,51,"span"],[72,57,43,55],[72,59,43,57,"method"],[72,65,43,63],[72,67,43,65],[73,4,44,2],[73,8,44,8,"spanMap"],[73,15,44,15],[73,18,44,18,"getOrCreateSpanMap"],[73,36,44,36],[73,37,44,37,"transport"],[73,46,44,46],[73,47,44,47],[74,4,45,2,"spanMap"],[74,11,45,9],[74,12,45,10,"set"],[74,15,45,13],[74,16,45,14,"requestId"],[74,25,45,23],[74,27,45,25],[75,6,46,4,"span"],[75,10,46,8],[76,6,47,4,"method"],[76,12,47,10],[77,6,48,4,"startTime"],[77,15,48,13],[77,17,48,15,"Date"],[77,21,48,19],[77,22,48,20,"now"],[77,25,48,23],[77,26,48,24],[78,4,49,2],[78,5,49,3],[78,6,49,4],[79,2,50,0],[81,2,52,0],[82,0,53,0],[83,0,54,0],[84,0,55,0],[85,0,56,0],[86,0,57,0],[87,2,58,0],[87,11,58,9,"completeSpanWithResults"],[87,34,58,32,"completeSpanWithResults"],[87,35,58,33,"transport"],[87,44,58,42],[87,46,58,44,"requestId"],[87,55,58,53],[87,57,58,55,"result"],[87,63,58,61],[87,65,58,63],[88,4,59,2],[88,8,59,8,"spanMap"],[88,15,59,15],[88,18,59,18,"getOrCreateSpanMap"],[88,36,59,36],[88,37,59,37,"transport"],[88,46,59,46],[88,47,59,47],[89,4,60,2],[89,8,60,8,"spanData"],[89,16,60,16],[89,19,60,19,"spanMap"],[89,26,60,26],[89,27,60,27,"get"],[89,30,60,30],[89,31,60,31,"requestId"],[89,40,60,40],[89,41,60,41],[90,4,61,2],[90,8,61,6,"spanData"],[90,16,61,14],[90,18,61,16],[91,6,62,4],[91,10,62,12,"span"],[91,14,62,16],[91,17,62,29,"spanData"],[91,25,62,37],[91,26,62,12,"span"],[91,30,62,16],[92,8,62,18,"method"],[92,14,62,24],[92,17,62,29,"spanData"],[92,25,62,37],[92,26,62,18,"method"],[92,32,62,24],[93,6,64,4],[93,10,64,8,"method"],[93,16,64,14],[93,21,64,19],[93,33,64,31],[93,35,64,33],[94,8,65,6],[94,12,65,12,"rawToolAttributes"],[94,29,65,29],[94,32,65,32],[94,36,65,32,"extractToolResultAttributes"],[94,55,65,59],[94,56,65,59,"extractToolResultAttributes"],[94,83,65,59],[94,85,65,60,"result"],[94,91,65,66],[94,92,65,67],[95,8,66,6],[95,12,66,12,"client"],[95,18,66,18],[95,21,66,21],[95,25,66,21,"getClient"],[95,41,66,30],[95,42,66,30,"getClient"],[95,51,66,30],[95,53,66,31],[95,54,66,32],[96,8,67,6],[96,12,67,12,"sendDefaultPii"],[96,26,67,26],[96,29,67,29,"Boolean"],[96,36,67,36],[96,37,67,37,"client"],[96,43,67,43],[96,45,67,45,"getOptions"],[96,55,67,55],[96,56,67,56],[96,57,67,57],[96,58,67,58,"sendDefaultPii"],[96,72,67,72],[96,73,67,73],[97,8,68,6],[97,12,68,12,"toolAttributes"],[97,26,68,26],[97,29,68,29],[97,33,68,29,"filterMcpPiiFromSpanData"],[97,48,68,53],[97,49,68,53,"filterMcpPiiFromSpanData"],[97,73,68,53],[97,75,68,54,"rawToolAttributes"],[97,92,68,71],[97,94,68,73,"sendDefaultPii"],[97,108,68,87],[97,109,68,88],[98,8,70,6,"span"],[98,12,70,10],[98,13,70,11,"setAttributes"],[98,26,70,24],[98,27,70,25,"toolAttributes"],[98,41,70,39],[98,42,70,40],[99,6,71,4],[99,7,71,5],[99,13,71,11],[99,17,71,15,"method"],[99,23,71,21],[99,28,71,26],[99,41,71,39],[99,43,71,41],[100,8,72,6],[100,12,72,12,"rawPromptAttributes"],[100,31,72,31],[100,34,72,34],[100,38,72,34,"extractPromptResultAttributes"],[100,57,72,63],[100,58,72,63,"extractPromptResultAttributes"],[100,87,72,63],[100,89,72,64,"result"],[100,95,72,70],[100,96,72,71],[101,8,73,6],[101,12,73,12,"client"],[101,19,73,18],[101,22,73,21],[101,26,73,21,"getClient"],[101,42,73,30],[101,43,73,30,"getClient"],[101,52,73,30],[101,54,73,31],[101,55,73,32],[102,8,74,6],[102,12,74,12,"sendDefaultPii"],[102,27,74,26],[102,30,74,29,"Boolean"],[102,37,74,36],[102,38,74,37,"client"],[102,45,74,43],[102,47,74,45,"getOptions"],[102,57,74,55],[102,58,74,56],[102,59,74,57],[102,60,74,58,"sendDefaultPii"],[102,74,74,72],[102,75,74,73],[103,8,75,6],[103,12,75,12,"promptAttributes"],[103,28,75,28],[103,31,75,31],[103,35,75,31,"filterMcpPiiFromSpanData"],[103,50,75,55],[103,51,75,55,"filterMcpPiiFromSpanData"],[103,75,75,55],[103,77,75,56,"rawPromptAttributes"],[103,96,75,75],[103,98,75,77,"sendDefaultPii"],[103,113,75,91],[103,114,75,92],[104,8,77,6,"span"],[104,12,77,10],[104,13,77,11,"setAttributes"],[104,26,77,24],[104,27,77,25,"promptAttributes"],[104,43,77,41],[104,44,77,42],[105,6,78,4],[106,6,80,4,"span"],[106,10,80,8],[106,11,80,9,"end"],[106,14,80,12],[106,15,80,13],[106,16,80,14],[107,6,81,4,"spanMap"],[107,13,81,11],[107,14,81,12,"delete"],[107,20,81,18],[107,21,81,19,"requestId"],[107,30,81,28],[107,31,81,29],[108,4,82,2],[109,2,83,0],[111,2,85,0],[112,0,86,0],[113,0,87,0],[114,0,88,0],[115,2,89,0],[115,11,89,9,"cleanupPendingSpansForTransport"],[115,42,89,40,"cleanupPendingSpansForTransport"],[115,43,89,41,"transport"],[115,52,89,50],[115,54,89,52],[116,4,90,2],[116,8,90,8,"spanMap"],[116,15,90,15],[116,18,90,18,"transportToSpanMap"],[116,36,90,36],[116,37,90,37,"get"],[116,40,90,40],[116,41,90,41,"transport"],[116,50,90,50],[116,51,90,51],[117,4,91,2],[117,8,91,6,"spanMap"],[117,15,91,13],[117,17,91,15],[118,6,92,4],[118,15,92,4,"_ref"],[118,19,92,4],[118,23,92,31,"spanMap"],[118,30,92,38],[118,32,92,40],[119,8,92,40],[119,12,92,40,"_ref2"],[119,17,92,40],[119,24,92,40,"_slicedToArray"],[119,38,92,40],[119,39,92,40,"default"],[119,46,92,40],[119,48,92,40,"_ref"],[119,52,92,40],[120,8,92,40],[120,12,92,18,"spanData"],[120,20,92,26],[120,23,92,26,"_ref2"],[120,28,92,26],[121,8,93,6,"spanData"],[121,16,93,14],[121,17,93,15,"span"],[121,21,93,19],[121,22,93,20,"setStatus"],[121,31,93,29],[121,32,93,30],[122,10,94,8,"code"],[122,14,94,12],[122,16,94,14,"SPAN_STATUS_ERROR"],[122,36,94,31],[122,37,94,31,"SPAN_STATUS_ERROR"],[122,54,94,31],[123,10,95,8,"message"],[123,17,95,15],[123,19,95,17],[124,8,96,6],[124,9,96,7],[124,10,96,8],[125,8,97,6,"spanData"],[125,16,97,14],[125,17,97,15,"span"],[125,21,97,19],[125,22,97,20,"end"],[125,25,97,23],[125,26,97,24],[125,27,97,25],[126,6,98,4],[127,6,99,4,"spanMap"],[127,13,99,11],[127,14,99,12,"clear"],[127,19,99,17],[127,20,99,18],[127,21,99,19],[128,4,100,2],[129,2,101,0],[130,0,101,1],[130,3]],"functionMap":{"names":["<global>","getOrCreateSpanMap","storeSpanForRequest","completeSpanWithResults","cleanupPendingSpansForTransport"],"mappings":"AAA;AC0B;CDO;AES;CFO;AGQ;CHyB;AIM;CJY"},"hasCjsExports":false},"type":"js/module"}]}